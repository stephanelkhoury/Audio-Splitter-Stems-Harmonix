{% extends "base.html" %}

{% block title %}My Account – Harmonix{% endblock %}
{% block description %}Manage your Harmonix account settings, subscription, and preferences.{% endblock %}

{% block extra_styles %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    .text-muted { color: var(--text-muted); }
    
    /* Image Cropper Modal */
    .cropper-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }
    .cropper-modal-overlay.active {
        display: flex;
    }
    .cropper-modal {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 0;
        max-width: 480px;
        width: 100%;
        max-height: calc(100vh - 40px);
        overflow: hidden;
        border: 1px solid rgba(124, 58, 237, 0.3);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
        animation: modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    .cropper-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(236, 72, 153, 0.1));
        border-bottom: 1px solid var(--border);
    }
    .cropper-modal-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
    }
    .cropper-modal-close {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: var(--text-muted);
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .cropper-modal-close:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    .cropper-modal-body {
        padding: 24px;
    }
    .cropper-tip {
        text-align: center;
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 16px;
        padding: 10px 16px;
        background: rgba(124, 58, 237, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(124, 58, 237, 0.2);
    }
    .cropper-tip i {
        color: var(--primary);
        margin-right: 6px;
    }
    .cropper-container-wrapper {
        width: 100%;
        height: 300px;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16162a 100%);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed rgba(124, 58, 237, 0.3);
    }
    .cropper-container-wrapper img {
        max-width: 100%;
        max-height: 100%;
        display: block;
    }
    /* Cropper.js custom styling */
    .cropper-view-box,
    .cropper-face {
        border-radius: 50%;
    }
    .cropper-view-box {
        box-shadow: 0 0 0 1px #7c3aed, 0 0 0 3px rgba(124, 58, 237, 0.3);
        outline: none;
    }
    .cropper-line {
        background-color: #7c3aed;
    }
    .cropper-point {
        background-color: #7c3aed;
        width: 10px !important;
        height: 10px !important;
        border-radius: 50%;
    }
    .cropper-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        padding: 0 24px 24px;
    }
    .cropper-modal-actions .btn {
        padding: 12px 32px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .cropper-modal-actions .btn-cancel {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--text);
        flex: 1;
    }
    .cropper-modal-actions .btn-cancel:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--text-muted);
    }
    .cropper-modal-actions .btn-save {
        background: linear-gradient(135deg, var(--primary), #6d28d9);
        border: none;
        color: white;
        flex: 1;
    }
    .cropper-modal-actions .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
    }
    .cropper-modal-actions .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    .cropper-tip {
        text-align: center;
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 16px;
    }
    
    /* Page Hero Section */
    .page-hero {
        text-align: center;
        padding: 80px 20px 60px;
        margin-top: 70px;
    }
    .page-hero h1 {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #fff 0%, #a78bfa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .page-hero p {
        font-size: 18px;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto;
    }
    [data-theme="light"] .page-hero h1 {
        background: linear-gradient(135deg, #1e293b 0%, #7c3aed 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* Form Controls for Account Page */
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text);
    }
    .form-control {
        width: 100%;
        padding: 14px 16px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 15px;
        font-family: inherit;
        color: var(--text);
        transition: all 0.3s;
    }
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15);
        background: var(--bg-card);
    }
    .form-control::placeholder {
        color: var(--text-dim);
    }
    [data-theme="light"] .form-control {
        background: #fff;
        border-color: rgba(0, 0, 0, 0.15);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    [data-theme="light"] .form-control:focus {
        background: #fff;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
        line-height: 1.6;
    }
    
    .account-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 40px;
        padding: 40px 0 80px;
        min-height: 70vh;
    }
    .account-sidebar {
        position: sticky;
        top: 100px;
        height: fit-content;
    }
    .account-nav {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 15px;
    }
    .account-nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        color: var(--text-muted);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s;
        font-size: 14px;
    }
    .account-nav a:hover,
    .account-nav a.active {
        background: rgba(124, 58, 237, 0.15);
        color: var(--primary-light);
    }
    .account-nav a i {
        width: 20px;
        text-align: center;
    }
    .account-content {
        max-width: 700px;
    }
    .account-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 25px;
    }
    .account-section h2 {
        font-size: 18px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
    }
    .profile-header {
        display: flex;
        align-items: center;
        gap: 25px;
        margin-bottom: 30px;
    }
    .profile-avatar {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        position: relative;
    }
    .avatar-upload {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 32px;
        height: 32px;
        background: var(--bg-card);
        border: 2px solid var(--border);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
    }
    .avatar-upload:hover {
        background: var(--primary);
        border-color: var(--primary);
    }
    .profile-info h3 {
        font-size: 22px;
        margin-bottom: 5px;
    }
    .profile-info p {
        color: var(--text-muted);
        font-size: 14px;
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .plan-card {
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(236, 72, 153, 0.15));
        border: 1px solid rgba(124, 58, 237, 0.3);
        border-radius: 12px;
        padding: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .plan-info h3 {
        font-size: 18px;
        margin-bottom: 5px;
    }
    .plan-info p {
        color: var(--text-muted);
        font-size: 14px;
    }
    .plan-badge {
        background: var(--primary);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 10px;
    }
    .usage-bar {
        height: 8px;
        background: var(--bg-darker);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 15px;
    }
    .usage-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 4px;
        transition: width 0.3s;
    }
    .usage-text {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 8px;
    }
    .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--border);
    }
    .settings-item:last-child {
        border-bottom: none;
    }
    .settings-item-info h4 {
        font-size: 14px;
        margin-bottom: 3px;
    }
    .settings-item-info p {
        color: var(--text-muted);
        font-size: 13px;
    }
    .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
        background: var(--bg-darker);
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s;
    }
    .toggle-switch.active {
        background: var(--primary);
    }
    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform 0.3s;
    }
    .toggle-switch.active::after {
        transform: translateX(22px);
    }
    .danger-zone {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
    }
    .danger-zone h2 {
        color: #ef4444;
    }
    .btn-danger {
        background: #ef4444;
        border-color: #ef4444;
    }
    .btn-danger:hover {
        background: #dc2626;
    }
    .history-list {
        margin-top: 20px;
    }
    .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: var(--bg-darker);
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .history-item-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .history-icon {
        width: 40px;
        height: 40px;
        background: rgba(124, 58, 237, 0.15);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-light);
    }
    .history-item-info h4 {
        font-size: 14px;
        margin-bottom: 2px;
    }
    .history-item-info p {
        color: var(--text-muted);
        font-size: 12px;
    }
    
    @media (max-width: 900px) {
        .account-layout {
            grid-template-columns: 1fr;
        }
        .account-sidebar {
            position: static;
        }
        .form-row {
            grid-template-columns: 1fr;
        }
        .plan-card {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-hero">
    <h1>Account Settings</h1>
    <p>Manage your profile, subscription, and preferences</p>
</div>

<div class="container">
    <div class="account-layout">
        <div class="account-sidebar">
            <nav class="account-nav">
                <a href="#profile" class="active"><i class="fas fa-user"></i> Profile</a>
                <a href="#subscription"><i class="fas fa-crown"></i> Subscription</a>
                <a href="#usage"><i class="fas fa-chart-bar"></i> Usage</a>
                <a href="#notifications"><i class="fas fa-bell"></i> Notifications</a>
                <a href="#security"><i class="fas fa-shield-alt"></i> Security</a>
                <a href="#api"><i class="fas fa-code"></i> API Keys</a>
                <a href="#history"><i class="fas fa-history"></i> History</a>
            </nav>
        </div>
        
        <div class="account-content">
            <div class="account-section" id="profile">
                <h2><i class="fas fa-user"></i> Profile Information</h2>
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">
                        {% if current_user and current_user.avatar %}
                        <img src="{{ current_user.avatar }}" alt="Profile" id="avatarImage" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        {% else %}
                        <i class="fas fa-user" id="avatarIcon"></i>
                        {% endif %}
                        <label class="avatar-upload">
                            <i class="fas fa-camera"></i>
                            <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" hidden>
                        </label>
                    </div>
                    <div class="profile-info">
                        <h3>{{ current_user.name if current_user else 'Guest User' }}</h3>
                        <p>{{ current_user.email if current_user else 'Not logged in' }}</p>
                    </div>
                </div>
                <div id="avatarMessage" style="display: none; padding: 10px; border-radius: 8px; margin-bottom: 15px;"></div>
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" value="{{ current_user.name.split()[0] if current_user and current_user.name else '' }}">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" value="{{ current_user.name.split()[-1] if current_user and current_user.name and ' ' in current_user.name else '' }}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ current_user.email if current_user else '' }}">
                    </div>
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea class="form-control" id="bio" name="bio" rows="4" placeholder="Tell us about yourself...">{{ current_user.bio if current_user and current_user.bio else '' }}</textarea>
                    </div>
                    <div id="profileMessage" style="display: none; padding: 10px; border-radius: 8px; margin-bottom: 15px;"></div>
                    <button type="submit" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
                </form>
            </div>
            
            <div class="account-section" id="subscription">
                <h2><i class="fas fa-crown"></i> Subscription</h2>
                <div class="plan-card">
                    <div class="plan-info">
                        <h3>{{ user_stats.plan_name if user_stats else 'Free' }} Plan <span class="plan-badge">Current</span></h3>
                        <p>{{ user_stats.songs_limit if user_stats.songs_limit != 'unlimited' else 'Unlimited' }} songs/month · {{ user_stats.stems_available if user_stats else 4 }}-stem separation</p>
                    </div>
                    {% if not user_stats or user_stats.plan == 'free' %}
                    <a href="/#pricing" class="btn btn-primary">Upgrade Plan</a>
                    {% elif user_stats.plan == 'creator' %}
                    <a href="/#pricing" class="btn btn-outline">Upgrade to Studio</a>
                    {% else %}
                    <span class="plan-badge" style="background: var(--success);">Max Plan</span>
                    {% endif %}
                </div>
                
                <!-- Plan Features -->
                <div style="margin-top: 25px; padding: 20px; background: var(--bg-darker); border-radius: 12px;">
                    <h4 style="font-size: 14px; margin-bottom: 15px; color: var(--text-muted);">Your Plan Features</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check" style="color: var(--success); font-size: 12px;"></i>
                            <span style="font-size: 13px;">{{ user_stats.songs_limit if user_stats.songs_limit != 'unlimited' else 'Unlimited' }} songs/month</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check" style="color: var(--success); font-size: 12px;"></i>
                            <span style="font-size: 13px;">{{ user_stats.stems_available if user_stats else 4 }}-stem separation</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            {% if user_stats and user_stats.has_api_access %}
                            <i class="fas fa-check" style="color: var(--success); font-size: 12px;"></i>
                            {% else %}
                            <i class="fas fa-times" style="color: var(--text-muted); font-size: 12px;"></i>
                            {% endif %}
                            <span style="font-size: 13px;" class="{% if not user_stats or not user_stats.has_api_access %}text-muted{% endif %}">API Access</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            {% if user_stats and user_stats.has_commercial_license %}
                            <i class="fas fa-check" style="color: var(--success); font-size: 12px;"></i>
                            {% else %}
                            <i class="fas fa-times" style="color: var(--text-muted); font-size: 12px;"></i>
                            {% endif %}
                            <span style="font-size: 13px;" class="{% if not user_stats or not user_stats.has_commercial_license %}text-muted{% endif %}">Commercial License</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                        <span style="font-size: 13px; color: var(--text-muted);">Export Formats: </span>
                        {% for format in (user_stats.export_formats if user_stats else ['mp3']) %}
                        <span class="plan-badge" style="background: rgba(124, 58, 237, 0.3); font-size: 11px; margin-left: 5px;">{{ format|upper }}</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    {% if user_stats and user_stats.plan != 'free' %}
                    <p style="color: var(--text-muted); font-size: 14px;">Member since: {{ user_stats.member_since[:10] if user_stats.member_since else 'N/A' }}</p>
                    <p style="margin-top: 10px;">
                        <a href="#" style="color: var(--primary-light); font-size: 14px;">View billing history</a> · 
                        <a href="#" style="color: var(--text-muted); font-size: 14px;">Cancel subscription</a>
                    </p>
                    {% endif %}
                </div>
            </div>
            
            <div class="account-section" id="usage">
                <h2><i class="fas fa-chart-bar"></i> Usage This Month</h2>
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                        <span style="font-size: 14px;">Songs Processed</span>
                        <span style="font-size: 24px; font-weight: 700; color: var(--primary-light);">
                            {{ user_stats.songs_this_month if user_stats else 0 }}
                            {% if user_stats.songs_limit != 'unlimited' %}
                            <span style="font-size: 14px; color: var(--text-muted);">/ {{ user_stats.songs_limit }}</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if user_stats.songs_limit != 'unlimited' %}
                    <div class="usage-bar">
                        {% set usage_percent = ((user_stats.songs_this_month / user_stats.songs_limit) * 100) if user_stats and user_stats.songs_limit else 0 %}
                        <div class="usage-fill" style="width: {{ [usage_percent, 100]|min }}%;"></div>
                    </div>
                    <div class="usage-text">
                        <span>{{ user_stats.songs_remaining if user_stats else 0 }} songs remaining</span>
                        <span>Resets on the 1st</span>
                    </div>
                    {% else %}
                    <div style="margin-top: 10px; color: var(--success); font-size: 14px;">
                        <i class="fas fa-infinity"></i> Unlimited processing available
                    </div>
                    {% endif %}
                </div>
                
                <!-- Stem Types Available -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 14px; margin-bottom: 15px;">Available Stem Types</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        {% for stem in (user_stats.stem_types if user_stats else ['vocals', 'drums', 'bass', 'other']) %}
                        <div style="background: rgba(124, 58, 237, 0.15); padding: 8px 16px; border-radius: 20px; font-size: 13px;">
                            <i class="fas fa-{% if stem == 'vocals' %}microphone{% elif stem == 'drums' %}drum{% elif stem == 'bass' %}guitar{% elif stem == 'guitar' %}guitar{% elif stem == 'piano' %}music{% else %}layer-group{% endif %}"></i>
                            {{ stem|capitalize }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Lifetime Stats -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 14px; margin-bottom: 15px;">Lifetime Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: var(--bg-darker); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary-light);">{{ user_stats.total_songs_processed if user_stats else 0 }}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Songs Processed</div>
                        </div>
                        <div style="background: var(--bg-darker); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--secondary);">{{ user_stats.total_stems_downloaded if user_stats else 0 }}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Stems Downloaded</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="account-section" id="notifications">
                <h2><i class="fas fa-bell"></i> Notification Preferences</h2>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4>Email Notifications</h4>
                        <p>Receive emails about your processing jobs</p>
                    </div>
                    <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4>Product Updates</h4>
                        <p>News about new features and improvements</p>
                    </div>
                    <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4>Marketing Emails</h4>
                        <p>Promotional offers and tips</p>
                    </div>
                    <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
                </div>
            </div>
            
            <div class="account-section" id="security">
                <h2><i class="fas fa-shield-alt"></i> Security</h2>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4>Change Password</h4>
                        <p>Update your account password</p>
                    </div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="openPasswordModal()">Change</button>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4>Two-Factor Authentication</h4>
                        <p>Add an extra layer of security</p>
                    </div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="open2FAModal()">Enable</button>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4>Active Sessions</h4>
                        <p>Manage devices logged into your account</p>
                    </div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="openSessionsModal()">View</button>
                </div>
            </div>
            
            <div class="account-section" id="api">
                <h2><i class="fas fa-code"></i> API Keys</h2>
                {% if user_stats and user_stats.has_api_access %}
                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">Use API keys to integrate Harmonix into your applications.</p>
                <div class="form-group">
                    <label>Your API Key</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" class="form-control" value="hx_sk_live_{{ current_user.username[:8] if current_user else 'xxxxx' }}xxxxxxxxxxxxx" readonly id="apiKey">
                        <button class="btn btn-outline" onclick="copyApiKey()">Copy</button>
                        <button class="btn btn-outline" onclick="toggleApiKey()"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: 13px;"><i class="fas fa-info-circle"></i> Keep your API key secret. Don't share it publicly.</p>
                <div style="margin-top: 20px;">
                    <a href="/docs#api" class="btn btn-outline btn-sm">View API Documentation</a>
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="width: 60px; height: 60px; background: rgba(124, 58, 237, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fas fa-lock" style="font-size: 24px; color: var(--text-muted);"></i>
                    </div>
                    <h4 style="margin-bottom: 10px;">API Access Not Available</h4>
                    <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">API access is available on the Studio plan. Upgrade to integrate Harmonix with your applications.</p>
                    <a href="/#pricing" class="btn btn-primary">Upgrade to Studio</a>
                </div>
                {% endif %}
            </div>
            
            <div class="account-section" id="history">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>
                <div class="history-list">
                    <div class="history-item">
                        <div class="history-item-info">
                            <div class="history-icon"><i class="fas fa-music"></i></div>
                            <div>
                                <h4>Song Processed</h4>
                                <p>Summer_Vibes.mp3 - 4 stems</p>
                            </div>
                        </div>
                        <span style="color: var(--text-muted); font-size: 13px;">2 hours ago</span>
                    </div>
                    <div class="history-item">
                        <div class="history-item-info">
                            <div class="history-icon"><i class="fas fa-download"></i></div>
                            <div>
                                <h4>Stems Downloaded</h4>
                                <p>vocals.wav exported</p>
                            </div>
                        </div>
                        <span style="color: var(--text-muted); font-size: 13px;">3 hours ago</span>
                    </div>
                    <div class="history-item">
                        <div class="history-item-info">
                            <div class="history-icon"><i class="fas fa-sign-in-alt"></i></div>
                            <div>
                                <h4>Login</h4>
                                <p>Chrome on macOS</p>
                            </div>
                        </div>
                        <span style="color: var(--text-muted); font-size: 13px;">1 day ago</span>
                    </div>
                </div>
            </div>
            
            <div class="account-section danger-zone">
                <h2><i class="fas fa-exclamation-triangle"></i> Danger Zone</h2>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4>Delete Account</h4>
                        <p>Permanently delete your account and all data</p>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="openDeleteModal()">Delete Account</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div id="passwordModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Change Password</h3>
            <button type="button" class="modal-close" onclick="closePasswordModal()">&times;</button>
        </div>
        <form id="passwordForm">
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
            </div>
            <div id="passwordMessage" style="display: none; padding: 10px; border-radius: 8px; margin-bottom: 15px;"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closePasswordModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
            </div>
        </form>
    </div>
</div>

<!-- Two-Factor Authentication Modal -->
<div id="twoFactorModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-shield-alt"></i> Two-Factor Authentication</h3>
            <button type="button" class="modal-close" onclick="close2FAModal()">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center; padding: 30px 20px;">
            <div style="width: 80px; height: 80px; background: rgba(124, 58, 237, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fas fa-mobile-alt" style="font-size: 32px; color: var(--primary-light);"></i>
            </div>
            <h4 style="margin-bottom: 10px;">Coming Soon</h4>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">Two-factor authentication will be available in a future update. This feature will allow you to add an extra layer of security to your account using an authenticator app.</p>
            <button type="button" class="btn btn-outline" onclick="close2FAModal()">Got it</button>
        </div>
    </div>
</div>

<!-- Active Sessions Modal -->
<div id="sessionsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
            <h3><i class="fas fa-laptop"></i> Active Sessions</h3>
            <button type="button" class="modal-close" onclick="closeSessionsModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div class="session-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-darker); border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 40px; height: 40px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-desktop" style="color: var(--success);"></i>
                    </div>
                    <div>
                        <h4 style="font-size: 14px; margin-bottom: 2px;">Current Session</h4>
                        <p style="color: var(--text-muted); font-size: 12px;">This device · Active now</p>
                    </div>
                </div>
                <span class="plan-badge" style="background: var(--success);">Current</span>
            </div>
            <p style="color: var(--text-muted); font-size: 13px; margin-top: 15px;"><i class="fas fa-info-circle"></i> Session management for multiple devices coming soon.</p>
        </div>
        <div class="modal-actions" style="padding: 15px 20px; border-top: 1px solid var(--border);">
            <button type="button" class="btn btn-outline" onclick="closeSessionsModal()">Close</button>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header" style="background: rgba(239, 68, 68, 0.1);">
            <h3 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Delete Account</h3>
            <button type="button" class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <p style="margin-bottom: 15px;"><strong>Warning:</strong> This action cannot be undone. All your data, including:</p>
            <ul style="color: var(--text-muted); font-size: 14px; margin-left: 20px; margin-bottom: 20px;">
                <li>Your profile information</li>
                <li>Processing history</li>
                <li>Downloaded stems</li>
                <li>API keys</li>
            </ul>
            <p style="margin-bottom: 20px;">will be permanently deleted.</p>
            <form id="deleteForm">
                <div class="form-group">
                    <label>Enter your password to confirm</label>
                    <input type="password" class="form-control" id="deletePassword" name="deletePassword" required placeholder="Your password">
                </div>
                <div id="deleteMessage" style="display: none; padding: 10px; border-radius: 8px; margin-bottom: 15px;"></div>
            </form>
        </div>
        <div class="modal-actions" style="padding: 15px 20px; border-top: 1px solid var(--border);">
            <button type="button" class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteAccount()">Delete My Account</button>
        </div>
    </div>
</div>

<style>
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        width: 90%;
        max-width: 450px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border);
    }
    .modal-header h3 {
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    .modal-close:hover {
        color: var(--text);
    }
    .modal-content form {
        padding: 20px;
    }
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 0 20px 20px;
    }
    .message-success {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .message-error {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .message-info {
        background: rgba(124, 58, 237, 0.15);
        color: var(--primary);
        border: 1px solid rgba(124, 58, 237, 0.3);
    }
</style>

<!-- Image Cropper Modal -->
<div id="cropperModal" class="cropper-modal-overlay">
    <div class="cropper-modal">
        <div class="cropper-modal-header">
            <h3><i class="fas fa-crop-alt"></i> Crop Your Avatar</h3>
            <button type="button" class="cropper-modal-close" onclick="closeCropperModal()">&times;</button>
        </div>
        <div class="cropper-modal-body">
            <p class="cropper-tip">
                <i class="fas fa-info-circle"></i> Drag to reposition, scroll to zoom. Your avatar will be cropped as a circle.
            </p>
            <div class="cropper-container-wrapper">
                <img id="cropperImage" src="" alt="Crop preview">
            </div>
        </div>
        <div class="cropper-modal-actions">
            <button type="button" class="btn btn-cancel" onclick="closeCropperModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" class="btn btn-save" id="saveCroppedAvatar" onclick="saveCroppedAvatar()">
                <i class="fas fa-check"></i> Save Avatar
            </button>
        </div>
    </div>
</div>

<!-- Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
    // Cropper instance
    let cropper = null;
    let selectedFile = null;
    
    // Avatar Upload - Open Cropper Modal
    document.getElementById('avatarInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const messageEl = document.getElementById('avatarMessage');
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> File size must be less than 5MB';
            setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
            e.target.value = '';
            return;
        }
        
        // Validate file type
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid file type. Allowed: PNG, JPG, GIF, WEBP';
            setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
            e.target.value = '';
            return;
        }
        
        selectedFile = file;
        
        // Load image into cropper modal
        const reader = new FileReader();
        reader.onload = function(event) {
            const cropperImage = document.getElementById('cropperImage');
            cropperImage.src = event.target.result;
            
            // Open modal
            document.getElementById('cropperModal').classList.add('active');
            
            // Initialize cropper after image loads
            cropperImage.onload = function() {
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(cropperImage, {
                    aspectRatio: 1, // Force 1:1 square
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    cropBoxResizable: true,
                    cropBoxMovable: true,
                    guides: true,
                    center: true,
                    highlight: true,
                    background: true,
                    responsive: true,
                    restore: false,
                    checkCrossOrigin: false,
                    minContainerWidth: 200,
                    minContainerHeight: 200,
                });
            };
        };
        reader.readAsDataURL(file);
    });
    
    // Close cropper modal
    function closeCropperModal() {
        document.getElementById('cropperModal').classList.remove('active');
        document.getElementById('avatarInput').value = '';
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        selectedFile = null;
    }
    
    // Save cropped avatar
    async function saveCroppedAvatar() {
        if (!cropper) return;
        
        const saveBtn = document.getElementById('saveCroppedAvatar');
        const messageEl = document.getElementById('avatarMessage');
        const avatarEl = document.getElementById('profileAvatar');
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            // Get cropped canvas at 256x256 for optimal avatar size
            const canvas = cropper.getCroppedCanvas({
                width: 256,
                height: 256,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });
            
            // Convert canvas to blob
            const blob = await new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });
            
            // Create form data with cropped image
            const formData = new FormData();
            formData.append('avatar', blob, 'avatar.jpg');
            
            const response = await fetch('/account/upload-avatar', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // Close modal
            closeCropperModal();
            
            messageEl.style.display = 'block';
            if (data.success) {
                messageEl.className = 'message-success';
                messageEl.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                
                // Update avatar display
                const existingImg = avatarEl.querySelector('#avatarImage');
                const existingIcon = avatarEl.querySelector('#avatarIcon');
                
                if (existingImg) {
                    existingImg.src = data.avatar_url + '?t=' + Date.now();
                } else {
                    if (existingIcon) existingIcon.remove();
                    const img = document.createElement('img');
                    img.id = 'avatarImage';
                    img.src = data.avatar_url + '?t=' + Date.now();
                    img.alt = 'Profile';
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 50%;';
                    avatarEl.insertBefore(img, avatarEl.firstChild);
                }
                
                // Also update navbar avatars if present
                document.querySelectorAll('.user-avatar').forEach(avatar => {
                    const existingNavImg = avatar.querySelector('img');
                    if (existingNavImg) {
                        existingNavImg.src = data.avatar_url + '?t=' + Date.now();
                    }
                });
            } else {
                messageEl.className = 'message-error';
                messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.error;
            }
        } catch (err) {
            closeCropperModal();
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to upload avatar. Please try again.';
        }
        
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Save Avatar';
        setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
    }
    
    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('cropperModal').classList.contains('active')) {
            closeCropperModal();
        }
    });
    
    // Close modal on overlay click
    document.getElementById('cropperModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCropperModal();
        }
    });
    
    // Profile Form Handling
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const bio = document.getElementById('bio').value.trim();
        const messageEl = document.getElementById('profileMessage');
        const btn = document.getElementById('saveProfileBtn');
        
        const name = [firstName, lastName].filter(Boolean).join(' ');
        
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        try {
            const response = await fetch('/account/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, bio })
            });
            
            const data = await response.json();
            
            messageEl.style.display = 'block';
            if (data.success) {
                messageEl.className = 'message-success';
                messageEl.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                // Update profile header
                document.querySelector('.profile-info h3').textContent = name || 'Guest User';
                document.querySelector('.profile-info p').textContent = email || 'Not logged in';
            } else {
                messageEl.className = 'message-error';
                messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.error;
            }
        } catch (err) {
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to save changes. Please try again.';
        }
        
        btn.disabled = false;
        btn.textContent = 'Save Changes';
        
        setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
    });
    
    // Password Modal Functions
    function openPasswordModal() {
        document.getElementById('passwordModal').style.display = 'flex';
        document.getElementById('passwordForm').reset();
        document.getElementById('passwordMessage').style.display = 'none';
    }
    
    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
    }
    
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageEl = document.getElementById('passwordMessage');
        const btn = document.getElementById('changePasswordBtn');
        
        if (newPassword !== confirmPassword) {
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> New passwords do not match';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Changing...';
        
        try {
            const response = await fetch('/account/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    current_password: currentPassword,
                    new_password: newPassword,
                    confirm_password: confirmPassword
                })
            });
            
            const data = await response.json();
            
            messageEl.style.display = 'block';
            if (data.success) {
                messageEl.className = 'message-success';
                messageEl.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                setTimeout(() => closePasswordModal(), 2000);
            } else {
                messageEl.className = 'message-error';
                messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.error;
            }
        } catch (err) {
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to change password. Please try again.';
        }
        
        btn.disabled = false;
        btn.textContent = 'Change Password';
    });
    
    // 2FA Modal Functions
    function open2FAModal() {
        document.getElementById('twoFactorModal').style.display = 'flex';
    }
    
    function close2FAModal() {
        document.getElementById('twoFactorModal').style.display = 'none';
    }
    
    // Sessions Modal Functions
    function openSessionsModal() {
        document.getElementById('sessionsModal').style.display = 'flex';
    }
    
    function closeSessionsModal() {
        document.getElementById('sessionsModal').style.display = 'none';
    }
    
    // Delete Account Modal Functions
    function openDeleteModal() {
        document.getElementById('deleteModal').style.display = 'flex';
        document.getElementById('deleteForm').reset();
        document.getElementById('deleteMessage').style.display = 'none';
    }
    
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }
    
    async function deleteAccount() {
        const password = document.getElementById('deletePassword').value;
        const messageEl = document.getElementById('deleteMessage');
        const btn = document.getElementById('confirmDeleteBtn');
        
        if (!password) {
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter your password';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Deleting...';
        
        try {
            const response = await fetch('/account/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            
            const data = await response.json();
            
            if (data.success) {
                messageEl.style.display = 'block';
                messageEl.className = 'message-success';
                messageEl.innerHTML = '<i class="fas fa-check-circle"></i> Account deleted. Redirecting...';
                setTimeout(() => { window.location.href = '/'; }, 2000);
            } else {
                messageEl.style.display = 'block';
                messageEl.className = 'message-error';
                messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.error;
            }
        } catch (err) {
            messageEl.style.display = 'block';
            messageEl.className = 'message-error';
            messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to delete account. Please try again.';
        }
        
        btn.disabled = false;
        btn.textContent = 'Delete My Account';
    }
    
    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
    
    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });
    
    // API Key functions
    function copyApiKey() {
        const apiKeyInput = document.getElementById('apiKey');
        const originalType = apiKeyInput.type;
        apiKeyInput.type = 'text';
        apiKeyInput.select();
        document.execCommand('copy');
        apiKeyInput.type = originalType;
        
        // Show feedback
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = originalText; }, 2000);
    }
    
    function toggleApiKey() {
        const apiKeyInput = document.getElementById('apiKey');
        const icon = event.target.querySelector('i') || event.target;
        
        if (apiKeyInput.type === 'password') {
            apiKeyInput.type = 'text';
            if (icon.classList) {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        } else {
            apiKeyInput.type = 'password';
            if (icon.classList) {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    }
</script>
{% endblock %}
