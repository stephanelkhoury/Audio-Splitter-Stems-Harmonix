<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonix Audio Splitter - Professional Dashboard</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- External Dependencies -->
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
    
    <!-- Modular Dashboard CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/upload.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/player.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/midi.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/modal.css') }}">
    
    <!-- Prevent theme flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('harmonix-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    
    <!-- DevTools Deterrent (Note: Cannot fully prevent, only deter casual users) -->
    <script>
        (function() {
            // Disable right-click context menu
            document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
            
            // Disable common keyboard shortcuts for DevTools
            document.addEventListener('keydown', function(e) {
                // F12
                if (e.key === 'F12') { e.preventDefault(); return false; }
                // Ctrl+Shift+I / Cmd+Option+I (DevTools)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'I') { e.preventDefault(); return false; }
                // Ctrl+Shift+J / Cmd+Option+J (Console)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'J') { e.preventDefault(); return false; }
                // Ctrl+Shift+C / Cmd+Option+C (Inspect Element)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') { e.preventDefault(); return false; }
                // Ctrl+U / Cmd+U (View Source)
                if ((e.ctrlKey || e.metaKey) && e.key === 'u') { e.preventDefault(); return false; }
                // Ctrl+S / Cmd+S (Save Page)
                if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); return false; }
            });
            
            // Detect DevTools open (unreliable but adds friction)
            var devtools = { open: false };
            setInterval(function() {
                var widthThreshold = window.outerWidth - window.innerWidth > 160;
                var heightThreshold = window.outerHeight - window.innerHeight > 160;
                if (widthThreshold || heightThreshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        console.clear();
                    }
                } else {
                    devtools.open = false;
                }
            }, 1000);
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #7c3aed;
            --primary-light: #a78bfa;
            --primary-dark: #6d28d9;
            --secondary: #06b6d4;
            --dark: #0a0a0f;
            --darker: #050508;
            --card: #12121a;
            --light: #f8f9fa;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.1);
            --text-muted: #a1a1aa;
            --text-dim: #71717a;
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --dark: #ffffff;
            --darker: #f1f5f9;
            --card: #ffffff;
            --border: rgba(0, 0, 0, 0.1);
            --text-muted: #475569;
            --text-dim: #64748b;
        }
        
        [data-theme="light"] body {
            background: #f1f5f9;
            color: #0f172a;
        }
        
        [data-theme="light"] .sidebar {
            background: #ffffff;
            border-right-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .nav-item {
            color: #475569;
        }
        
        [data-theme="light"] .nav-item:hover,
        [data-theme="light"] .nav-item.active {
            background: rgba(124, 58, 237, 0.1);
            color: #7c3aed;
        }
        
        [data-theme="light"] .main-content {
            background: #f1f5f9;
        }
        
        [data-theme="light"] .card,
        [data-theme="light"] .upload-area,
        [data-theme="light"] .stems-section,
        [data-theme="light"] .player-card,
        [data-theme="light"] .stats-card,
        [data-theme="light"] .section {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .page-title,
        [data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3, [data-theme="light"] h4 {
            color: #0f172a;
        }
        
        [data-theme="light"] .track-name,
        [data-theme="light"] .stem-name,
        [data-theme="light"] .stat-value {
            color: #0f172a;
        }
        
        [data-theme="light"] .track-card {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .track-card:hover {
            border-color: rgba(124, 58, 237, 0.3);
        }
        
        [data-theme="light"] .btn-secondary {
            background: #f1f5f9;
            color: #0f172a;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .dashboard-navbar {
            background: rgba(255, 255, 255, 0.95);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .dashboard-navbar .nav-link,
        [data-theme="light"] .dashboard-navbar .nav-dropdown-item {
            color: #475569;
        }
        
        [data-theme="light"] .dashboard-navbar .nav-link:hover,
        [data-theme="light"] .dashboard-navbar .nav-dropdown-item:hover {
            color: #0f172a;
        }
        
        [data-theme="light"] .dashboard-navbar .nav-dropdown-menu {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        [data-theme="light"] .dashboard-navbar .user-menu {
            color: #0f172a;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .dashboard-navbar .btn-ghost {
            color: #0f172a;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .theme-toggle {
            color: #475569;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .theme-toggle:hover {
            color: #0f172a;
            background: rgba(124, 58, 237, 0.1);
        }
        
        [data-theme="light"] .modal-content {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] input,
        [data-theme="light"] select,
        [data-theme="light"] textarea {
            background: #f8fafc;
            color: #0f172a;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .waveform-container {
            background: #f8fafc;
        }
        
        [data-theme="light"] .empty-state,
        [data-theme="light"] .lyrics-panel {
            background: #f8fafc;
        }
        
        /* Light mode - Global Timeline */
        [data-theme="light"] .global-timeline {
            background: rgba(241, 245, 249, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .timeline-bar {
            background: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .timeline-cursor {
            background: #0f172a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        [data-theme="light"] .time-display {
            background: rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="light"] .time-display .ms {
            color: #64748b;
        }
        
        [data-theme="light"] .stem-track {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .sync-indicator {
            border-color: rgba(0, 0, 0, 0.2);
        }
        
        [data-theme="light"] .drift-display {
            color: #64748b;
        }
        
        /* Timeline label */
        .timeline-label {
            font-size: 12px;
            color: #888;
        }
        
        [data-theme="light"] .timeline-label {
            color: #64748b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark);
            color: #fff;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 70px;
            width: 260px;
            height: calc(100vh - 70px);
            background: var(--darker);
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            border-right: 1px solid var(--border);
        }

        .logo {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 30px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-title {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            color: #aaa;
        }

        .nav-item:hover {
            background: rgba(124, 58, 237, 0.15);
            color: #fff;
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 25px;
            padding-top: 95px;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .page-title i {
            margin-right: 10px;
            color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(124, 58, 237, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--darker);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        /* Upload Area */
        .upload-area {
            background: var(--darker);
            border: 3px dashed rgba(124, 58, 237, 0.5);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.05);
        }

        .upload-icon {
            font-size: 50px;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .upload-area h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .upload-area p {
            color: #666;
            font-size: 14px;
        }

        /* Upload Tabs */
        .upload-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .upload-tab {
            flex: 1;
            padding: 15px 25px;
            background: var(--darker);
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: 12px;
            color: #aaa;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .upload-tab:hover {
            border-color: var(--primary);
            color: white;
        }

        .upload-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            color: white;
        }

        .upload-tab i {
            font-size: 18px;
        }

        .upload-tab-content {
            display: none;
        }

        .upload-tab-content.active {
            display: block;
        }

        /* URL Upload Area */
        .url-upload-area {
            background: var(--darker);
            border: 3px dashed rgba(124, 58, 237, 0.5);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
        }

        .url-input-container {
            display: flex;
            gap: 10px;
            max-width: 600px;
            margin: 25px auto 0;
        }

        .url-input {
            flex: 1;
            padding: 15px 20px !important;
            font-size: 15px !important;
        }

        .url-input::placeholder {
            color: #666;
        }

        .url-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--dark);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }

        .url-preview-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff0000, #cc0000);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .url-preview-info {
            flex: 1;
            min-width: 0;
        }

        .url-preview-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
        }

        .url-preview-source {
            font-size: 12px;
            color: #888;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #aaa;
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: var(--dark);
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        /* Track List */
        .track-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .track-item {
            background: var(--darker);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .track-item:hover {
            transform: translateX(5px);
            background: rgba(124, 58, 237, 0.1);
        }

        .track-artwork {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            position: relative;
        }

        .lyrics-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: #ffd700;
            color: #333;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--card);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            color: #666;
        }

        .search-box input {
            background: var(--card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px 15px 10px 40px;
            color: white;
            font-size: 14px;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .search-box input::placeholder {
            color: #666;
        }

        .track-actions {
            display: flex;
            gap: 8px;
        }

        .track-actions .icon-btn.edit-btn {
            background: rgba(52, 152, 219, 0.2);
        }

        .track-actions .icon-btn.edit-btn:hover {
            background: rgba(52, 152, 219, 0.4);
        }

        .track-actions .icon-btn.delete-btn {
            background: rgba(231, 76, 60, 0.2);
        }

        .track-actions .icon-btn.delete-btn:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        /* Edit Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            width: 400px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: white;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body input {
            width: 100%;
            background: var(--bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px 15px;
            color: white;
            font-size: 14px;
        }

        .modal-body input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-meta {
            color: #666;
            font-size: 13px;
        }

        .track-actions {
            display: flex;
            gap: 8px;
        }

        /* Icon Button */
        .icon-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }
        
        /* MIDI Conversion Button */
        .convert-midi-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
            color: white !important;
        }
        .convert-midi-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
        }
        .convert-midi-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #888;
        }

        /* Progress */
        .progress-container {
            background: var(--darker);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }

        .progress-bar {
            height: 10px;
            background: var(--dark);
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #888;
        }

        /* Player Container */
        .player-container {
            background: var(--darker);
            border-radius: 20px;
            padding: 30px;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .now-playing {
            font-size: 20px;
            font-weight: 600;
        }

        .now-playing i {
            color: var(--primary);
            margin-right: 10px;
        }

        /* Master Controls */
        .master-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 25px;
            background: var(--dark);
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 25px rgba(124, 58, 237, 0.5);
        }

        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #888;
            min-width: 180px;
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .time-display .current {
            color: var(--primary);
            font-weight: bold;
        }

        .time-display .ms {
            font-size: 11px;
            color: #666;
        }

        /* Global Timeline */
        .global-timeline {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .timeline-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            margin-top: 10px;
        }

        .timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .timeline-cursor {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            cursor: grab;
        }

        /* Stem Tracks */
        .stems-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stem-track {
            background: var(--dark);
            border-radius: 12px;
            padding: 15px 20px;
        }

        .stem-track.muted {
            opacity: 0.5;
        }

        .stem-track.solo {
            border: 2px solid var(--warning);
        }

        .stem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stem-name {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .stem-time {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            margin-left: 10px;
            min-width: 90px;
        }

        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            background: var(--success);
            transition: background 0.2s;
        }

        .sync-indicator.warning {
            background: var(--warning);
        }

        .sync-indicator.error {
            background: var(--danger);
        }

        .drift-display {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #888;
            margin-left: 5px;
        }

        .stem-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Mute/Solo Buttons */
        .mute-btn, .solo-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .mute-btn:hover, .solo-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .mute-btn.active {
            background: var(--danger);
            color: white;
        }

        .solo-btn.active {
            background: var(--warning);
            color: black;
        }

        .volume-slider {
            width: 100px;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .waveform-container {
            height: 70px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--darker);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* Music Info Panel */
        .music-info-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .music-info-card {
            background: var(--dark);
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 140px;
        }

        .music-info-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .music-info-icon.tempo {
            background: rgba(231, 76, 60, 0.2);
            color: #ef4444;
        }

        .music-info-icon.key {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .music-info-icon.time {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .music-info-value {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
        }

        .music-info-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .music-info-confidence {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }

        /* Estimated Time Banner */
        .estimate-banner {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(6, 182, 212, 0.15));
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 20px;
            display: none;
        }

        .estimate-banner.show {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .estimate-banner i {
            font-size: 24px;
            color: var(--primary);
        }

        .estimate-content {
            flex: 1;
        }

        .estimate-time {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .estimate-note {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--darker);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            display: none;
            z-index: 9999;
            border-left: 4px solid var(--primary);
        }

        .toast.show {
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.success {
            border-left-color: var(--success);
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Selected File Preview */
        .selected-file {
            background: var(--darker);
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .selected-file .file-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .selected-file .file-info {
            flex: 1;
        }

        .selected-file .file-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .selected-file .file-size {
            color: #666;
            font-size: 13px;
        }

        /* Pitch Control */
        .pitch-control {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--dark);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .pitch-control label {
            font-weight: 600;
            color: #aaa;
            white-space: nowrap;
        }

        .pitch-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            cursor: pointer;
        }

        .pitch-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.5);
        }

        .pitch-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .pitch-reset {
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pitch-reset:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Lyrics Panel */
        .lyrics-panel {
            background: var(--dark);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .lyrics-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lyrics-controls {
            display: flex;
            gap: 10px;
        }

        .lyrics-line {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 15px;
            line-height: 1.6;
        }

        .lyrics-line.current {
            background: rgba(124, 58, 237, 0.3);
            color: white;
            font-weight: 600;
        }

        .lyrics-line.past {
            color: #666;
        }

        .lyrics-line .word {
            display: inline;
            transition: color 0.1s;
        }

        .lyrics-line .word.highlight {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        .extract-lyrics-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .extract-lyrics-btn:hover {
            box-shadow: 0 5px 20px rgba(155, 89, 182, 0.4);
        }

        /* Language Select */
        .language-select {
            padding: 8px 12px;
            background: var(--dark);
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }

        .language-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Karaoke Mode Toggle */
        .mode-toggle {
            display: flex;
            background: var(--dark);
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
        }

        .mode-toggle-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #888;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-toggle-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .mode-toggle-btn:hover:not(.active) {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            background: var(--darker);
            border: 1px solid rgba(124, 58, 237, 0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Responsive - Tablet */
        @media (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }
            .main-content {
                margin-left: 220px;
                padding: 20px;
            }
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .music-info-panel {
                flex-direction: column;
            }
            .master-controls {
                flex-wrap: wrap;
                gap: 15px;
            }
            .stem-controls {
                flex-wrap: wrap;
                gap: 8px;
            }
            .volume-slider {
                width: 80px;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 70px 15px 20px;
            }
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .page-title {
                font-size: 20px;
            }
            .header-controls {
                width: 100%;
                flex-direction: column;
            }
            .search-box {
                width: 100%;
            }
            .search-box input {
                width: 100%;
            }
            .upload-tabs {
                flex-direction: column;
            }
            .upload-tab {
                padding: 12px 20px;
            }
            .upload-area {
                padding: 40px 20px;
            }
            .upload-icon {
                font-size: 40px;
            }
            .url-input-container {
                flex-direction: column;
            }
            .url-input {
                width: 100%;
            }
            .url-preview {
                flex-direction: column;
                text-align: center;
            }
            .track-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px;
            }
            .track-artwork {
                width: 50px;
                height: 50px;
            }
            .track-info {
                width: 100%;
            }
            .track-actions {
                width: 100%;
                justify-content: flex-end;
            }
            .player-container {
                padding: 15px 12px;
                border-radius: 12px;
            }
            .player-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                margin-bottom: 15px;
            }
            .player-header .btn {
                width: 100%;
                justify-content: center;
            }
            .now-playing {
                font-size: 15px;
                text-align: center;
            }
            .music-info-panel {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 8px;
                margin-bottom: 15px;
            }
            .music-info-card {
                flex-direction: column;
                text-align: center;
                padding: 10px 8px;
                gap: 8px;
                min-width: unset;
            }
            .music-info-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            .music-info-value {
                font-size: 14px;
            }
            .music-info-label {
                font-size: 9px;
            }
            .global-timeline {
                padding: 12px;
                margin-bottom: 15px;
            }
            .global-timeline > div:first-child {
                flex-direction: column;
                gap: 8px;
            }
            .time-display {
                width: 100%;
                font-size: 13px;
                min-width: unset;
                padding: 6px 10px;
            }
            .timeline-bar {
                height: 12px;
                margin-top: 8px;
            }
            .timeline-cursor {
                width: 20px;
                height: 20px;
                top: -4px;
            }
            .master-controls {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                padding: 15px 10px;
                margin-bottom: 15px;
            }
            .master-controls .icon-btn {
                width: 100%;
                height: 40px;
            }
            .master-controls > div {
                display: none;
            }
            .play-btn {
                width: 50px;
                height: 50px;
                font-size: 18px;
                grid-column: 3;
                justify-self: center;
            }
            .pitch-control {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
                align-items: stretch;
            }
            .pitch-control label {
                text-align: center;
                font-size: 13px;
            }
            .pitch-control > span.pitch-value:first-of-type,
            .pitch-control > span.pitch-value:nth-of-type(2) {
                display: none;
            }
            .pitch-slider {
                width: 100%;
                height: 10px;
            }
            .pitch-value {
                text-align: center;
            }
            .pitch-reset {
                width: 100%;
                padding: 10px;
            }
            /* Lyrics buttons */
            #stems-tab-player .btn.extract-lyrics-btn,
            #stems-tab-player .btn-secondary {
                flex: 1;
                padding: 10px 12px;
                font-size: 12px;
            }
            #stems-tab-player > div > div:nth-child(7) {
                flex-wrap: wrap;
            }
            .language-select {
                flex: 1;
                min-width: 100px;
            }
            .lyrics-panel {
                padding: 12px;
                max-height: 200px;
            }
            .lyrics-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
                padding-bottom: 8px;
            }
            .lyrics-title {
                font-size: 14px;
            }
            .lyrics-line {
                font-size: 13px;
                padding: 6px 8px;
            }
            .stem-track {
                padding: 10px 12px;
                border-radius: 10px;
            }
            .stem-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .stem-name {
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }
            .stem-name > span:first-of-type {
                order: -1;
                width: 100%;
                font-size: 13px;
                margin-bottom: 5px;
            }
            .stem-time {
                font-size: 10px;
                margin-left: auto;
            }
            .mute-btn, .solo-btn {
                width: 32px;
                height: 32px;
                font-size: 11px;
            }
            .stem-controls {
                display: flex;
                align-items: center;
                gap: 8px;
                width: 100%;
            }
            .stem-controls i {
                display: none;
            }
            .volume-slider {
                flex: 1;
                height: 8px;
            }
            .stem-controls .icon-btn {
                width: 34px;
                height: 34px;
            }
            .waveform-container {
                height: 45px;
                margin-top: 8px;
            }
            .stems-container {
                gap: 10px;
            }
            /* Other mobile styles */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .stat-card {
                padding: 20px 15px;
            }
            .stat-value {
                font-size: 28px;
            }
            .modal-content {
                margin: 15px;
                width: calc(100% - 30px);
                max-width: none;
            }
            .toast {
                left: 15px;
                right: 15px;
                bottom: 15px;
            }
            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }
            .estimate-banner {
                flex-direction: column;
                text-align: center;
            }
            .progress-container {
                padding: 20px 15px;
            }
            .selected-file {
                padding: 12px 15px;
            }
            .selected-file .file-icon {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        /* Responsive - Small Mobile */
        @media (max-width: 480px) {
            .main-content {
                padding: 65px 8px 15px;
            }
            .page-title {
                font-size: 16px;
            }
            .upload-area {
                padding: 25px 12px;
            }
            .upload-area h3 {
                font-size: 15px;
            }
            .upload-icon {
                font-size: 35px;
            }
            .music-info-panel {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 6px;
            }
            .music-info-card {
                padding: 8px 6px;
            }
            .music-info-icon {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            .music-info-value {
                font-size: 12px;
            }
            .music-info-label {
                font-size: 8px;
            }
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .stat-card {
                padding: 15px 10px;
            }
            .stat-value {
                font-size: 24px;
            }
            .stem-name > span:first-of-type {
                font-size: 12px;
            }
            .mute-btn, .solo-btn {
                width: 28px;
                height: 28px;
                font-size: 10px;
            }
            .play-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            .master-controls {
                padding: 12px 8px;
                gap: 6px;
            }
            .master-controls .icon-btn {
                height: 36px;
                font-size: 12px;
            }
            .time-display {
                font-size: 11px;
            }
            .pitch-control {
                padding: 10px;
            }
            .pitch-control label {
                font-size: 12px;
            }
            .pitch-value {
                font-size: 12px;
            }
            .lyrics-line {
                font-size: 12px;
                padding: 5px 6px;
            }
            .waveform-container {
                height: 40px;
            }
            .stem-track {
                padding: 8px 10px;
            }
            .volume-slider {
                height: 6px;
            }
            .stem-controls .icon-btn {
                width: 30px;
                height: 30px;
                font-size: 11px;
            }
            .global-timeline {
                padding: 10px;
            }
            .timeline-bar {
                height: 10px;
            }
            #stems-tab-player .btn.extract-lyrics-btn,
            #stems-tab-player .btn-secondary {
                padding: 8px 10px;
                font-size: 11px;
            }
            .language-select {
                font-size: 11px;
                padding: 6px 8px;
            }
        }

        /* Dashboard Navbar */
        .dashboard-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(5, 5, 8, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
        }
        .dashboard-navbar .navbar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            font-size: 20px;
            font-weight: bold;
        }
        .dashboard-navbar .navbar-logo-text {
            background: linear-gradient(135deg, var(--primary), #06b6d4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .dashboard-navbar .navbar-nav {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .dashboard-navbar .nav-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .dashboard-navbar .nav-link:hover {
            color: #fff;
            background: rgba(124, 58, 237, 0.1);
        }
        .dashboard-navbar .nav-dropdown {
            position: relative;
        }
        .dashboard-navbar .nav-dropdown-trigger {
            cursor: pointer;
        }
        .dashboard-navbar .nav-dropdown-trigger i.fa-chevron-down {
            font-size: 10px;
            transition: transform 0.2s;
        }
        .dashboard-navbar .nav-dropdown:hover .nav-dropdown-trigger i.fa-chevron-down {
            transform: rotate(180deg);
        }
        .dashboard-navbar .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 200px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .dashboard-navbar .nav-dropdown:hover .nav-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dashboard-navbar .nav-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .dashboard-navbar .nav-dropdown-item:hover {
            color: #fff;
            background: rgba(124, 58, 237, 0.1);
        }
        .dashboard-navbar .nav-dropdown-item i {
            width: 20px;
            text-align: center;
            color: var(--primary-light);
        }
        .dashboard-navbar .navbar-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .dashboard-navbar .theme-toggle {
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
        }
        .dashboard-navbar .theme-toggle:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: var(--primary);
            color: var(--text);
        }
        .dashboard-navbar .mobile-menu-toggle {
            display: none;
            width: 44px;
            height: 44px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 0;
            z-index: 1001;
        }
        .dashboard-navbar .mobile-menu-toggle:hover {
            background: var(--primary);
            border-color: var(--primary);
        }
        .dashboard-navbar .mobile-menu-toggle:hover span {
            background: white;
        }
        .dashboard-navbar .mobile-menu-toggle span {
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            transition: all 0.2s;
            display: block;
            border-radius: 2px;
        }
        .dashboard-navbar .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .dashboard-navbar .user-menu:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: var(--primary);
        }
        .dashboard-navbar .user-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), #06b6d4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            overflow: hidden;
        }
        .dashboard-navbar .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .dashboard-navbar .btn-ghost {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .dashboard-navbar .btn-ghost:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: var(--primary);
        }
        .dashboard-navbar .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), #6d28d9);
            border: none;
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .dashboard-navbar .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(124, 58, 237, 0.4);
        }
        .dashboard-navbar .divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }
        
        /* iPad / Tablet Responsive */
        @media (max-width: 1024px) {
            .dashboard-navbar .navbar-nav {
                display: none;
            }
            .dashboard-navbar .navbar-actions {
                flex: 1;
                justify-content: flex-end;
            }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-navbar {
                padding: 0 15px;
            }
            .dashboard-navbar .navbar-actions {
                gap: 10px;
            }
            .dashboard-navbar .navbar-actions .nav-dropdown {
                display: none;
            }
            .dashboard-navbar .navbar-actions .btn-ghost,
            .dashboard-navbar .navbar-actions .btn-primary {
                display: none;
            }
            .dashboard-navbar .theme-toggle {
                display: flex;
                order: 1;
            }
            .dashboard-navbar .mobile-menu-toggle {
                display: flex !important;
                order: 2;
            }
            .sidebar {
                top: 70px;
                height: calc(100vh - 70px);
            }
        }
    </style>
</head>
<body>
    <!-- Dashboard Navbar -->
    <nav class="dashboard-navbar">
        <a href="/" class="navbar-logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Harmonix" style="height: 32px; width: auto;">
            <span class="navbar-logo-text">Harmonix</span>
        </a>
        
        <div class="navbar-nav">
            <!-- Product Dropdown -->
            <div class="nav-dropdown">
                <a class="nav-link nav-dropdown-trigger">
                    Product <i class="fas fa-chevron-down"></i>
                </a>
                <div class="nav-dropdown-menu">
                    <a href="/features" class="nav-dropdown-item">
                        <i class="fas fa-magic"></i> Features
                    </a>
                    <a href="/pricing" class="nav-dropdown-item">
                        <i class="fas fa-tag"></i> Pricing
                    </a>
                </div>
            </div>
            
            <!-- Resources Dropdown -->
            <div class="nav-dropdown">
                <a class="nav-link nav-dropdown-trigger">
                    Resources <i class="fas fa-chevron-down"></i>
                </a>
                <div class="nav-dropdown-menu">
                    <a href="/docs" class="nav-dropdown-item">
                        <i class="fas fa-book"></i> Documentation
                    </a>
                    <a href="/tutorials" class="nav-dropdown-item">
                        <i class="fas fa-graduation-cap"></i> Tutorials
                    </a>
                    <a href="/community" class="nav-dropdown-item">
                        <i class="fas fa-users"></i> Community
                    </a>
                </div>
            </div>
            
            <!-- Musician Corner -->
            <div class="nav-dropdown">
                <a class="nav-link nav-dropdown-trigger">
                    <i class="fas fa-guitar"></i> Tools <i class="fas fa-chevron-down"></i>
                </a>
                <div class="nav-dropdown-menu">
                    <a href="/tuner" class="nav-dropdown-item">
                        <i class="fas fa-sliders-h"></i> Instrument Tuner
                    </a>
                    <a href="/transposer" class="nav-dropdown-item">
                        <i class="fas fa-exchange-alt"></i> Chord Transposer
                    </a>
                </div>
            </div>
        </div>
        
        <div class="navbar-actions">
            <!-- Theme Toggle -->
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <i class="fas fa-sun"></i>
            </button>
            
            {% if current_user %}
            <!-- User Menu -->
            <div class="nav-dropdown">
                <button class="user-menu nav-dropdown-trigger">
                    <div class="user-avatar">
                        {% if current_user.avatar %}
                        <img src="{{ current_user.avatar }}" alt="{{ current_user.name }}">
                        {% else %}
                        {{ current_user.name[0]|upper if current_user.name else 'U' }}
                        {% endif %}
                    </div>
                    <span>{{ current_user.name or 'User' }}</span>
                    <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                </button>
                <div class="nav-dropdown-menu" style="right: 0; left: auto;">
                    <a href="/account" class="nav-dropdown-item">
                        <i class="fas fa-user"></i> Account
                    </a>
                    {% if current_user.role == 'admin' %}
                    <a href="/admin" class="nav-dropdown-item">
                        <i class="fas fa-cog"></i> Admin Panel
                    </a>
                    {% endif %}
                    <div class="divider"></div>
                    <a href="/logout" class="nav-dropdown-item">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </a>
                </div>
            </div>
            {% else %}
            <a href="/login" class="btn-ghost">Sign In</a>
            <a href="/register" class="btn-primary">Get Started</a>
            {% endif %}
            
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Open menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Button (legacy - hidden on navbar update) -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()" style="display: none !important;">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Modals (partial) -->
    {% include 'dashboard/_modals.html' %}

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="nav-section">
            <div class="nav-title">Studio</div>
            <div class="nav-item active" data-section="stems">
                <i class="fas fa-layer-group"></i>
                <span>Audio to Stems</span>
            </div>
            <div class="nav-item" data-section="midi-converter">
                <i class="fas fa-music"></i>
                <span>Audio to MIDI</span>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-title">Tools</div>
            <div class="nav-item" data-section="tuner">
                <i class="fas fa-sliders-h"></i>
                <span>Instrument Tuner</span>
            </div>
            <div class="nav-item" data-section="transposer">
                <i class="fas fa-exchange-alt"></i>
                <span>Chord Transposer</span>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-title">Pages</div>
            <div class="nav-item" data-section="account">
                <i class="fas fa-user-circle"></i>
                <span>Account</span>
            </div>
            <div class="nav-item" data-section="docs">
                <i class="fas fa-book"></i>
                <span>Documentation</span>
            </div>
            <div class="nav-item" data-section="tutorials">
                <i class="fas fa-graduation-cap"></i>
                <span>Tutorials</span>
            </div>
        </div>
        
        <!-- Plan Usage Info -->
        <div class="nav-section" style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="nav-title">Your Plan</div>
            <div id="planUsageBox" style="background: rgba(124, 58, 237, 0.1); border-radius: 10px; padding: 15px; margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span id="planName" style="font-weight: 600; color: var(--primary);">Free</span>
                    <span id="planSongsUsed" style="font-size: 12px; color: #999;">0/3 songs</span>
                </div>
                <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                    <div id="planUsageBar" style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.3s;"></div>
                </div>
                <a href="/account" style="display: block; text-align: center; margin-top: 12px; font-size: 12px; color: var(--primary); text-decoration: none;">
                    <i class="fas fa-crown"></i> Manage Plan
                </a>
            </div>
            
            <!-- User Quick Actions -->
            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <a href="/admin" id="adminLinkSidebar" style="display: none; flex: 1; text-align: center; padding: 10px; background: rgba(245, 158, 11, 0.15); border-radius: 8px; color: #f59e0b; text-decoration: none; font-size: 12px; font-weight: 600;">
                    <i class="fas fa-shield-alt"></i> Admin
                </a>
                <a href="/logout" style="flex: 1; text-align: center; padding: 10px; background: rgba(239, 68, 68, 0.15); border-radius: 8px; color: #ef4444; text-decoration: none; font-size: 12px; font-weight: 600;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Audio to Stems Section (with tabs) -->
        <div id="section-stems" class="content-section active">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-layer-group"></i> Audio to Stems</h1>
                <p style="color: var(--text-muted); margin-top: 8px;">Separate audio into individual instrument tracks using AI</p>
            </div>
            
            <!-- Tabs for Stems sections -->
            <div class="stems-tabs" style="display: flex; gap: 10px; margin-top: 25px; border-bottom: 1px solid var(--border); padding-bottom: 0;">
                <button class="stems-tab active" data-tab="upload" onclick="switchStemsTab('upload')" style="padding: 12px 24px; background: none; border: none; color: var(--text); font-weight: 500; cursor: pointer; border-bottom: 2px solid var(--primary); margin-bottom: -1px; transition: all 0.3s;">
                    <i class="fas fa-cloud-upload-alt"></i> Upload & Process
                </button>
                <button class="stems-tab" data-tab="library" onclick="switchStemsTab('library')" style="padding: 12px 24px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.3s;">
                    <i class="fas fa-folder-open"></i> Library
                </button>
                <button class="stems-tab" data-tab="player" onclick="switchStemsTab('player')" style="padding: 12px 24px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.3s;">
                    <i class="fas fa-play-circle"></i> Player
                </button>
                <button class="stems-tab" data-tab="stats" onclick="switchStemsTab('stats')" style="padding: 12px 24px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.3s;">
                    <i class="fas fa-chart-bar"></i> Statistics
                </button>
            </div>
            
            <!-- Upload Tab Content -->
            <div id="stems-tab-upload" class="stems-tab-content" style="margin-top: 30px;">

            <!-- Upload Method Tabs -->
            <div class="upload-tabs">
                <button class="upload-tab active" data-tab="file">
                    <i class="fas fa-file-upload"></i> Upload File
                </button>
                <button class="upload-tab" data-tab="url">
                    <i class="fab fa-youtube"></i> From URL
                </button>
            </div>

            <!-- File Upload Tab -->
            <div id="uploadTab-file" class="upload-tab-content active">
                <div class="upload-area" id="uploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>Drop your audio file here</h3>
                    <p>or click to browse  MP3, WAV, FLAC, M4A, OGG (Max 500MB)</p>
                </div>
                <input type="file" id="fileInput" style="display: none;" accept=".mp3,.wav,.flac,.m4a,.ogg,.aac">
            </div>

            <!-- URL Upload Tab -->
            <div id="uploadTab-url" class="upload-tab-content">
                <div class="url-upload-area">
                    <div class="upload-icon">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <h3>Paste a YouTube or Audio URL</h3>
                    <p>YouTube, SoundCloud, Vimeo, and many more supported</p>
                    <div class="url-input-container">
                        <input type="text" id="urlInput" class="form-control url-input" placeholder="https://www.youtube.com/watch?v=...">
                        <button class="btn btn-secondary" id="fetchUrlBtn">
                            <i class="fas fa-download"></i> Fetch
                        </button>
                    </div>
                    <div id="urlPreview" class="url-preview" style="display: none;">
                        <div class="url-preview-icon"><i class="fas fa-music"></i></div>
                        <div class="url-preview-info">
                            <div class="url-preview-title" id="urlPreviewTitle"></div>
                            <div class="url-preview-source" id="urlPreviewSource"></div>
                        </div>
                        <button class="icon-btn" id="removeUrlBtn" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="selectedFilePreview" class="selected-file" style="display: none;">
                <div class="file-icon"><i class="fas fa-file-audio"></i></div>
                <div class="file-info">
                    <div class="file-name" id="selectedFileName"></div>
                    <div class="file-size" id="selectedFileSize"></div>
                </div>
                <button class="icon-btn" id="removeFileBtn" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="settings-grid">
                <div class="card">
                    <div class="form-group">
                        <label>Custom Output Name (Optional)</label>
                        <input type="text" class="form-control" id="outputName" placeholder="Leave empty to use original filename">
                    </div>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label>Quality Mode</label>
                        <select class="form-control" id="qualitySelect">
                            <option value="fast">Fast (Quick Processing)</option>
                            <option value="balanced" selected>Balanced (Recommended)</option>
                            <option value="studio">Studio (Highest Quality)</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label>Separation Mode</label>
                        <select class="form-control" id="modeSelect">
                            <option value="grouped" selected>Grouped (4 Stems)</option>
                            <option value="karaoke">Karaoke (Vocals + Instrumental)</option>
                            <option value="per_instrument">Per-Instrument (Detailed)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" id="processBtn" disabled style="padding: 15px 40px; font-size: 16px;">
                    <i class="fas fa-magic"></i> Start Processing
                </button>
            </div>

            <div id="estimateBanner" class="estimate-banner">
                <i class="fas fa-clock"></i>
                <div class="estimate-content">
                    <div class="estimate-time" id="estimatedTime">~2-3 minutes</div>
                    <div class="estimate-note" id="estimateNote">Processing time depends on file length and system resources</div>
                </div>
            </div>

            <div id="processingProgress" class="progress-container" style="display: none;">
                <h3><i class="fas fa-spinner fa-spin"></i> Processing Audio...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="progressStatus">Starting...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            </div><!-- End Upload Tab -->
            
            <!-- Library Tab Content -->
            <div id="stems-tab-library" class="stems-tab-content" style="display: none; margin-top: 30px;">
                <div class="header-controls" style="display: flex; gap: 15px; align-items: center; margin-bottom: 25px;">
                    <div class="search-box" style="flex: 1;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="librarySearch" placeholder="Search tracks...">
                    </div>
                    <button class="btn btn-secondary" id="refreshLibraryBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="libraryContent" class="track-list"></div>
            </div><!-- End Library Tab -->
            
            <!-- Player Tab Content -->
            <div id="stems-tab-player" class="stems-tab-content" style="display: none; margin-top: 30px;">
                <div id="playerContent">
                    <div class="empty-state">
                        <i class="fas fa-play-circle"></i>
                        <h3>No track loaded</h3>
                        <p>Select a track from your library to start playing</p>
                    </div>
                </div>
            </div><!-- End Player Tab -->
            
            <!-- Stats Tab Content -->
            <div id="stems-tab-stats" class="stems-tab-content" style="display: none; margin-top: 30px;">
                <div id="statsContent" class="stats-grid"></div>
            </div><!-- End Stats Tab -->
            
        </div><!-- End section-stems -->
        
        <!-- MIDI Converter Section -->
        <div id="section-midi-converter" class="content-section">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-music"></i> Audio to MIDI Converter</h1>
                <p style="color: var(--text-muted); margin-top: 8px;">Convert audio files to MIDI using AI-powered transcription</p>
            </div>
            
            <!-- Tabs for Convert / Library -->
            <div class="midi-tabs" style="display: flex; gap: 10px; margin-top: 25px; border-bottom: 1px solid var(--border); padding-bottom: 0;">
                <button class="midi-tab active" data-tab="convert" onclick="switchMidiTab('convert')" style="padding: 12px 24px; background: none; border: none; color: var(--text); font-weight: 500; cursor: pointer; border-bottom: 2px solid var(--primary); margin-bottom: -1px; transition: all 0.3s;">
                    <i class="fas fa-magic"></i> Convert
                </button>
                <button class="midi-tab" data-tab="library" onclick="switchMidiTab('library')" style="padding: 12px 24px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.3s;">
                    <i class="fas fa-folder-open"></i> MIDI Library
                </button>
                <button class="midi-tab" data-tab="player" onclick="switchMidiTab('player')" style="padding: 12px 24px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.3s;">
                    <i class="fas fa-play-circle"></i> MIDI Player
                </button>
            </div>
            
            <!-- Convert Tab Content -->
            <div id="midi-tab-convert" class="midi-tab-content" style="margin-top: 30px;">
            <div class="midi-converter-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Upload Section -->
                <div class="card" style="padding: 30px;">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-upload" style="color: var(--primary);"></i>
                        Upload Audio
                    </h3>
                    
                    <!-- Source Selection Tabs -->
                    <div class="midi-source-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="midi-source-tab active" data-tab="file" onclick="switchMidiSource('file')" style="flex: 1; padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                            <i class="fas fa-file-audio"></i> File
                        </button>
                        <button class="midi-source-tab" data-tab="url" onclick="switchMidiSource('url')" style="flex: 1; padding: 10px 15px; background: var(--bg-darker); color: var(--text-muted); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                            <i class="fab fa-youtube"></i> URL
                        </button>
                        <button class="midi-source-tab" data-tab="stem" onclick="switchMidiSource('stem')" style="flex: 1; padding: 10px 15px; background: var(--bg-darker); color: var(--text-muted); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                            <i class="fas fa-layer-group"></i> Stem
                        </button>
                    </div>
                    
                    <!-- File Upload Content -->
                    <div id="midiSourceFile" class="midi-source-content">
                        <div id="midiUploadArea" class="upload-area" style="border: 2px dashed var(--border); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;">
                            <div class="upload-icon" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;">
                                <i class="fas fa-file-audio"></i>
                            </div>
                            <h4 style="margin-bottom: 10px;">Drop audio file here</h4>
                            <p style="color: var(--text-muted); font-size: 14px;">or click to browse</p>
                            <p style="color: var(--text-dim); font-size: 12px; margin-top: 10px;">Supports MP3, WAV, FLAC, M4A</p>
                            <input type="file" id="midiFileInput" accept=".mp3,.wav,.flac,.m4a,.ogg" hidden>
                        </div>
                        
                        <div id="midiSelectedFile" style="display: none; margin-top: 20px; padding: 15px; background: var(--bg-darker); border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-file-audio" style="font-size: 24px; color: var(--primary);"></i>
                                <div style="flex: 1; min-width: 0;">
                                    <div id="midiFileName" style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">filename.mp3</div>
                                    <div id="midiFileSize" style="font-size: 12px; color: var(--text-muted);">0 MB</div>
                                </div>
                                <button onclick="clearMidiFile()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- URL Input Content -->
                    <div id="midiSourceUrl" class="midi-source-content" style="display: none;">
                        <div style="padding: 20px; background: var(--bg-darker); border-radius: 16px;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                                <span class="platform-badge" style="display: flex; align-items: center; gap: 5px; padding: 5px 12px; background: rgba(255,0,0,0.1); color: #ff0000; border-radius: 20px; font-size: 12px;">
                                    <i class="fab fa-youtube"></i> YouTube
                                </span>
                                <span class="platform-badge" style="display: flex; align-items: center; gap: 5px; padding: 5px 12px; background: rgba(255,85,0,0.1); color: #ff5500; border-radius: 20px; font-size: 12px;">
                                    <i class="fab fa-soundcloud"></i> SoundCloud
                                </span>
                                <span class="platform-badge" style="display: flex; align-items: center; gap: 5px; padding: 5px 12px; background: rgba(26,183,234,0.1); color: #1ab7ea; border-radius: 20px; font-size: 12px;">
                                    <i class="fab fa-vimeo"></i> Vimeo
                                </span>
                            </div>
                            
                            <div style="position: relative;">
                                <input type="text" id="midiUrlInput" placeholder="Paste YouTube, SoundCloud, or Vimeo link..." style="width: 100%; padding: 15px 50px 15px 15px; background: var(--bg); border: 2px solid var(--border); border-radius: 12px; color: var(--text); font-size: 14px;">
                                <button id="midiUrlFetchBtn" onclick="fetchMidiUrlInfo()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            
                            <!-- URL Preview -->
                            <div id="midiUrlPreview" style="display: none; margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div id="midiUrlPlatformIcon" style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fab fa-youtube" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div id="midiUrlTitle" style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Video Title</div>
                                        <div id="midiUrlInfo" style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                            <span id="midiUrlDuration">0:00</span>  <span id="midiUrlUploader">Unknown</span>
                                        </div>
                                    </div>
                                    <button onclick="clearMidiUrl()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stem Selection Content -->
                    <div id="midiSourceStem" class="midi-source-content" style="display: none;">
                        <div style="padding: 20px; background: var(--bg-darker); border-radius: 16px;">
                            <p style="text-align: center; color: var(--text-muted); margin-bottom: 15px;">
                                <i class="fas fa-info-circle"></i> Convert a stem from your separated tracks
                            </p>
                            <select id="midiStemSelect" style="width: 100%; padding: 12px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px;">
                                <option value="">Select a stem from your library...</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="convertToMidiBtn" onclick="convertToMidi()" class="btn btn-primary" style="width: 100%; margin-top: 25px; padding: 15px;" disabled>
                        <i class="fas fa-magic"></i> Convert to MIDI
                    </button>
                </div>
                
                <!-- Results Section -->
                <div class="card" style="padding: 30px;">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-file-download" style="color: var(--secondary);"></i>
                        MIDI Output
                    </h3>
                    
                    <div id="midiResult" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(6, 182, 212, 0.1)); border-radius: 16px; padding: 30px; text-align: center;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-check" style="font-size: 36px; color: white;"></i>
                            </div>
                            <h4 style="margin-bottom: 10px;">Conversion Complete!</h4>
                            <p id="midiResultName" style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">output.mid</p>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button id="downloadMidiBtn" class="btn btn-primary">
                                    <i class="fas fa-download"></i> Download MIDI
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px; padding: 20px; background: var(--bg-darker); border-radius: 12px;">
                            <h5 style="margin-bottom: 15px; color: var(--text-muted); font-size: 12px; text-transform: uppercase;">Conversion Details</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-dim);">Notes Detected</div>
                                    <div id="midiNotesCount" style="font-size: 20px; font-weight: 600; color: var(--primary);">0</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-dim);">Duration</div>
                                    <div id="midiDuration" style="font-size: 20px; font-weight: 600; color: var(--secondary);">0:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="midiProcessing" style="display: none; text-align: center; padding: 50px 20px;">
                        <div class="processing-animation" style="margin-bottom: 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary);"></i>
                        </div>
                        <h4>Converting to MIDI...</h4>
                        <p style="color: var(--text-muted); margin-top: 10px;">This may take a moment</p>
                        <div style="margin-top: 20px; height: 4px; background: var(--bg-darker); border-radius: 2px; overflow: hidden;">
                            <div id="midiProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div id="midiEmpty" style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-file-audio" style="font-size: 64px; opacity: 0.3; margin-bottom: 20px;"></i>
                        <h4 style="color: var(--text-dim);">No MIDI Generated Yet</h4>
                        <p style="font-size: 14px; margin-top: 10px;">Upload an audio file or select a stem to convert</p>
                    </div>
                </div>
            </div>
            
            <!-- Tips Section -->
            <div class="card" style="padding: 25px; margin-top: 30px;">
                <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                    Tips for Best Results
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="display: flex; gap: 12px;">
                        <i class="fas fa-check-circle" style="color: var(--success); margin-top: 2px;"></i>
                        <div>
                            <strong>Use isolated stems</strong>
                            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Vocals, bass, or piano stems convert better than mixed audio</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <i class="fas fa-check-circle" style="color: var(--success); margin-top: 2px;"></i>
                        <div>
                            <strong>Monophonic works best</strong>
                            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Single melodies are easier to transcribe than complex chords</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <i class="fas fa-check-circle" style="color: var(--success); margin-top: 2px;"></i>
                        <div>
                            <strong>Clear recordings</strong>
                            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">High-quality audio without distortion yields better MIDI</p>
                        </div>
                    </div>
                </div>
            </div>
            </div><!-- End Convert Tab -->
            
            <!-- Library Tab Content -->
            <div id="midi-tab-library" class="midi-tab-content" style="display: none; margin-top: 30px;">
                <div class="card" style="padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-folder-open" style="color: var(--primary);"></i>
                            Your MIDI Files
                        </h3>
                        <button onclick="refreshMidiLibrary()" class="btn btn-secondary" style="padding: 8px 16px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div id="midiLibraryLoading" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary);"></i>
                        <p style="color: var(--text-muted); margin-top: 15px;">Loading your MIDI files...</p>
                    </div>
                    
                    <div id="midiLibraryEmpty" style="display: none; text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-music" style="font-size: 64px; opacity: 0.3; margin-bottom: 20px;"></i>
                        <h4 style="color: var(--text-dim);">No MIDI Files Yet</h4>
                        <p style="font-size: 14px; margin-top: 10px;">Convert some audio to MIDI to see them here</p>
                        <button onclick="switchMidiTab('convert')" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-magic"></i> Convert Audio
                        </button>
                    </div>
                    
                    <div id="midiLibraryGrid" style="display: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                        <!-- MIDI files will be populated here -->
                    </div>
                </div>
            </div><!-- End Library Tab -->
            
            <!-- Player Tab Content -->
            <div id="midi-tab-player" class="midi-tab-content" style="display: none; margin-top: 30px;">
                <div class="card" style="padding: 30px;">
                    <h3 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-play-circle" style="color: var(--secondary);"></i>
                        MIDI Player
                    </h3>
                    
                    <!-- File Selection -->
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">Select MIDI File</label>
                        <select id="midiPlayerSelect" onchange="loadMidiForPlayer(this.value)" style="width: 100%; padding: 12px 15px; background: var(--bg-darker); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px;">
                            <option value="">Choose a MIDI file from your library...</option>
                        </select>
                    </div>
                    
                    <!-- Player Interface -->
                    <div id="midiPlayerInterface" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(6, 182, 212, 0.1)); border-radius: 16px; padding: 30px;">
                            <!-- Now Playing Info -->
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);">
                                    <i id="midiPlayerIcon" class="fas fa-music" style="font-size: 40px; color: white;"></i>
                                </div>
                                <h4 id="midiPlayerTitle" style="margin-bottom: 5px;">No file loaded</h4>
                                <p id="midiPlayerInfo" style="color: var(--text-muted); font-size: 14px;">Select a MIDI file to play</p>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div style="margin-bottom: 20px;">
                                <div id="midiPlayerProgress" style="height: 6px; background: var(--bg-darker); border-radius: 3px; cursor: pointer; overflow: hidden;" onclick="seekMidiPlayer(event)">
                                    <div id="midiPlayerProgressFill" style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.1s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                                    <span id="midiPlayerCurrentTime">0:00</span>
                                    <span id="midiPlayerTotalTime">0:00</span>
                                </div>
                            </div>
                            
                            <!-- Controls -->
                            <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                                <button onclick="restartMidiPlayer()" style="width: 45px; height: 45px; border-radius: 50%; background: var(--bg-darker); border: none; color: var(--text); cursor: pointer; transition: all 0.3s;" title="Restart">
                                    <i class="fas fa-redo-alt"></i>
                                </button>
                                <button id="midiPlayBtn" onclick="toggleMidiPlayer()" style="width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; color: white; cursor: pointer; font-size: 24px; box-shadow: 0 5px 20px rgba(124, 58, 237, 0.4); transition: all 0.3s;">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button onclick="stopMidiPlayer()" style="width: 45px; height: 45px; border-radius: 50%; background: var(--bg-darker); border: none; color: var(--text); cursor: pointer; transition: all 0.3s;" title="Stop">
                                    <i class="fas fa-stop"></i>
                                </button>
                                <button onclick="testMidiSound()" style="width: 35px; height: 35px; border-radius: 50%; background: var(--success); border: none; color: white; cursor: pointer; transition: all 0.3s; font-size: 12px;" title="Test Sound">
                                    <i class="fas fa-bell"></i>
                                </button>
                            </div>
                            
                            <!-- Volume & Tempo -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                                <div>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                        <i class="fas fa-volume-up"></i> Volume
                                    </label>
                                    <input type="range" id="midiPlayerVolume" min="0" max="100" value="80" onchange="setMidiVolume(this.value)" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                        <i class="fas fa-tachometer-alt"></i> Tempo: <span id="midiTempoValue">100%</span>
                                    </label>
                                    <input type="range" id="midiPlayerTempo" min="50" max="150" value="100" onchange="setMidiTempo(this.value)" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- MIDI Info Panel -->
                        <div style="margin-top: 25px; padding: 20px; background: var(--bg-darker); border-radius: 12px;">
                            <h5 style="margin-bottom: 15px; color: var(--text-muted); font-size: 12px; text-transform: uppercase;">Track Information</h5>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-dim);">Tracks</div>
                                    <div id="midiPlayerTracks" style="font-size: 20px; font-weight: 600; color: var(--primary);">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-dim);">Notes</div>
                                    <div id="midiPlayerNotes" style="font-size: 20px; font-weight: 600; color: var(--secondary);">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-dim);">Duration</div>
                                    <div id="midiPlayerDuration" style="font-size: 20px; font-weight: 600; color: var(--primary);">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-dim);">Instrument</div>
                                    <div id="midiPlayerInstrument" style="font-size: 16px; font-weight: 600; color: var(--secondary);">Piano</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Instrument Selection -->
                        <div style="margin-top: 20px; padding: 20px; background: var(--bg-darker); border-radius: 12px;">
                            <label style="display: block; margin-bottom: 15px; font-weight: 500;">
                                <i class="fas fa-guitar" style="color: var(--primary); margin-right: 8px;"></i>
                                Playback Instrument 
                                <span style="font-size: 12px; color: var(--text-muted); font-weight: normal; margin-left: 8px;">Real Sampled Sounds</span>
                            </label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                                <button class="instrument-btn active" data-instrument="piano" onclick="setMidiInstrument('piano')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--primary); color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-music" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Grand Piano</span>
                                </button>
                                <button class="instrument-btn" data-instrument="guitar" onclick="setMidiInstrument('guitar')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-guitar" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Acoustic Guitar</span>
                                </button>
                                <button class="instrument-btn" data-instrument="violin" onclick="setMidiInstrument('violin')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-scroll" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Violin</span>
                                </button>
                                <button class="instrument-btn" data-instrument="cello" onclick="setMidiInstrument('cello')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-scroll" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Cello</span>
                                </button>
                                <button class="instrument-btn" data-instrument="flute" onclick="setMidiInstrument('flute')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-wind" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Flute</span>
                                </button>
                                <button class="instrument-btn" data-instrument="trumpet" onclick="setMidiInstrument('trumpet')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-bullhorn" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Trumpet</span>
                                </button>
                                <button class="instrument-btn" data-instrument="bass" onclick="setMidiInstrument('bass')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-drum" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Electric Bass</span>
                                </button>
                                <button class="instrument-btn" data-instrument="organ" onclick="setMidiInstrument('organ')" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="fas fa-church" style="font-size: 20px;"></i>
                                    <span style="font-size: 12px;">Church Organ</span>
                                </button>
                            </div>
                            <div id="instrumentLoadingStatus" style="margin-top: 12px; font-size: 12px; color: var(--text-muted); display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Loading instrument samples...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="midiPlayerEmpty" style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-play-circle" style="font-size: 64px; opacity: 0.3; margin-bottom: 20px;"></i>
                        <h4 style="color: var(--text-dim);">Select a MIDI File</h4>
                        <p style="font-size: 14px; margin-top: 10px;">Choose a file from your library to start playing</p>
                    </div>
                </div>
            </div><!-- End Player Tab -->
            
        </div>
        
        <!-- Tuner Section (Embedded) -->
        <div id="section-tuner" class="content-section">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-sliders-h"></i> Instrument Tuner</h1>
                <p style="color: var(--text-muted); margin-top: 8px;">Tune your instrument using your microphone</p>
            </div>
            <div class="embedded-page-container" style="margin-top: 20px;">
                <iframe id="tunerFrame" src="/tuner?embed=1" style="width: 100%; height: calc(100vh - 180px); border: none; border-radius: 16px; background: var(--bg-darker);"></iframe>
            </div>
        </div>
        
        <!-- Transposer Section (Embedded) -->
        <div id="section-transposer" class="content-section">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-exchange-alt"></i> Chord Transposer</h1>
                <p style="color: var(--text-muted); margin-top: 8px;">Transpose chords to any key</p>
            </div>
            <div class="embedded-page-container" style="margin-top: 20px;">
                <iframe id="transposerFrame" src="/transposer?embed=1" style="width: 100%; height: calc(100vh - 180px); border: none; border-radius: 16px; background: var(--bg-darker);"></iframe>
            </div>
        </div>
        
        <!-- Account Section (Embedded) -->
        <div id="section-account" class="content-section">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-user-circle"></i> Account Settings</h1>
                <p style="color: var(--text-muted); margin-top: 8px;">Manage your profile, subscription, and preferences</p>
            </div>
            <div class="embedded-page-container" style="margin-top: 20px;">
                <iframe id="accountFrame" src="/account?embed=1" style="width: 100%; height: calc(100vh - 180px); border: none; border-radius: 16px; background: var(--bg-darker);"></iframe>
            </div>
        </div>
        
        <!-- Documentation Section (Embedded) -->
        <div id="section-docs" class="content-section">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-book"></i> Documentation</h1>
                <p style="color: var(--text-muted); margin-top: 8px;">Learn how to use all Harmonix features</p>
            </div>
            <div class="embedded-page-container" style="margin-top: 20px;">
                <iframe id="docsFrame" src="/docs?embed=1" style="width: 100%; height: calc(100vh - 180px); border: none; border-radius: 16px; background: var(--bg-darker);"></iframe>
            </div>
        </div>
        
        <!-- Tutorials Section (Embedded) -->
        <div id="section-tutorials" class="content-section">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-graduation-cap"></i> Tutorials</h1>
                <p style="color: var(--text-muted); margin-top: 8px;">Step-by-step guides and video tutorials</p>
            </div>
            <div class="embedded-page-container" style="margin-top: 20px;">
                <iframe id="tutorialsFrame" src="/tutorials?embed=1" style="width: 100%; height: calc(100vh - 180px); border: none; border-radius: 16px; background: var(--bg-darker);"></iframe>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    {% include 'dashboard/_toast.html' %}

    <!-- Background Jobs Indicator -->
    <div id="backgroundJobsIndicator" class="background-jobs-indicator" style="display: none;">
        <div class="bg-jobs-content">
            <div class="bg-jobs-spinner"></div>
            <div class="bg-jobs-text">
                <span id="bgJobsCount">1</span> job<span id="bgJobsPlural">s</span> processing...
            </div>
            <button class="bg-jobs-view" onclick="viewBackgroundJobs()">View</button>
        </div>
    </div>

    <style>
        .background-jobs-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .bg-jobs-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .bg-jobs-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .bg-jobs-text {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }
        
        .bg-jobs-view {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .bg-jobs-view:hover {
            background: rgba(255,255,255,0.3);
        }
        
        @media (max-width: 768px) {
            .background-jobs-indicator {
                bottom: 70px;
                right: 10px;
                left: 10px;
                border-radius: 12px;
            }
        }
    </style>

    <script>
        // ==================== STATE ====================
        let allTracks = [];
        let selectedFile = null;
        let currentJobId = null;
        let statusInterval = null;
        let wavesurfers = {};
        let isPlaying = false;
        let currentTrack = null;
        let masterDuration = 0;
        let masterTime = 0;
        let isSeeking = false;
        let soloStems = new Set();
        let mutedStems = new Set();
        let animationFrameId = null;
        let audioContext = null;
        let masterStartTime = 0;  // AudioContext time when playback started
        let pausedAt = 0;         // Time position when paused
        let syncTolerance = 0.05; // 50ms sync tolerance (increased for stability)
        let lastSyncCheck = 0;
        let currentPitch = 0;     // Current pitch shift in semitones (-4 to +4)
        let currentLyrics = null; // Current lyrics data
        let lyricsVisible = false;
        
        // Background jobs tracking
        let backgroundJobs = {};   // Track all active background jobs
        let bgJobsInterval = null; // Interval for checking background jobs
        
        // Debug mode - set to true for verbose logging
        let DEBUG = true;
        let debugStats = {
            playCount: 0,
            pauseCount: 0,
            seekCount: 0,
            driftCorrections: 0,
            lastDriftValues: [],
            stateChanges: []
        };
        
        // Debug logging helper
        function debugLog(category, message, data) {
            if (!DEBUG) return;
            var timestamp = new Date().toISOString().substr(11, 12);
            var prefix = '[' + timestamp + '] [' + category + ']';
            if (data !== undefined) {
                console.log(prefix, message, data);
            } else {
                console.log(prefix, message);
            }
        }
        
        function debugState(action) {
            if (!DEBUG) return;
            debugStats.stateChanges.push({
                time: Date.now(),
                action: action,
                isPlaying: isPlaying,
                masterTime: masterTime.toFixed(3),
                pausedAt: pausedAt.toFixed(3)
            });
            // Keep only last 20 state changes
            if (debugStats.stateChanges.length > 20) {
                debugStats.stateChanges.shift();
            }
        }

        // ==================== MOBILE SIDEBAR ====================
        function toggleSidebar() {
            var sidebar = document.querySelector('.sidebar');
            var overlay = document.getElementById('sidebarOverlay');
            var menuBtn = document.getElementById('mobileMenuBtn');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            // Toggle icon
            var icon = menuBtn.querySelector('i');
            if (sidebar.classList.contains('open')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }

        // Close sidebar when clicking nav item on mobile
        function closeSidebarOnMobile() {
            if (window.innerWidth <= 768) {
                var sidebar = document.querySelector('.sidebar');
                var overlay = document.getElementById('sidebarOverlay');
                var menuBtn = document.getElementById('mobileMenuBtn');
                
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                
                var icon = menuBtn.querySelector('i');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }

        // ==================== PLAN INFO ====================
        let userPlanInfo = null;
        
        function loadPlanInfo() {
            fetch('/api/plan-info')
                .then(response => response.json())
                .then(data => {
                    userPlanInfo = data;
                    updatePlanDisplay(data);
                    
                    // Show admin link if user is admin
                    if (data.is_admin) {
                        const adminLink = document.getElementById('adminLinkSidebar');
                        if (adminLink) {
                            adminLink.style.display = 'block';
                        }
                    }
                })
                .catch(err => {
                    console.log('Plan info not available:', err);
                });
        }
        
        function updatePlanDisplay(data) {
            const planName = document.getElementById('planName');
            const songsUsed = document.getElementById('planSongsUsed');
            const usageBar = document.getElementById('planUsageBar');
            
            if (!planName || !songsUsed || !usageBar) return;
            
            const plan = data.plan_details || { name: 'Free', songs_per_month: 3 };
            const usage = data.usage || { used: 0, limit: 3 };
            
            planName.textContent = plan.name;
            
            if (usage.limit === 'unlimited' || plan.songs_per_month === -1) {
                songsUsed.textContent = `${usage.used || 0} songs`;
                usageBar.style.width = '0%';
                usageBar.style.background = 'var(--success)';
            } else {
                const used = usage.used || 0;
                const limit = usage.limit || plan.songs_per_month || 3;
                songsUsed.textContent = `${used}/${limit} songs`;
                const percentage = Math.min((used / limit) * 100, 100);
                usageBar.style.width = `${percentage}%`;
                
                // Change color based on usage
                if (percentage >= 100) {
                    usageBar.style.background = 'var(--danger)';
                } else if (percentage >= 80) {
                    usageBar.style.background = 'var(--warning)';
                }
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initNavigation();
            initUpload();
            loadLibrary();
            loadStats();
            loadPlanInfo();
            checkBackgroundJobs(); // Check for any running jobs on page load
        });

        // ==================== BACKGROUND JOBS TRACKING ====================
        function checkBackgroundJobs() {
            fetch('/jobs')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var jobs = data.jobs || [];
                var activeJobs = jobs.filter(function(job) {
                    return job.status === 'queued' || job.status === 'processing' || job.status === 'downloading';
                });
                
                // Track active jobs
                activeJobs.forEach(function(job) {
                    if (!backgroundJobs[job.job_id]) {
                        backgroundJobs[job.job_id] = {
                            name: job.display_name || job.filename || 'Processing...',
                            status: job.status,
                            progress: job.progress || 0
                        };
                    }
                });
                
                // Remove completed jobs from tracking
                Object.keys(backgroundJobs).forEach(function(jobId) {
                    var found = activeJobs.find(function(j) { return j.job_id === jobId; });
                    if (!found) {
                        delete backgroundJobs[jobId];
                    }
                });
                
                updateBackgroundJobsIndicator();
                
                // If there are active jobs, start polling
                if (activeJobs.length > 0 && !bgJobsInterval) {
                    bgJobsInterval = setInterval(pollBackgroundJobs, 3000);
                }
            })
            .catch(function(error) {
                console.error('Failed to check background jobs:', error);
            });
        }
        
        function pollBackgroundJobs() {
            fetch('/jobs')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var jobs = data.jobs || [];
                var activeJobs = jobs.filter(function(job) {
                    return job.status === 'queued' || job.status === 'processing' || job.status === 'downloading';
                });
                
                // Check for newly completed jobs
                Object.keys(backgroundJobs).forEach(function(jobId) {
                    var job = jobs.find(function(j) { return j.job_id === jobId; });
                    if (job && job.status === 'completed') {
                        showToast(' ' + (backgroundJobs[jobId].name || 'Job') + ' completed!', 'success');
                        delete backgroundJobs[jobId];
                        loadLibrary(); // Refresh library
                    } else if (job && job.status === 'failed') {
                        showToast(' ' + (backgroundJobs[jobId].name || 'Job') + ' failed', 'error');
                        delete backgroundJobs[jobId];
                    } else if (job) {
                        backgroundJobs[jobId].status = job.status;
                        backgroundJobs[jobId].progress = job.progress || 0;
                    }
                });
                
                // Add any new active jobs
                activeJobs.forEach(function(job) {
                    if (!backgroundJobs[job.job_id]) {
                        backgroundJobs[job.job_id] = {
                            name: job.display_name || job.filename || 'Processing...',
                            status: job.status,
                            progress: job.progress || 0
                        };
                    }
                });
                
                updateBackgroundJobsIndicator();
                
                // Stop polling if no more active jobs
                if (Object.keys(backgroundJobs).length === 0 && bgJobsInterval) {
                    clearInterval(bgJobsInterval);
                    bgJobsInterval = null;
                }
            })
            .catch(function(error) {
                console.error('Background jobs poll failed:', error);
            });
        }
        
        function updateBackgroundJobsIndicator() {
            var indicator = document.getElementById('backgroundJobsIndicator');
            var count = Object.keys(backgroundJobs).length;
            
            if (count > 0) {
                indicator.style.display = 'block';
                document.getElementById('bgJobsCount').textContent = count;
                document.getElementById('bgJobsPlural').textContent = count === 1 ? '' : 's';
            } else {
                indicator.style.display = 'none';
            }
        }
        
        function viewBackgroundJobs() {
            // Navigate to upload section to see progress
            navigateTo('stems');
            switchStemsTab('upload');
            
            // If there's a current job being processed, show the progress
            var jobIds = Object.keys(backgroundJobs);
            if (jobIds.length > 0) {
                // Show processing progress for first active job
                currentJobId = jobIds[0];
                document.getElementById('processingProgress').style.display = 'block';
                
                // Update progress display
                var job = backgroundJobs[currentJobId];
                if (job) {
                    updateProgress(job.progress, job.status);
                }
                
                // Start status polling for this job
                if (!statusInterval) {
                    startStatusPolling();
                }
            }
        }
        
        function addBackgroundJob(jobId, name) {
            backgroundJobs[jobId] = {
                name: name || 'Processing...',
                status: 'queued',
                progress: 0
            };
            updateBackgroundJobsIndicator();
            
            // Start polling if not already
            if (!bgJobsInterval) {
                bgJobsInterval = setInterval(pollBackgroundJobs, 3000);
            }
        }

        // ==================== NAVIGATION ====================
        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    var sectionId = this.getAttribute('data-section');
                    navigateTo(sectionId);
                    closeSidebarOnMobile(); // Close sidebar on mobile after navigation
                });
            });

            document.getElementById('refreshLibraryBtn').addEventListener('click', loadLibrary);
            
            // Search functionality
            var searchInput = document.getElementById('librarySearch');
            var searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    renderLibrary(searchInput.value);
                }, 300);
            });
        }

        function navigateTo(sectionId) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });

            // Update sections
            document.querySelectorAll('.content-section').forEach(function(section) {
                section.classList.remove('active');
            });
            
            var targetSection = document.getElementById('section-' + sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Load data for section
            if (sectionId === 'stems') {
                loadLibrary();
                loadStats();
            } else if (sectionId === 'library') {
                // Legacy - redirect to stems library tab
                document.getElementById('section-stems').classList.add('active');
                document.querySelector('.nav-item[data-section="stems"]').classList.add('active');
                switchStemsTab('library');
                loadLibrary();
            } else if (sectionId === 'stats') {
                loadStats();
            }
        }

        // ==================== UPLOAD ====================
        function initUpload() {
            var uploadZone = document.getElementById('uploadZone');
            var fileInput = document.getElementById('fileInput');

            // Tab switching
            document.querySelectorAll('.upload-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var tabName = this.dataset.tab;
                    
                    // Update tab active states
                    document.querySelectorAll('.upload-tab').forEach(function(t) { t.classList.remove('active'); });
                    this.classList.add('active');
                    
                    // Update content visibility
                    document.querySelectorAll('.upload-tab-content').forEach(function(c) { c.classList.remove('active'); });
                    document.getElementById('uploadTab-' + tabName).classList.add('active');
                    
                    // Clear selections when switching tabs
                    if (tabName === 'url') {
                        clearFile();
                    } else {
                        clearUrlSelection();
                    }
                });
            });

            uploadZone.addEventListener('click', function() {
                fileInput.click();
            });

            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function() {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    selectFile(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    selectFile(e.target.files[0]);
                }
            });

            document.getElementById('removeFileBtn').addEventListener('click', clearFile);
            document.getElementById('processBtn').addEventListener('click', startProcessing);
            
            // URL upload handlers
            document.getElementById('fetchUrlBtn').addEventListener('click', fetchUrl);
            document.getElementById('removeUrlBtn').addEventListener('click', clearUrlSelection);
            document.getElementById('urlInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') fetchUrl();
            });
            
            // Update estimate when quality changes
            document.getElementById('qualitySelect').addEventListener('change', updateEstimate);
        }

        // URL upload state
        var selectedUrl = null;
        var selectedUrlTitle = null;

        function fetchUrl() {
            var urlInput = document.getElementById('urlInput');
            var url = urlInput.value.trim();
            
            if (!url) {
                showToast('Please enter a URL', 'warning');
                return;
            }
            
            // Basic URL validation
            if (!url.match(/^https?:\/\/.+/)) {
                showToast('Please enter a valid URL starting with http:// or https://', 'warning');
                return;
            }
            
            var fetchBtn = document.getElementById('fetchUrlBtn');
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            
            // Validate URL with backend
            fetch('/validate-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i class="fas fa-download"></i> Fetch';
                
                if (data.valid) {
                    selectedUrl = url;
                    selectedUrlTitle = data.title || 'Audio from URL';
                    
                    document.getElementById('urlPreviewTitle').textContent = selectedUrlTitle;
                    document.getElementById('urlPreviewSource').textContent = data.source || extractDomain(url);
                    document.getElementById('urlPreview').style.display = 'flex';
                    document.getElementById('processBtn').disabled = false;
                    
                    // Auto-fill output name
                    if (!document.getElementById('outputName').value.trim()) {
                        document.getElementById('outputName').value = sanitizeFilename(selectedUrlTitle);
                    }
                    
                    showToast('URL validated successfully!', 'success');
                } else {
                    showToast(data.error || 'Could not fetch audio from this URL', 'error');
                }
            })
            .catch(function(error) {
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i class="fas fa-download"></i> Fetch';
                showToast('Failed to validate URL: ' + error.message, 'error');
            });
        }

        function clearUrlSelection() {
            selectedUrl = null;
            selectedUrlTitle = null;
            document.getElementById('urlInput').value = '';
            document.getElementById('urlPreview').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
        }

        function extractDomain(url) {
            try {
                var domain = new URL(url).hostname;
                return domain.replace('www.', '');
            } catch (e) {
                return 'Unknown source';
            }
        }

        function sanitizeFilename(name) {
            return name.replace(/[<>:"/\\|?*]/g, '').substring(0, 100);
        }

        function updateEstimate() {
            if (!selectedFile) {
                document.getElementById('estimateBanner').classList.remove('show');
                return;
            }

            var quality = document.getElementById('qualitySelect').value;
            
            // Create an audio element to get duration
            var audio = new Audio();
            var reader = new FileReader();
            
            reader.onload = function(e) {
                audio.src = e.target.result;
                audio.addEventListener('loadedmetadata', function() {
                    var duration = audio.duration;
                    
                    fetch('/estimate-time', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ duration: duration, quality: quality })
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.total_formatted) {
                            document.getElementById('estimatedTime').textContent = '~' + data.total_formatted;
                            
                            var note = '';
                            if (quality === 'studio') {
                                note = 'Studio quality uses multiple passes for best results' + (data.has_gpu ? '' : ' (CPU mode)');
                            } else if (quality === 'balanced') {
                                note = 'Balanced mode offers good quality with reasonable speed';
                            } else {
                                note = 'Fast mode for quick previews';
                            }
                            document.getElementById('estimateNote').textContent = note;
                            document.getElementById('estimateBanner').classList.add('show');
                        }
                    })
                    .catch(function(error) {
                        console.error('Failed to get estimate:', error);
                    });
                });
            };
            
            // Only read first bit to get metadata
            reader.readAsDataURL(selectedFile.slice(0, 10 * 1024 * 1024)); // First 10MB
        }

        function selectFile(file) {
            selectedFile = file;
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
            document.getElementById('selectedFilePreview').style.display = 'flex';
            document.getElementById('processBtn').disabled = false;
            updateEstimate();
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('selectedFilePreview').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('fileInput').value = '';
            document.getElementById('estimateBanner').classList.remove('show');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function startProcessing() {
            // Check if we have a file or URL to process
            if (!selectedFile && !selectedUrl) {
                showToast('Please select a file or enter a URL', 'warning');
                return;
            }

            document.getElementById('processBtn').disabled = true;
            document.getElementById('processingProgress').style.display = 'block';

            if (selectedUrl) {
                // URL-based upload
                startUrlProcessing();
            } else {
                // File-based upload
                startFileProcessing();
            }
        }

        function startFileProcessing() {
            var formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('quality', document.getElementById('qualitySelect').value);
            formData.append('mode', document.getElementById('modeSelect').value);

            var outputName = document.getElementById('outputName').value.trim();
            if (outputName) {
                formData.append('output_name', outputName);
            }

            updateProgress(0, 'Uploading...');

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    data._status = response.status;
                    if (!response.ok) {
                        throw data;
                    }
                    return data;
                });
            })
            .then(function(data) {
                currentJobId = data.job_id;
                // Register with background jobs tracker
                var jobName = document.getElementById('outputName').value.trim() || selectedFile.name;
                addBackgroundJob(data.job_id, jobName);
                showToast('Processing started!', 'success');
                startStatusPolling();
                // Refresh plan info after successful upload
                loadPlanInfo();
            })
            .catch(function(error) {
                // Check if this is a limit reached error
                if (error.limit_reached) {
                    showLimitReachedModal(error);
                } else {
                    showToast('Error: ' + (error.error || error.message || 'Upload failed'), 'error');
                }
                document.getElementById('processingProgress').style.display = 'none';
                document.getElementById('processBtn').disabled = false;
            });
        }
        
        function showLimitReachedModal(error) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; text-align: center;">
                    <div style="padding: 30px;">
                        <div style="width: 70px; height: 70px; background: rgba(231, 76, 60, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: var(--danger);"></i>
                        </div>
                        <h3 style="margin-bottom: 10px;">Monthly Limit Reached</h3>
                        <p style="color: #999; margin-bottom: 25px;">${error.error}</p>
                        <p style="color: #fff; margin-bottom: 20px;">Upgrade your plan for more songs and features!</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Maybe Later</button>
                            <a href="/#pricing" class="btn btn-primary"><i class="fas fa-crown"></i> Upgrade Now</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) modal.remove();
            });
        }

        function startUrlProcessing() {
            updateProgress(0, 'Downloading audio from URL...');

            fetch('/upload-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url: selectedUrl,
                    quality: document.getElementById('qualitySelect').value,
                    mode: document.getElementById('modeSelect').value,
                    output_name: document.getElementById('outputName').value.trim() || selectedUrlTitle
                })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    data._status = response.status;
                    if (!response.ok) {
                        throw data;
                    }
                    return data;
                });
            })
            .then(function(data) {
                currentJobId = data.job_id;
                // Register with background jobs tracker
                var jobName = document.getElementById('outputName').value.trim() || selectedUrlTitle || 'URL Audio';
                addBackgroundJob(data.job_id, jobName);
                showToast('Downloading and processing...', 'success');
                startStatusPolling();
                // Refresh plan info after successful upload
                loadPlanInfo();
            })
            .catch(function(error) {
                // Check if this is a limit reached error
                if (error.limit_reached) {
                    showLimitReachedModal(error);
                } else {
                    showToast('Error: ' + (error.error || error.message || 'URL processing failed'), 'error');
                }
                document.getElementById('processingProgress').style.display = 'none';
                document.getElementById('processBtn').disabled = false;
            });
        }

        function startStatusPolling() {
            statusInterval = setInterval(checkStatus, 2000);
        }

        function checkStatus() {
            if (!currentJobId) return;

            fetch('/status/' + currentJobId)
            .then(function(response) {
                return response.json();
            })
            .then(function(job) {
                updateProgress(job.progress || 0, job.status);
                
                // Update background job progress
                if (currentJobId && backgroundJobs[currentJobId]) {
                    backgroundJobs[currentJobId].progress = job.progress || 0;
                    backgroundJobs[currentJobId].status = job.status;
                }

                if (job.status === 'completed') {
                    clearInterval(statusInterval);
                    statusInterval = null;
                    // Remove from background jobs
                    if (currentJobId && backgroundJobs[currentJobId]) {
                        delete backgroundJobs[currentJobId];
                        updateBackgroundJobsIndicator();
                    }
                    showToast('Processing completed!', 'success');
                    resetUploadForm();
                    loadLibrary();
                    navigateTo('library');
                } else if (job.status === 'failed') {
                    clearInterval(statusInterval);
                    statusInterval = null;
                    // Remove from background jobs
                    if (currentJobId && backgroundJobs[currentJobId]) {
                        delete backgroundJobs[currentJobId];
                        updateBackgroundJobsIndicator();
                    }
                    showToast('Processing failed: ' + (job.error || 'Unknown error'), 'error');
                    document.getElementById('processingProgress').style.display = 'none';
                    document.getElementById('processBtn').disabled = false;
                }
            })
            .catch(function(error) {
                console.error('Status check failed:', error);
            });
        }

        function updateProgress(percent, status) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressStatus').textContent = status || 'Processing...';
        }

        function resetUploadForm() {
            clearFile();
            clearUrlSelection();
            currentJobId = null;
            document.getElementById('processingProgress').style.display = 'none';
            document.getElementById('outputName').value = '';
            
            // Reset tabs to file upload
            document.querySelectorAll('.upload-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelector('.upload-tab[data-tab="file"]').classList.add('active');
            document.querySelectorAll('.upload-tab-content').forEach(function(c) { c.classList.remove('active'); });
            document.getElementById('uploadTab-file').classList.add('active');
        }

        // ==================== LIBRARY ====================
        function loadLibrary() {
            fetch('/jobs')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                allTracks = (data.jobs || []).filter(function(job) {
                    return job.status === 'completed';
                });
                renderLibrary();
            })
            .catch(function(error) {
                console.error('Failed to load library:', error);
                showToast('Failed to load library', 'error');
            });
        }

        function renderLibrary(searchQuery) {
            var container = document.getElementById('libraryContent');
            searchQuery = (searchQuery || '').toLowerCase().trim();

            // Filter tracks based on search
            var filteredTracks = allTracks.filter(function(track) {
                if (!searchQuery) return true;
                var name = (track.display_name || track.filename || '').toLowerCase();
                return name.indexOf(searchQuery) !== -1;
            });

            if (filteredTracks.length === 0 && allTracks.length > 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<i class="fas fa-search"></i>' +
                    '<h3>No matches found</h3>' +
                    '<p>Try a different search term</p>' +
                    '</div>';
                return;
            }

            if (allTracks.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<i class="fas fa-folder-open"></i>' +
                    '<h3>No tracks yet</h3>' +
                    '<p>Upload and process your first audio file to get started</p>' +
                    '</div>';
                return;
            }

            var html = '';
            filteredTracks.forEach(function(track) {
                var displayName = track.display_name || track.filename.replace(/\.[^/.]+$/, '');
                var stemCount = Object.keys(track.stems || {}).length;
                var date = new Date(track.created_at).toLocaleDateString();
                var lyricsIndicator = track.has_lyrics ? '<span class="lyrics-badge" title="Lyrics available"><i class="fas fa-closed-captioning"></i></span>' : '';

                html += '<div class="track-item" data-job-id="' + track.job_id + '">' +
                    '<div class="track-artwork"><i class="fas fa-music"></i>' + lyricsIndicator + '</div>' +
                    '<div class="track-info">' +
                    '<div class="track-name">' + displayName + '</div>' +
                    '<div class="track-meta">' + stemCount + ' stems  ' + date + (track.has_lyrics ? '  <i class="fas fa-closed-captioning" style="color: #7c3aed;"></i> Lyrics' : '') + '</div>' +
                    '</div>' +
                    '<div class="track-actions">' +
                    '<button class="icon-btn view-report-btn" title="View Report"><i class="fas fa-eye"></i></button>' +
                    '<button class="icon-btn play-track-btn" title="Play"><i class="fas fa-play"></i></button>' +
                    '<button class="icon-btn edit-btn" title="Edit Name"><i class="fas fa-edit"></i></button>' +
                    '<button class="icon-btn download-track-btn" title="Download All"><i class="fas fa-download"></i></button>' +
                    '<button class="icon-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button>' +
                    '</div>' +
                    '</div>';
            });

            container.innerHTML = html;

            // Attach event listeners
            container.querySelectorAll('.track-item').forEach(function(item) {
                var jobId = item.getAttribute('data-job-id');

                item.querySelector('.view-report-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    openReportModal(jobId);
                });

                item.querySelector('.play-track-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    loadPlayer(jobId);
                });

                item.querySelector('.edit-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    openEditModal(jobId);
                });

                item.querySelector('.download-track-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    downloadAllStems(jobId);
                });

                item.querySelector('.delete-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteTrack(jobId);
                });

                item.addEventListener('click', function() {
                    loadPlayer(jobId);
                });
            });
        }

        // ==================== DELETE TRACK ====================
        function deleteTrack(jobId) {
            var track = allTracks.find(function(t) { return t.job_id === jobId; });
            var trackName = track ? (track.display_name || track.filename) : 'this track';
            
            if (!confirm('Are you sure you want to delete "' + trackName + '"? This action cannot be undone.')) {
                return;
            }
            
            fetch('/delete/' + jobId, {
                method: 'DELETE'
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.error) {
                    showToast('Failed to delete: ' + data.error, 'error');
                    return;
                }
                showToast('Track deleted successfully', 'success');
                loadLibrary();
            })
            .catch(function(err) {
                showToast('Failed to delete track', 'error');
                console.error(err);
            });
        }

        // ==================== TRACK REPORT ====================
        var currentReportJobId = null;

        function openReportModal(jobId) {
            // Guard against undefined jobId
            if (!jobId) {
                console.warn('openReportModal called with undefined jobId');
                return;
            }
            
            currentReportJobId = jobId;
            var modal = document.getElementById('reportModal');
            var body = document.getElementById('reportModalBody');
            
            // Show loading state
            body.innerHTML = '<div class="report-loading"><i class="fas fa-spinner fa-spin"></i> Loading report...</div>';
            modal.classList.add('active');
            
            // Fetch report data
            fetch('/job/' + jobId + '/report')
                .then(function(response) {
                    if (!response.ok) throw new Error('Failed to load report');
                    return response.json();
                })
                .then(function(report) {
                    renderReport(report);
                })
                .catch(function(error) {
                    body.innerHTML = '<div class="report-loading" style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> ' + error.message + '</div>';
                });
        }

        function renderReport(report) {
            var body = document.getElementById('reportModalBody');
            var stemCount = Object.keys(report.stems || {}).length;
            
            // Format dates
            var createdDate = report.created_at ? new Date(report.created_at).toLocaleString() : 'Unknown';
            var completedDate = report.completed_at ? new Date(report.completed_at).toLocaleString() : 'N/A';
            var processingTime = report.processing_time ? report.processing_time.toFixed(1) + 's' : 'N/A';
            
            // Status badge class
            var statusClass = report.status === 'completed' ? 'completed' : (report.status === 'processing' ? 'processing' : 'failed');
            
            var html = '<div class="report-header">' +
                '<div class="report-icon"><i class="fas fa-music"></i></div>' +
                '<div class="report-title-section">' +
                '<h2>' + (report.display_name || 'Unknown Track') + 
                '<span class="report-status ' + statusClass + '">' + report.status + '</span></h2>' +
                '<div class="report-meta">Original: ' + (report.filename || 'Unknown') + '</div>' +
                '</div>' +
                '</div>';
            
            // Stats grid
            html += '<div class="report-grid">' +
                '<div class="report-stat"><div class="report-stat-value">' + stemCount + '</div><div class="report-stat-label">Stems Created</div></div>' +
                '<div class="report-stat"><div class="report-stat-value">' + (report.quality || 'balanced').charAt(0).toUpperCase() + (report.quality || 'balanced').slice(1) + '</div><div class="report-stat-label">Quality</div></div>' +
                '<div class="report-stat"><div class="report-stat-value">' + processingTime + '</div><div class="report-stat-label">Processing Time</div></div>' +
                '<div class="report-stat"><div class="report-stat-value">' + (report.has_lyrics ? '<i class="fas fa-check" style="color: var(--success);"></i>' : '<i class="fas fa-times" style="color: var(--text-dim);"></i>') + '</div><div class="report-stat-label">Lyrics</div></div>' +
                '</div>';
            
            // Music Analysis Section
            if (report.music_info && (report.music_info.tempo || report.music_info.key)) {
                html += '<div class="report-section">' +
                    '<div class="report-section-title"><i class="fas fa-headphones"></i> Audio Analysis</div>' +
                    '<div class="report-music-info">';
                
                if (report.music_info.tempo) {
                    html += '<div class="report-music-item">' +
                        '<div class="report-music-value">' + Math.round(report.music_info.tempo.bpm) + '</div>' +
                        '<div class="report-music-label">BPM</div>' +
                        '</div>';
                }
                
                if (report.music_info.key) {
                    html += '<div class="report-music-item">' +
                        '<div class="report-music-value">' + report.music_info.key.key + ' ' + report.music_info.key.scale + '</div>' +
                        '<div class="report-music-label">Key</div>' +
                        '</div>';
                    
                    if (report.music_info.key.camelot) {
                        html += '<div class="report-music-item">' +
                            '<div class="report-music-value">' + report.music_info.key.camelot + '</div>' +
                            '<div class="report-music-label">Camelot</div>' +
                            '</div>';
                    }
                }
                
                if (report.music_info.duration) {
                    var mins = Math.floor(report.music_info.duration / 60);
                    var secs = Math.floor(report.music_info.duration % 60);
                    html += '<div class="report-music-item">' +
                        '<div class="report-music-value">' + mins + ':' + (secs < 10 ? '0' : '') + secs + '</div>' +
                        '<div class="report-music-label">Duration</div>' +
                        '</div>';
                }
                
                html += '</div></div>';
            }
            
            // Stems Section
            if (stemCount > 0) {
                html += '<div class="report-section">' +
                    '<div class="report-section-title"><i class="fas fa-layer-group"></i> Generated Stems</div>' +
                    '<div class="report-stems-list">';
                
                var stemIcons = {
                    'vocals': 'fa-microphone',
                    'drums': 'fa-drum',
                    'bass': 'fa-guitar',
                    'guitar': 'fa-guitar',
                    'piano': 'fa-music',
                    'other': 'fa-sliders-h',
                    'instrumental': 'fa-headphones'
                };
                
                Object.keys(report.stems).forEach(function(stemName) {
                    var stem = report.stems[stemName];
                    var icon = stemIcons[stemName] || 'fa-file-audio';
                    var fileSize = stem.file_size ? formatFileSize(stem.file_size) : 'Unknown size';
                    var duration = stem.duration ? formatDuration(stem.duration) : '';
                    
                    html += '<div class="report-stem-item">' +
                        '<div class="report-stem-icon ' + stemName + '"><i class="fas ' + icon + '"></i></div>' +
                        '<div class="report-stem-info">' +
                        '<div class="report-stem-name">' + stemName + '</div>' +
                        '<div class="report-stem-meta">' + (stem.format || 'MP3') + '  ' + fileSize + (duration ? '  ' + duration : '') + '</div>' +
                        '</div>' +
                        '</div>';
                });
                
                html += '</div></div>';
            }
            
            // Processing Details
            html += '<div class="report-section">' +
                '<div class="report-section-title"><i class="fas fa-cog"></i> Processing Details</div>' +
                '<div class="report-details">' +
                '<div class="report-detail-item"><span class="report-detail-label">Job ID</span><span class="report-detail-value" style="font-family: monospace; font-size: 11px;">' + report.job_id + '</span></div>' +
                '<div class="report-detail-item"><span class="report-detail-label">Mode</span><span class="report-detail-value">' + (report.mode || 'grouped') + '</span></div>' +
                '<div class="report-detail-item"><span class="report-detail-label">Created</span><span class="report-detail-value">' + createdDate + '</span></div>' +
                '<div class="report-detail-item"><span class="report-detail-label">Completed</span><span class="report-detail-value">' + completedDate + '</span></div>' +
                '</div></div>';
            
            body.innerHTML = html;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function formatDuration(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
            currentReportJobId = null;
        }

        function downloadReport() {
            // For now, show a message - PDF export can be added later
            showToast('PDF export coming soon!', 'info');
        }

        // ==================== EDIT TRACK NAME ====================
        function openEditModal(jobId) {
            var track = allTracks.find(function(t) { return t.job_id === jobId; });
            if (!track) return;
            
            var currentName = track.display_name || track.filename.replace(/\.[^/.]+$/, '');
            document.getElementById('editTrackName').value = currentName;
            document.getElementById('editTrackJobId').value = jobId;
            document.getElementById('editModal').classList.add('active');
            document.getElementById('editTrackName').focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveTrackName() {
            var jobId = document.getElementById('editTrackJobId').value;
            var newName = document.getElementById('editTrackName').value.trim();
            
            if (!newName) {
                showToast('Please enter a name', 'error');
                return;
            }
            
            fetch('/rename/' + jobId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: newName})
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.error) {
                    showToast('Failed to rename: ' + data.error, 'error');
                    return;
                }
                showToast('Track renamed successfully', 'success');
                closeEditModal();
                loadLibrary();
            })
            .catch(function(err) {
                showToast('Failed to rename track', 'error');
                console.error(err);
            });
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditModal();
                closeReportModal();
            }
            // Spacebar to play/pause (only when not typing in an input)
            if (e.key === ' ' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault(); // Prevent page scroll
                if (Object.keys(wavesurfers).length > 0) {
                    togglePlayAll();
                }
            }
        });

        // ==================== PLAYER ====================
        function loadPlayer(jobId) {
            // Guard against undefined jobId
            if (!jobId) {
                console.warn('loadPlayer called with undefined jobId');
                return;
            }
            
            console.log('loadPlayer called with jobId:', jobId);
            
            var track = null;
            for (var i = 0; i < allTracks.length; i++) {
                // Match by job_id or id
                if (allTracks[i].job_id === jobId || allTracks[i].id === jobId) {
                    track = allTracks[i];
                    break;
                }
            }

            console.log('Found track:', track);
            
            if (!track) {
                showToast('Track not found', 'error');
                return;
            }

            // Cleanup previous wavesurfers and state
            cleanupPlayer();
            currentTrack = track;
            currentJobId = jobId;  // Set currentJobId for karaoke sync

            var displayName = track.display_name || track.filename.replace(/\.[^/.]+$/, '');
            var stems = track.stems || {};
            
            console.log('Track stems:', stems);
            
            // Filter out invalid stems (pitch-shifted cache files, etc.)
            // Include all possible Demucs output stems + original for URL downloads
            var validStemTypes = ['vocals', 'drums', 'bass', 'guitar', 'piano', 'other', 'instrumental', 'synth', 'strings', 'melody', 'accompaniment', 'percussion', 'lead', 'background', 'original'];
            var stemKeys = Object.keys(stems).filter(function(key) {
                return validStemTypes.indexOf(key.toLowerCase()) !== -1 && 
                       key.indexOf('pitch') === -1 && 
                       key.indexOf('+') === -1 &&
                       key.indexOf('.') === -1;
            });

            console.log('Filtered stemKeys:', stemKeys);

            if (stemKeys.length === 0) {
                showToast('No stems available for this track', 'error');
                return;
            }

            // Build player UI with global timeline and controls
            var playerContent = document.getElementById('playerContent');
            playerContent.innerHTML = '<div class="player-container">' +
                '<div class="player-header">' +
                '<div class="now-playing"><i class="fas fa-music"></i> ' + displayName + '</div>' +
                '<button class="btn btn-secondary" id="downloadAllBtn"><i class="fas fa-download"></i> Download All</button>' +
                '</div>' +
                
                // Music Info Panel (tempo, key, time signature)
                '<div class="music-info-panel" id="musicInfoPanel">' +
                '<div class="music-info-card">' +
                '<div class="music-info-icon tempo"><i class="fas fa-heartbeat"></i></div>' +
                '<div><div class="music-info-value" id="tempoValue">--</div><div class="music-info-label">BPM</div><div class="music-info-confidence" id="tempoConfidence"></div></div>' +
                '</div>' +
                '<div class="music-info-card">' +
                '<div class="music-info-icon key"><i class="fas fa-music"></i></div>' +
                '<div><div class="music-info-value" id="keyValue">--</div><div class="music-info-label">Key</div><div class="music-info-confidence" id="keyConfidence"></div></div>' +
                '</div>' +
                '<div class="music-info-card">' +
                '<div class="music-info-icon time"><i class="fas fa-clock"></i></div>' +
                '<div><div class="music-info-value" id="timeSigValue">--</div><div class="music-info-label">Time Sig</div></div>' +
                '</div>' +
                '</div>' +
                
                // Global Timeline
                '<div class="global-timeline">' +
                '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                '<div style="display: flex; align-items: center; gap: 10px;">' +
                '<span class="timeline-label">TIMELINE</span>' +
                '<span class="sync-indicator" id="globalSyncIndicator" title="Global sync status"></span>' +
                '<span class="drift-display" id="globalDrift"></span>' +
                '</div>' +
                '<div class="time-display">' +
                '<span class="current" id="currentTime">00:00</span>' +
                '<span class="ms" id="currentMs">.000</span>' +
                ' / ' +
                '<span id="totalTime">00:00</span>' +
                '<span class="ms" id="totalMs">.000</span>' +
                '</div>' +
                '</div>' +
                '<div class="timeline-bar" id="globalTimeline">' +
                '<div class="timeline-progress" id="timelineProgress"></div>' +
                '<div class="timeline-cursor" id="timelineCursor" style="left: 0%"></div>' +
                '</div>' +
                '</div>' +
                
                // Master Controls
                '<div class="master-controls">' +
                '<button class="icon-btn" id="skipStartBtn" title="Go to Start"><i class="fas fa-step-backward"></i></button>' +
                '<button class="icon-btn" id="skipBackBtn" title="Back 5s"><i class="fas fa-backward"></i></button>' +
                '<button class="play-btn" id="masterPlayBtn"><i class="fas fa-play"></i></button>' +
                '<button class="icon-btn" id="skipForwardBtn" title="Forward 5s"><i class="fas fa-forward"></i></button>' +
                '<button class="icon-btn" id="skipEndBtn" title="Go to End"><i class="fas fa-step-forward"></i></button>' +
                '<div style="width: 1px; height: 30px; background: rgba(255,255,255,0.2); margin: 0 15px;"></div>' +
                '<button class="icon-btn" id="syncBtn" title="Sync All Tracks" style="background: var(--primary);"><i class="fas fa-link"></i></button>' +
                '</div>' +
                
                // Pitch Control (real-time transposition)
                '<div class="pitch-control">' +
                '<label><i class="fas fa-music"></i> Transpose</label>' +
                '<span class="pitch-value" id="pitchDown">-4</span>' +
                '<input type="range" class="pitch-slider" id="pitchSlider" min="-4" max="4" step="0.5" value="0">' +
                '<span class="pitch-value" id="pitchUp">+4</span>' +
                '<span class="pitch-value" id="pitchValue" style="min-width: 70px;">0 st</span>' +
                '<button class="pitch-reset" id="pitchReset"><i class="fas fa-undo"></i> Reset</button>' +
                '</div>' +
                
                // Lyrics Controls
                '<div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">' +
                '<button class="btn extract-lyrics-btn" id="extractLyricsBtn">' +
                '<i class="fas fa-microphone-alt"></i> Extract Lyrics' +
                '</button>' +
                '<select class="language-select" id="lyricsLanguage">' +
                '<option value="auto">Auto Detect</option>' +
                '<option value="en">English</option>' +
                '<option value="ar">Arabic</option>' +
                '<option value="fr">French</option>' +
                '<option value="es">Spanish</option>' +
                '</select>' +
                '<select class="language-select" id="lyricsModel" title="Model Quality">' +
                '<option value="medium"> Fast (~30s)</option>' +
                '<option value="large"> Quality (~2min)</option>' +
                '</select>' +
                '<button class="btn btn-secondary" id="toggleLyricsBtn" style="display: none;">' +
                '<i class="fas fa-closed-captioning"></i> Show Lyrics' +
                '</button>' +
                '<button class="btn btn-secondary" id="editLyricsBtn" style="display: none;">' +
                '<i class="fas fa-edit"></i> Edit Lyrics' +
                '</button>' +
                '<button class="btn btn-secondary" id="karaokeLyricsBtn" style="display: none;">' +
                '<i class="fas fa-tv"></i> Karaoke View' +
                '</button>' +
                '</div>' +
                
                // Lyrics Panel (hidden initially)
                '<div class="lyrics-panel" id="lyricsPanel" style="display: none;">' +
                '<div class="lyrics-header">' +
                '<div class="lyrics-title"><i class="fas fa-music"></i> Lyrics</div>' +
                '<div class="lyrics-controls">' +
                '<span id="lyricsLanguageDisplay" class="lyrics-language-badge"></span>' +
                '</div>' +
                '</div>' +
                '<div id="playerLyricsContent"></div>' +
                '</div>' +
                
                '<div class="stems-container" id="stemsContainer"></div>' +
                '</div>';

            // Add stem tracks with mute/solo buttons
            var stemsContainer = document.getElementById('stemsContainer');

            stemKeys.forEach(function(stemName) {
                var safeId = sanitizeStemId(stemName);
                var stemDiv = document.createElement('div');
                stemDiv.className = 'stem-track';
                stemDiv.id = 'stem-track-' + safeId;
                stemDiv.innerHTML = '<div class="stem-header">' +
                    '<div class="stem-name">' +
                    '<button class="mute-btn" data-stem="' + stemName + '" title="Mute">M</button>' +
                    '<button class="solo-btn" data-stem="' + stemName + '" title="Solo">S</button>' +
                    '<span>' + stemName.toUpperCase() + '</span>' +
                    '<span class="stem-time" id="time-' + safeId + '">00:00.000</span>' +
                    '<span class="sync-indicator" id="sync-' + safeId + '" title="Sync status"></span>' +
                    '<span class="drift-display" id="drift-' + safeId + '"></span>' +
                    '</div>' +
                    '<div class="stem-controls">' +
                    '<i class="fas fa-volume-down" style="color: #666; font-size: 12px;"></i>' +
                    '<input type="range" class="volume-slider" data-stem="' + stemName + '" min="0" max="100" value="100">' +
                    '<i class="fas fa-volume-up" style="color: #666; font-size: 12px;"></i>' +
                    '<button class="icon-btn convert-midi-btn" data-stem="' + stemName + '" title="Convert to MIDI" style="background: linear-gradient(135deg, var(--primary), var(--secondary));"><i class="fas fa-file-audio"></i></button>' +
                    '<button class="icon-btn download-stem-btn" data-stem="' + stemName + '" title="Download"><i class="fas fa-download"></i></button>' +
                    '</div>' +
                    '</div>' +
                    '<div class="waveform-container" id="waveform-' + safeId + '"></div>';
                stemsContainer.appendChild(stemDiv);
            });

            // Initialize WaveSurfer instances after DOM is ready
            setTimeout(function() {
                var loadedCount = 0;
                var totalStems = stemKeys.length;

                stemKeys.forEach(function(stemName) {
                    try {
                        var safeId = sanitizeStemId(stemName);
                        var ws = WaveSurfer.create({
                            container: '#waveform-' + safeId,
                            waveColor: getStemColor(stemName),
                            progressColor: getStemProgressColor(stemName),
                            cursorColor: '#fff',
                            barWidth: 2,
                            barRadius: 2,
                            height: 60,
                            normalize: true,
                            interact: true
                        });

                        ws.load(currentTrack.stems[stemName] || '/download/' + jobId + '/' + stemName);

                        ws.on('ready', function() {
                            loadedCount++;
                            var duration = ws.getDuration();
                            if (duration > masterDuration) {
                                masterDuration = duration;
                                updateTotalTime(duration);
                            }
                            
                            if (loadedCount === totalStems) {
                                showToast('All stems loaded - ready to play!', 'success');
                                startTimeUpdates();
                            }
                        });

                        // Handle end of playback
                        ws.on('finish', function() {
                            // Check if ALL wavesurfers have finished
                            var allFinished = true;
                            Object.values(wavesurfers).forEach(function(otherWs) {
                                if (otherWs && otherWs.isPlaying && otherWs.isPlaying()) {
                                    allFinished = false;
                                }
                            });
                            
                            if (allFinished && isPlaying) {
                                // Reset to beginning
                                pausedAt = 0;
                                masterTime = 0;
                                isPlaying = false;
                                document.getElementById('masterPlayBtn').querySelector('i').className = 'fas fa-play';
                                updateTimeDisplay(0);
                                updateTimelineVisual(0);
                                
                                // Reset all to beginning
                                Object.keys(wavesurfers).forEach(function(k) {
                                    try { wavesurfers[k].seekTo(0); } catch(e) {}
                                });
                            }
                        });

                        // Click on waveform seeks all tracks
                        // Use 'interaction' event for click-to-seek (more reliable than 'seeking')
                        ws.on('interaction', function() {
                            if (!isSeeking) {
                                var progress = ws.getCurrentTime() / ws.getDuration();
                                debugLog('WAVEFORM', ' Waveform clicked: ' + stemName + ' at ' + (progress * 100).toFixed(1) + '%');
                                syncAllToPosition(progress);
                            }
                        });

                        ws.on('error', function(err) {
                            console.error('WaveSurfer error for ' + stemName + ':', err);
                        });

                        wavesurfers[stemName] = ws;
                    } catch (err) {
                        console.error('Failed to create waveform for ' + stemName + ':', err);
                    }
                });

                // Attach control events
                attachPlayerControls(jobId, stemKeys);
            }, 200);

            // Navigate to stems section and switch to player tab
            navigateTo('stems');
            switchStemsTab('player');
            showToast('Loading track...');
        }

        function cleanupPlayer() {
            // Stop animation loop
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // Destroy wavesurfers
            Object.keys(wavesurfers).forEach(function(key) {
                try { wavesurfers[key].destroy(); } catch(e) {}
            });
            
            // Cleanup Tone.js players and pitch shifters
            cleanupTonePlayers();
            
            // Reset state
            wavesurfers = {};
            isPlaying = false;
            masterDuration = 0;
            masterTime = 0;
            pausedAt = 0;
            masterStartTime = 0;
            lastSyncCheck = 0;
            soloStems.clear();
            mutedStems.clear();
            currentPitch = 0;
        }

        // Sanitize stem name for use in CSS selectors and IDs
        function sanitizeStemId(stemName) {
            // Replace special characters that are invalid in CSS selectors
            return stemName.replace(/[+.\/\\#%&?=:;'"<>|*^$!@()[\]{}]/g, '_');
        }

        function getStemColor(stemName) {
            var colors = {
                vocals: '#ef4444',
                drums: '#f59e0b',
                bass: '#9b59b6',
                guitar: '#3498db',
                piano: '#1abc9c',
                other: '#95a5a6',
                original: '#7c3aed',
                instrumental: '#27ae60'
            };
            return colors[stemName.toLowerCase()] || '#7c3aed';
        }

        function getStemProgressColor(stemName) {
            var colors = {
                vocals: '#c0392b',
                drums: '#d35400',
                bass: '#8e44ad',
                guitar: '#2980b9',
                piano: '#16a085',
                other: '#7f8c8d',
                original: '#7c3aed',
                instrumental: '#1e8449'
            };
            return colors[stemName.toLowerCase()] || '#7c3aed';
        }

        function attachPlayerControls(jobId, stemKeys) {
            // Master play/pause
            document.getElementById('masterPlayBtn').addEventListener('click', togglePlayAll);

            // Skip controls
            document.getElementById('skipStartBtn').addEventListener('click', function() {
                syncAllToTime(0);
            });

            document.getElementById('skipBackBtn').addEventListener('click', function() {
                var newTime = Math.max(0, masterTime - 5);
                syncAllToTime(newTime);
            });

            document.getElementById('skipForwardBtn').addEventListener('click', function() {
                var newTime = Math.min(masterDuration, masterTime + 5);
                syncAllToTime(newTime);
            });

            document.getElementById('skipEndBtn').addEventListener('click', function() {
                syncAllToTime(masterDuration);
            });

            // Sync button
            document.getElementById('syncBtn').addEventListener('click', function() {
                debugLog('UI', ' Manual sync button clicked');
                syncAllToTime(masterTime);
                showToast('All tracks synced!', 'success');
            });

            // Global timeline seek
            var timeline = document.getElementById('globalTimeline');
            var cursor = document.getElementById('timelineCursor');
            
            timeline.addEventListener('click', function(e) {
                var rect = timeline.getBoundingClientRect();
                var progress = (e.clientX - rect.left) / rect.width;
                progress = Math.max(0, Math.min(1, progress));
                debugLog('TIMELINE', ' Timeline clicked at ' + (progress * 100).toFixed(1) + '%');
                syncAllToPosition(progress);
            });

            // Draggable cursor
            var isDragging = false;
            
            cursor.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.preventDefault();
                debugLog('TIMELINE', ' Started dragging cursor');
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                var rect = timeline.getBoundingClientRect();
                var progress = (e.clientX - rect.left) / rect.width;
                progress = Math.max(0, Math.min(1, progress));
                updateTimelineVisual(progress);
                // Update time display while dragging (preview)
                var previewTime = progress * masterDuration;
                updateTimeDisplay(previewTime);
            });

            document.addEventListener('mouseup', function(e) {
                if (isDragging) {
                    isDragging = false;
                    var rect = timeline.getBoundingClientRect();
                    var progress = (e.clientX - rect.left) / rect.width;
                    progress = Math.max(0, Math.min(1, progress));
                    debugLog('TIMELINE', ' Finished dragging at ' + (progress * 100).toFixed(1) + '%');
                    syncAllToPosition(progress);
                }
            });

            // Download all
            document.getElementById('downloadAllBtn').addEventListener('click', function() {
                downloadAllStems(jobId);
            });

            // Mute buttons
            document.querySelectorAll('.mute-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var stemName = btn.getAttribute('data-stem');
                    toggleMute(stemName);
                });
            });

            // Solo buttons
            document.querySelectorAll('.solo-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var stemName = btn.getAttribute('data-stem');
                    toggleSolo(stemName);
                });
            });

            // Volume sliders
            document.querySelectorAll('.volume-slider').forEach(function(slider) {
                slider.addEventListener('input', function() {
                    var stemName = slider.getAttribute('data-stem');
                    var ws = wavesurfers[stemName];
                    if (ws && !mutedStems.has(stemName)) {
                        ws.setVolume(slider.value / 100);
                    }
                    // Also update Tone.js player volume if pitch shifting is active
                    if (toneInitialized && tonePlayers[stemName]) {
                        var player = tonePlayers[stemName];
                        var volumePercent = slider.value / 100;
                        if (volumePercent <= 0 || mutedStems.has(stemName)) {
                            player.volume.value = -Infinity;
                        } else {
                            player.volume.value = 20 * Math.log10(volumePercent);
                        }
                    }
                });
            });

            // Individual download buttons
            document.querySelectorAll('.download-stem-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var stemName = btn.getAttribute('data-stem');
                    downloadStem(jobId, stemName);
                });
            });
            
            // Convert to MIDI buttons
            document.querySelectorAll('.convert-midi-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var stemName = btn.getAttribute('data-stem');
                    var stemUrl = currentTrack.stems[stemName] || '/download/' + jobId + '/' + stemName;
                    convertStemToMidi(stemUrl, stemName);
                });
            });

            // Pitch slider - Real-time pitch control with Tone.js
            var pitchSlider = document.getElementById('pitchSlider');
            var pitchValue = document.getElementById('pitchValue');
            var pitchReset = document.getElementById('pitchReset');
            var currentStemKeys = stemKeys; // Store for later use
            
            pitchSlider.addEventListener('input', async function() {
                var semitones = parseFloat(pitchSlider.value);
                currentPitch = semitones;
                var sign = semitones > 0 ? '+' : '';
                pitchValue.textContent = sign + semitones + ' st';
                
                // Initialize Tone.js on first pitch change (requires user gesture)
                if (semitones !== 0 && !toneInitialized) {
                    pitchValue.textContent = 'Loading...';
                    var success = await ensureToneInitialized(jobId, currentStemKeys);
                    if (success) {
                        pitchValue.textContent = sign + semitones + ' st';
                    } else {
                        pitchSlider.value = 0;
                        currentPitch = 0;
                        pitchValue.textContent = '0 st';
                        return;
                    }
                }
                
                // Apply pitch shift immediately (real-time)
                applyRealtimePitch(semitones);
            });
            
            pitchReset.addEventListener('click', function() {
                pitchSlider.value = 0;
                currentPitch = 0;
                pitchValue.textContent = '0 st';
                applyRealtimePitch(0);
                showToast('Pitch reset to original');
            });

            // Lyrics extraction
            document.getElementById('extractLyricsBtn').addEventListener('click', function() {
                var language = document.getElementById('lyricsLanguage').value;
                var model = document.getElementById('lyricsModel').value;
                extractLyrics(jobId, language, model);
            });
            
            // Toggle lyrics display
            document.getElementById('toggleLyricsBtn').addEventListener('click', function() {
                toggleLyricsPanel();
            });
            
            // Edit lyrics button
            document.getElementById('editLyricsBtn').addEventListener('click', function() {
                openLyricsEditor();
            });
            
            // Karaoke view button
            document.getElementById('karaokeLyricsBtn').addEventListener('click', function() {
                openKaraokePage();
            });
            
            // Check for existing lyrics
            checkExistingLyrics(jobId);

            // Fetch and display music analysis
            fetchMusicAnalysis(jobId);
        }
        
        // ==================== REAL-TIME PITCH SHIFT (Tone.js) ====================
        // Store Tone.js players and pitch shifters for each stem
        var tonePlayers = {};
        var pitchShifters = {};
        var toneInitialized = false;
        
        function initToneForStem(stemName, audioUrl) {
            return new Promise(function(resolve, reject) {
                try {
                    // Create a Tone.js Player for this stem
                    var player = new Tone.Player({
                        url: audioUrl,
                        onload: function() {
                            // Create high-quality pitch shifter with optimized settings
                            // windowSize: larger = smoother but more latency (default 0.1)
                            // delayTime: affects the delay of the effect
                            // feedback: should be 0 for pure pitch shift
                            var pitchShift = new Tone.PitchShift({
                                pitch: 0,
                                windowSize: 0.15,      // Larger window for smoother sound
                                delayTime: 0,          // No additional delay
                                feedback: 0,           // No feedback (pure pitch shift)
                                wet: 1                 // 100% wet signal
                            });
                            
                            // Add a limiter to prevent clipping from pitch shifting
                            var limiter = new Tone.Limiter(-1);
                            
                            // Connect: Player -> PitchShift -> Limiter -> Destination
                            player.connect(pitchShift);
                            pitchShift.connect(limiter);
                            limiter.toDestination();
                            
                            tonePlayers[stemName] = player;
                            pitchShifters[stemName] = {
                                shifter: pitchShift,
                                limiter: limiter
                            };
                            
                            resolve();
                        },
                        onerror: function(err) {
                            console.error('Failed to load audio for Tone.js:', err);
                            reject(err);
                        }
                    });
                } catch (e) {
                    reject(e);
                }
            });
        }
        
        function applyRealtimePitch(semitones) {
            // Apply pitch shift to all Tone.js pitch shifters
            Object.keys(pitchShifters).forEach(function(stemName) {
                var pitchData = pitchShifters[stemName];
                if (pitchData && pitchData.shifter) {
                    // Smoothly ramp to the new pitch value to avoid clicks
                    pitchData.shifter.pitch = semitones;
                }
            });
            
            // Update Tone.js player volumes based on mute/solo state
            updateTonePlayerVolumes();
            
            // Also adjust WaveSurfer display (keep speed normal for visual sync)
            Object.keys(wavesurfers).forEach(function(stemName) {
                var ws = wavesurfers[stemName];
                if (ws && ws.getMediaElement) {
                    var media = ws.getMediaElement();
                    if (media) {
                        // Keep playback at normal speed for visual timeline
                        media.playbackRate = 1.0;
                        media.preservesPitch = true;
                        // Mute the HTML5 audio only when Tone.js is active and pitch is shifted
                        // When pitch is 0 and Tone.js is not used, let WaveSurfer handle audio
                        if (Object.keys(tonePlayers).length > 0 && semitones !== 0) {
                            media.muted = true;
                        } else if (semitones === 0) {
                            // Restore WaveSurfer audio when pitch is reset to 0
                            // Respect the mixer mute state
                            media.muted = false;
                        }
                    }
                }
            });
        }
        
        // Initialize Tone.js when pitch is first changed from 0
        async function ensureToneInitialized(jobId, stemKeys) {
            if (toneInitialized) return true;
            
            try {
                // Configure Tone.js for high quality audio
                // Use 'playback' latency hint for better quality (vs 'interactive' for lower latency)
                Tone.context.latencyHint = 'playback';
                
                // Start Tone.js audio context (requires user gesture)
                await Tone.start();
                console.log('Tone.js started with sample rate:', Tone.context.sampleRate);
                
                // Initialize players for each stem
                var initPromises = stemKeys.map(function(stemName) {
                    var audioUrl = currentTrack.stems[stemName] || '/download/' + jobId + '/' + stemName;
                    return initToneForStem(stemName, audioUrl);
                });
                
                await Promise.all(initPromises);
                toneInitialized = true;
                
                // Mute WaveSurfer audio elements
                Object.keys(wavesurfers).forEach(function(stemName) {
                    var ws = wavesurfers[stemName];
                    if (ws && ws.getMediaElement) {
                        ws.getMediaElement().muted = true;
                    }
                });
                
                showToast('Pitch shift ready!', 'success');
                return true;
            } catch (e) {
                console.error('Failed to initialize Tone.js:', e);
                showToast('Pitch shift not available', 'error');
                return false;
            }
        }
        
        // Update Tone.js player volumes based on mixer mute/solo state
        function updateTonePlayerVolumes() {
            var hasSolo = soloStems.size > 0;
            
            Object.keys(tonePlayers).forEach(function(stemName) {
                var player = tonePlayers[stemName];
                if (!player) return;
                
                var slider = document.querySelector('.volume-slider[data-stem="' + stemName + '"');
                var shouldBeMuted = mutedStems.has(stemName);
                var shouldBeSilent = hasSolo && !soloStems.has(stemName);
                
                if (shouldBeMuted || shouldBeSilent) {
                    // Mute this Tone.js player
                    player.volume.value = -Infinity;
                } else {
                    // Set volume based on slider (convert 0-100 to dB, where 100 = 0dB)
                    var volumePercent = slider ? slider.value / 100 : 1;
                    // Convert to dB: 0% = -Infinity, 100% = 0dB
                    if (volumePercent <= 0) {
                        player.volume.value = -Infinity;
                    } else {
                        player.volume.value = 20 * Math.log10(volumePercent);
                    }
                }
            });
        }
        
        // Play/pause Tone.js players along with WaveSurfer
        function playTonePlayers() {
            // First update volumes based on mute/solo state
            updateTonePlayerVolumes();
            
            Object.keys(tonePlayers).forEach(function(stemName) {
                var player = tonePlayers[stemName];
                if (player && player.loaded && player.state !== 'started') {
                    player.start();
                }
            });
        }
        
        function pauseTonePlayers() {
            Object.keys(tonePlayers).forEach(function(stemName) {
                var player = tonePlayers[stemName];
                if (player) {
                    player.stop();
                }
            });
        }
        
        function cleanupTonePlayers() {
            Object.keys(tonePlayers).forEach(function(stemName) {
                var player = tonePlayers[stemName];
                if (player) {
                    player.dispose();
                }
            });
            Object.keys(pitchShifters).forEach(function(stemName) {
                var pitchData = pitchShifters[stemName];
                if (pitchData) {
                    if (pitchData.shifter) pitchData.shifter.dispose();
                    if (pitchData.limiter) pitchData.limiter.dispose();
                }
            });
            tonePlayers = {};
            pitchShifters = {};
            toneInitialized = false;
        }
        
        // ==================== LYRICS ====================
        function extractLyrics(jobId, language, model) {
            var btn = document.getElementById('extractLyricsBtn');
            btn.disabled = true;
            var modelLabel = model === 'large' ? 'Quality' : 'Fast';
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting (' + modelLabel + ')...';
            
            var timeEstimate = model === 'large' ? '1-2 minutes' : '20-40 seconds';
            showToast('Extracting lyrics with ' + modelLabel + ' model (est. ' + timeEstimate + ')...');
            
            fetch('/extract-lyrics/' + jobId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({language: language || 'auto', model: model || 'medium'})
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-microphone-alt"></i> Extract Lyrics';
                
                if (data.error) {
                    showToast('Lyrics extraction failed: ' + data.error, 'error');
                    return;
                }
                
                currentLyrics = data;
                displayLyrics(data);
                document.getElementById('toggleLyricsBtn').style.display = 'inline-flex';
                document.getElementById('editLyricsBtn').style.display = 'inline-flex';
                // Show karaoke button when lyrics are available
                document.getElementById('karaokeLyricsBtn').style.display = 'inline-flex';
                document.getElementById('lyricsPanel').style.display = 'block';
                showToast('Lyrics extracted successfully!', 'success');
            })
            .catch(function(err) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-microphone-alt"></i> Extract Lyrics';
                showToast('Failed to extract lyrics', 'error');
                console.error(err);
            });
        }
        
        function checkExistingLyrics(jobId) {
            fetch('/lyrics/' + jobId)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data && data.available && !data.error) {
                    currentLyrics = data;
                    displayLyrics(data);
                    document.getElementById('toggleLyricsBtn').style.display = 'inline-flex';
                    document.getElementById('editLyricsBtn').style.display = 'inline-flex';
                    // Show karaoke button when lyrics are available
                    document.getElementById('karaokeLyricsBtn').style.display = 'inline-flex';
                } else if (currentTrack && currentTrack.mode === 'karaoke') {
                    // Auto-extract lyrics for karaoke mode if not available
                    showToast('Extracting lyrics for karaoke mode...', 'info');
                    extractLyrics(jobId);
                }
            })
            .catch(function() {
                // If lyrics check failed and it's karaoke mode, try extracting
                if (currentTrack && currentTrack.mode === 'karaoke') {
                    extractLyrics(jobId);
                }
            });
        }
        
        function displayLyrics(data) {
            var content = document.getElementById('playerLyricsContent');
            var langDisplay = document.getElementById('lyricsLanguageDisplay');
            
            langDisplay.textContent = 'Language: ' + (data.language || 'Unknown').toUpperCase();
            
            var html = '';
            if (data.lines && data.lines.length > 0) {
                data.lines.forEach(function(line, idx) {
                    html += '<div class="lyrics-line" data-start="' + line.start + '" data-end="' + line.end + '" data-idx="' + idx + '">';
                    
                    // If word-level timing available
                    if (line.words && line.words.length > 0) {
                        line.words.forEach(function(word) {
                            html += '<span class="word" data-start="' + word.start + '" data-end="' + word.end + '">' + (word.word || word.text || '') + '</span> ';
                        });
                    } else {
                        html += line.text;
                    }
                    
                    html += '</div>';
                });
            } else {
                html = '<p style="color: #666; text-align: center;">No lyrics found</p>';
            }
            
            content.innerHTML = html;
        }
        
        function toggleLyricsPanel() {
            var panel = document.getElementById('lyricsPanel');
            var btn = document.getElementById('toggleLyricsBtn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-closed-captioning"></i> Hide Lyrics';
                lyricsVisible = true;
            } else {
                panel.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-closed-captioning"></i> Show Lyrics';
                lyricsVisible = false;
            }
        }
        
        function updateLyricsHighlight(time) {
            if (!currentLyrics || !lyricsVisible) return;
            
            var lines = document.querySelectorAll('.lyrics-line');
            lines.forEach(function(line) {
                var start = parseFloat(line.dataset.start);
                var end = parseFloat(line.dataset.end);
                
                line.classList.remove('current', 'past');
                
                if (time >= start && time <= end) {
                    line.classList.add('current');
                    
                    // Scroll into view
                    line.scrollIntoView({behavior: 'smooth', block: 'center'});
                    
                    // Highlight words
                    var words = line.querySelectorAll('.word');
                    words.forEach(function(word) {
                        var wordStart = parseFloat(word.dataset.start);
                        var wordEnd = parseFloat(word.dataset.end);
                        
                        word.classList.remove('highlight');
                        if (time >= wordStart && time <= wordEnd) {
                            word.classList.add('highlight');
                        }
                    });
                } else if (time > end) {
                    line.classList.add('past');
                }
            });
            
            // Sync to karaoke page via localStorage
            syncPlayerState(time);
        }
        
        // ==================== PLAYER SYNC FOR KARAOKE ====================
        function syncPlayerState(time) {
            if (!currentJobId) return;
            
            var duration = 0;
            // Get duration from first stem
            var firstStem = Object.values(stemPlayers)[0];
            if (firstStem && firstStem.getDuration) {
                duration = firstStem.getDuration();
            }
            
            var syncData = {
                jobId: currentJobId,
                currentTime: time,
                duration: duration,
                isPlaying: !isPaused,
                timestamp: Date.now()
            };
            
            localStorage.setItem('harmonix_player_sync', JSON.stringify(syncData));
        }
        
        // ==================== MODAL HELPERS ====================
        function openModal(modalId) {
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeModal(modalId) {
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }
        
        // Initialize modal close buttons
        (function initModalCloseButtons() {
            // Close on X button click
            document.querySelectorAll('[data-modal-close]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            // Close on backdrop click
            document.querySelectorAll('.modal').forEach(function(modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(function(modal) {
                        closeModal(modal.id);
                    });
                }
            });
        })();
        
        // ==================== LYRICS EDITOR ====================
        function openLyricsEditor() {
            if (!currentLyrics || !currentLyrics.lines) {
                showToast('No lyrics to edit. Extract lyrics first.', 'error');
                return;
            }
            
            renderLyricsEditor();
            openModal('lyricsEditorModal');
        }
        
        function renderLyricsEditor() {
            var container = document.getElementById('lyricsEditorContainer');
            var langBadge = document.getElementById('editorLanguageBadge');
            
            if (langBadge && currentLyrics.language) {
                langBadge.textContent = currentLyrics.language.toUpperCase();
            }
            
            var html = '';
            currentLyrics.lines.forEach(function(line, lineIdx) {
                html += '<div class="editor-line" data-line-idx="' + lineIdx + '">';
                
                // Timing inputs
                html += '<div class="line-timing">';
                html += '<div class="timing-input"><label>Start</label><input type="text" class="line-start" value="' + formatTimeInput(line.start) + '" data-line="' + lineIdx + '"></div>';
                html += '<div class="timing-input"><label>End</label><input type="text" class="line-end" value="' + formatTimeInput(line.end) + '" data-line="' + lineIdx + '"></div>';
                html += '</div>';
                
                // Words
                html += '<div class="line-words">';
                if (line.words && line.words.length > 0) {
                    line.words.forEach(function(word, wordIdx) {
                        var wordText = word.word || word.text || '';
                        var wordStart = word.start || 0;
                        html += '<div class="word-edit" data-line="' + lineIdx + '" data-word="' + wordIdx + '">';
                        html += '<input type="text" class="word-text" value="' + escapeHtml(wordText) + '" data-line="' + lineIdx + '" data-word="' + wordIdx + '">';
                        html += '<span class="word-time">' + formatTimeShort(wordStart) + '</span>';
                        html += '</div>';
                    });
                } else {
                    // No word-level timing, show full line
                    html += '<div class="word-edit full-line" data-line="' + lineIdx + '">';
                    html += '<input type="text" class="word-text full" value="' + escapeHtml(line.text) + '" data-line="' + lineIdx + '">';
                    html += '</div>';
                }
                html += '</div>';
                
                // Actions
                html += '<div class="line-actions">';
                html += '<button onclick="playFromLine(' + lineIdx + ')" title="Play from here"><i class="fas fa-play"></i></button>';
                html += '<button class="delete-line" onclick="deleteLine(' + lineIdx + ')" title="Delete line"><i class="fas fa-trash"></i></button>';
                html += '</div>';
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function formatTimeInput(seconds) {
            if (!seconds && seconds !== 0) return '0:00.00';
            var mins = Math.floor(seconds / 60);
            var secs = (seconds % 60).toFixed(2);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        function formatTimeShort(seconds) {
            if (!seconds && seconds !== 0) return '0:00';
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        function parseTimeInput(timeStr) {
            var parts = timeStr.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            }
            return parseFloat(timeStr) || 0;
        }
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function playFromLine(lineIdx) {
            if (!currentLyrics || !currentLyrics.lines[lineIdx]) return;
            
            var startTime = currentLyrics.lines[lineIdx].start;
            seekAllStems(startTime);
            playAllStems();
            closeModal('lyricsEditorModal');
        }
        
        function deleteLine(lineIdx) {
            if (!confirm('Delete this line?')) return;
            
            currentLyrics.lines.splice(lineIdx, 1);
            renderLyricsEditor();
            showToast('Line deleted. Save to apply changes.', 'info');
        }
        
        function saveLyricsEdits() {
            if (!currentJobId || !currentLyrics) {
                showToast('No lyrics to save', 'error');
                return;
            }
            
            // Gather edited data from DOM
            var container = document.getElementById('lyricsEditorContainer');
            var editorLines = container.querySelectorAll('.editor-line');
            
            var updatedLines = [];
            editorLines.forEach(function(lineEl) {
                var lineIdx = parseInt(lineEl.dataset.lineIdx);
                var originalLine = currentLyrics.lines[lineIdx];
                
                // Get timing
                var startInput = lineEl.querySelector('.line-start');
                var endInput = lineEl.querySelector('.line-end');
                var newStart = parseTimeInput(startInput.value);
                var newEnd = parseTimeInput(endInput.value);
                
                // Get words
                var wordInputs = lineEl.querySelectorAll('.word-text');
                var newWords = [];
                var fullText = '';
                
                if (wordInputs.length === 1 && wordInputs[0].classList.contains('full')) {
                    // Full line edit (no word timing)
                    fullText = wordInputs[0].value;
                } else {
                    wordInputs.forEach(function(input, idx) {
                        var origWord = originalLine.words && originalLine.words[idx];
                        newWords.push({
                            word: input.value,
                            text: input.value,
                            start: origWord ? origWord.start : newStart,
                            end: origWord ? origWord.end : newEnd
                        });
                        fullText += input.value + ' ';
                    });
                }
                
                updatedLines.push({
                    text: fullText.trim() || originalLine.text,
                    start: newStart,
                    end: newEnd,
                    confidence: originalLine.confidence || 1.0,
                    words: newWords.length > 0 ? newWords : originalLine.words
                });
            });
            
            // Update local lyrics
            currentLyrics.lines = updatedLines;
            currentLyrics.text = updatedLines.map(function(l) { return l.text; }).join('\n');
            
            // Send to server
            fetch('/lyrics/' + currentJobId + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(currentLyrics)
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast('Lyrics saved successfully!', 'success');
                    displayLyrics(currentLyrics);
                    closeModal('lyricsEditorModal');
                } else {
                    showToast('Failed to save: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(function(err) {
                console.error('Save failed:', err);
                showToast('Failed to save lyrics', 'error');
            });
        }
        
        function openKaraokePage() {
            if (!currentJobId) {
                showToast('No track loaded', 'error');
                return;
            }
            // Open in new tab with proper security attributes
            var karaokeWindow = window.open('/karaoke/' + currentJobId, '_blank', 'noopener,noreferrer');
            if (!karaokeWindow) {
                // Popup blocked - try alternative method
                var link = document.createElement('a');
                link.href = '/karaoke/' + currentJobId;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function fetchMusicAnalysis(jobId) {
            // Music analysis endpoint - silently skip if not available
            fetch('/analyze/' + jobId)
            .then(function(response) {
                if (!response.ok) return null;
                return response.json();
            })
            .then(function(data) {
                if (!data || data.error) {
                    // Silently ignore - analysis not available for this track
                    return;
                }

                // Update tempo display
                var tempoEl = document.getElementById('tempoValue');
                var tempoConfEl = document.getElementById('tempoConfidence');
                if (tempoEl && data.tempo) {
                    tempoEl.textContent = Math.round(data.tempo.bpm);
                    if (tempoConfEl && data.tempo.confidence !== undefined) {
                        var confPercent = Math.round(data.tempo.confidence * 100);
                        tempoConfEl.textContent = confPercent + '% confidence';
                    }
                }

                // Update key display
                var keyEl = document.getElementById('keyValue');
                var keyConfEl = document.getElementById('keyConfidence');
                if (keyEl && data.key) {
                    var keyName = data.key.key;
                    var mode = data.key.mode || '';
                    var modeAbbrev = mode === 'major' ? 'maj' : (mode === 'minor' ? 'min' : mode);
                    keyEl.textContent = keyName + ' ' + modeAbbrev;
                    if (keyConfEl && data.key.confidence !== undefined) {
                        var confPercent = Math.round(data.key.confidence * 100);
                        keyConfEl.textContent = confPercent + '% confidence';
                    }
                }

                // Update time signature display
                var timeSigEl = document.getElementById('timeSigValue');
                if (timeSigEl && data.time_signature) {
                    timeSigEl.textContent = data.time_signature.time_signature;
                }
            })
            .catch(function(error) {
                // Silently ignore - analysis endpoint not available
            });
        }

        // ==================== SYNC & TIME ====================
        let seekDebounceTimer = null;
        let lastSeekProgress = -1;
        
        function syncAllToPosition(progress) {
            // Debounce rapid seeks (prevent multiple triggers)
            if (seekDebounceTimer) {
                clearTimeout(seekDebounceTimer);
            }
            
            // Skip if same position (within 0.5%)
            if (Math.abs(progress - lastSeekProgress) < 0.005) {
                debugLog('SEEK', 'Skipping duplicate seek');
                return;
            }
            lastSeekProgress = progress;
            
            debugLog('SEEK', ' syncAllToPosition called', { 
                progress: (progress * 100).toFixed(1) + '%', 
                targetTime: (progress * masterDuration).toFixed(3) + 's',
                wasPlaying: isPlaying 
            });
            debugStats.seekCount++;
            
            isSeeking = true;
            var targetTime = progress * masterDuration;
            
            // Record if was playing
            var wasPlaying = isPlaying;
            
            // Pause all first for accurate sync
            if (wasPlaying) {
                debugLog('SEEK', 'Pausing for seek');
                isPlaying = false;
                Object.keys(wavesurfers).forEach(function(key) {
                    try { wavesurfers[key].pause(); } catch(e) {}
                });
            }
            
            // Seek all to exact same position
            debugLog('SEEK', 'Seeking ' + Object.keys(wavesurfers).length + ' wavesurfers to ' + targetTime.toFixed(3) + 's');
            Object.keys(wavesurfers).forEach(function(key) {
                try {
                    wavesurfers[key].seekTo(progress);
                } catch(e) {
                    debugLog('ERROR', 'Failed to seek ' + key, e);
                }
            });
            
            // Update state
            masterTime = targetTime;
            pausedAt = targetTime;
            updateTimeDisplay(targetTime);
            updateTimelineVisual(progress);
            debugState('seek');
            
            debugLog('SEEK', ' Seek complete to ' + targetTime.toFixed(3) + 's');
            
            // Use debounce timer to resume playback (prevents rapid fire)
            seekDebounceTimer = setTimeout(function() {
                isSeeking = false;
                lastSeekProgress = -1; // Reset for next seek
                
                // Resume if was playing
                if (wasPlaying) {
                    debugLog('SEEK', 'Resuming playback after seek');
                    playAllSynced();
                }
            }, 100);
        }

        function syncAllToTime(time) {
            if (masterDuration <= 0) return;
            var progress = Math.max(0, Math.min(1, time / masterDuration));
            syncAllToPosition(progress);
        }

        function playAllSynced() {
            debugLog('PLAY', ' playAllSynced called', { pausedAt: pausedAt, masterTime: masterTime });
            debugStats.playCount++;
            
            // Get or create AudioContext for precise timing (must be after user gesture)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                debugLog('AUDIO', 'Created new AudioContext');
            }
            
            // Resume AudioContext if suspended (browser autoplay policy)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
                debugLog('AUDIO', 'Resumed suspended AudioContext');
            }
            
            // Record the start time
            masterStartTime = audioContext.currentTime;
            
            // Start all wavesurfers simultaneously
            var keys = Object.keys(wavesurfers);
            debugLog('PLAY', 'Starting ' + keys.length + ' wavesurfers');
            keys.forEach(function(key) {
                try {
                    wavesurfers[key].play();
                } catch(e) {
                    debugLog('ERROR', 'Failed to play ' + key, e);
                }
            });
            
            // Also start Tone.js players if pitch is shifted
            if (toneInitialized && currentPitch !== 0) {
                debugLog('TONE', 'Syncing Tone.js players (pitch: ' + currentPitch + ')');
                syncTonePlayersToWaveSurfer();
                playTonePlayers();
            }
            
            isPlaying = true;
            document.getElementById('masterPlayBtn').querySelector('i').className = 'fas fa-pause';
            debugState('play');
            
            // Start the animation frame loop for updates
            startAnimationLoop();
        }

        function pauseAllSynced() {
            debugLog('PAUSE', ' pauseAllSynced called', { isPlaying: isPlaying, masterTime: masterTime });
            debugStats.pauseCount++;
            
            // Record current position FIRST before pausing
            var currentTime = 0;
            var firstWs = Object.values(wavesurfers)[0];
            if (firstWs) {
                currentTime = firstWs.getCurrentTime();
            }
            
            debugLog('PAUSE', 'Captured position: ' + currentTime.toFixed(3) + 's');
            
            // Stop all wavesurfers
            Object.keys(wavesurfers).forEach(function(key) {
                try {
                    wavesurfers[key].pause();
                } catch(e) {}
            });
            
            // Also pause Tone.js players
            if (toneInitialized) {
                pauseTonePlayers();
            }
            
            // Record where we paused
            pausedAt = currentTime;
            masterTime = currentTime;
            isPlaying = false;
            document.getElementById('masterPlayBtn').querySelector('i').className = 'fas fa-play';
            debugState('pause');
            debugLog('PAUSE', 'Paused at ' + pausedAt.toFixed(3) + 's');
            
            // Update display immediately
            updateTimeDisplay(pausedAt);
            if (masterDuration > 0) {
                updateTimelineVisual(pausedAt / masterDuration);
            }
            
            // Keep animation loop running for display updates
            // (It will detect isPlaying=false and show pausedAt time)
        }
        
        // Sync Tone.js players to WaveSurfer position
        function syncTonePlayersToWaveSurfer() {
            if (Object.keys(tonePlayers).length === 0) return;
            
            // Get current time from first wavesurfer
            var currentTime = 0;
            var firstWs = Object.values(wavesurfers)[0];
            if (firstWs) {
                currentTime = firstWs.getCurrentTime();
            }
            
            debugLog('TONE', 'Syncing Tone players to ' + currentTime.toFixed(3) + 's');
            
            // Sync all Tone.js players
            Object.keys(tonePlayers).forEach(function(stemName) {
                var player = tonePlayers[stemName];
                if (player && player.loaded) {
                    player.seek(currentTime);
                }
            });
        }

        function startAnimationLoop() {
            debugLog('LOOP', 'Starting animation loop');
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            function updateLoop() {
                // Exit if no wavesurfers at all
                if (Object.keys(wavesurfers).length === 0) {
                    animationFrameId = requestAnimationFrame(updateLoop);
                    return;
                }
                
                // If not playing, just display pausedAt time and continue loop
                if (!isPlaying) {
                    updateTimeDisplay(pausedAt);
                    if (masterDuration > 0) {
                        var progress = pausedAt / masterDuration;
                        updateTimelineVisual(progress);
                    }
                    animationFrameId = requestAnimationFrame(updateLoop);
                    return;
                }
                
                // Use high-precision timing from all wavesurfers
                var times = [];
                var timesByKey = {};
                Object.keys(wavesurfers).forEach(function(key) {
                    var ws = wavesurfers[key];
                    if (ws) {
                        var t = ws.getCurrentTime();
                        times.push(t);
                        timesByKey[key] = t;
                    }
                });
                
                if (times.length > 0) {
                    // Use average time for master display
                    masterTime = times.reduce(function(a, b) { return a + b; }, 0) / times.length;
                    
                    // Calculate max drift
                    var maxTime = Math.max.apply(null, times);
                    var minTime = Math.min.apply(null, times);
                    var maxDrift = maxTime - minTime;
                    
                    // Update individual stem times with drift indicator
                    Object.keys(wavesurfers).forEach(function(key) {
                        var time = timesByKey[key];
                        var drift = time - masterTime;
                        var safeKey = sanitizeStemId(key);
                        
                        // Update time display
                        var timeEl = document.getElementById('time-' + safeKey);
                        if (timeEl) {
                            timeEl.textContent = formatTimeWithMicros(time);
                        }
                        
                        // Update sync indicator
                        var syncEl = document.getElementById('sync-' + safeKey);
                        var driftEl = document.getElementById('drift-' + safeKey);
                        
                        if (syncEl) {
                            var absDrift = Math.abs(drift);
                            syncEl.classList.remove('warning', 'error');
                            
                            if (absDrift < 0.005) { // < 5ms = green
                                // Already green by default
                            } else if (absDrift < 0.02) { // < 20ms = yellow
                                syncEl.classList.add('warning');
                            } else { // > 20ms = red
                                syncEl.classList.add('error');
                            }
                        }
                        
                        if (driftEl) {
                            if (Math.abs(drift) > 0.001) {
                                var sign = drift > 0 ? '+' : '';
                                driftEl.textContent = sign + (drift * 1000).toFixed(1) + 'ms';
                            } else {
                                driftEl.textContent = '';
                            }
                        }
                    });
                    
                    // Store drift for debugging
                    debugStats.lastDriftValues.push(maxDrift * 1000);
                    if (debugStats.lastDriftValues.length > 100) {
                        debugStats.lastDriftValues.shift();
                    }
                    
                    // Auto-correct drift if too large during playback (more conservative)
                    // Only correct if drift is significant AND consistent
                    if (isPlaying && maxDrift > syncTolerance && !isSeeking) {
                        var now = performance.now();
                        // Increase debounce to 2 seconds for stability
                        if (now - lastSyncCheck > 2000) {
                            lastSyncCheck = now;
                            debugLog('DRIFT', ' Drift detected: ' + (maxDrift * 1000).toFixed(1) + 'ms', timesByKey);
                            correctDrift(timesByKey);
                        }
                    }
                    
                    // Update global sync indicator
                    var globalSyncEl = document.getElementById('globalSyncIndicator');
                    var globalDriftEl = document.getElementById('globalDrift');
                    
                    if (globalSyncEl) {
                        globalSyncEl.classList.remove('warning', 'error');
                        if (maxDrift < 0.005) {
                            // Synced (green)
                        } else if (maxDrift < 0.02) {
                            globalSyncEl.classList.add('warning');
                        } else {
                            globalSyncEl.classList.add('error');
                        }
                    }
                    
                    if (globalDriftEl) {
                        if (maxDrift > 0.001) {
                            globalDriftEl.textContent = 'Max drift: ' + (maxDrift * 1000).toFixed(1) + 'ms';
                        } else {
                            globalDriftEl.textContent = 'Synced';
                            globalDriftEl.style.color = '#10b981';
                        }
                    }
                    
                    updateTimeDisplay(masterTime);
                    
                    // Update lyrics highlighting
                    updateLyricsHighlight(masterTime);
                    
                    if (masterDuration > 0) {
                        var progress = masterTime / masterDuration;
                        updateTimelineVisual(progress);
                    }
                }
                
                animationFrameId = requestAnimationFrame(updateLoop);
            }
            
            animationFrameId = requestAnimationFrame(updateLoop);
        }

        function correctDrift(timesByKey) {
            // Find the median time as reference (more stable than average)
            var times = Object.values(timesByKey);
            var sorted = times.slice().sort(function(a, b) { return a - b; });
            var medianTime = sorted[Math.floor(sorted.length / 2)];
            
            var corrected = 0;
            var driftDetails = [];
            
            Object.keys(timesByKey).forEach(function(key) {
                var ws = wavesurfers[key];
                if (!ws) return;
                
                var currentTime = timesByKey[key];
                var drift = Math.abs(currentTime - medianTime);
                
                // Only correct if drift is significant (more than 100ms)
                if (drift > 0.1) {
                    var progress = medianTime / masterDuration;
                    ws.seekTo(Math.max(0, Math.min(1, progress)));
                    corrected++;
                    driftDetails.push(key + ': ' + (drift * 1000).toFixed(0) + 'ms');
                }
            });
            
            if (corrected > 0) {
                debugStats.driftCorrections++;
                debugLog('DRIFT', ' Corrected ' + corrected + ' tracks to ' + medianTime.toFixed(3) + 's', driftDetails);
            }
        }

        function startTimeUpdates() {
            // Initial update
            updateTimeDisplay(pausedAt);
            
            // Start animation loop (handles both playing and paused states)
            startAnimationLoop();
        }

        function updateTimeDisplay(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            var ms = Math.floor((seconds % 1) * 1000);
            
            var currentTimeEl = document.getElementById('currentTime');
            var currentMsEl = document.getElementById('currentMs');
            
            if (currentTimeEl) {
                currentTimeEl.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
            }
            if (currentMsEl) {
                currentMsEl.textContent = '.' + String(ms).padStart(3, '0');
            }
        }

        function updateTotalTime(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            var ms = Math.floor((seconds % 1) * 1000);
            
            var totalTimeEl = document.getElementById('totalTime');
            var totalMsEl = document.getElementById('totalMs');
            
            if (totalTimeEl) {
                totalTimeEl.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
            }
            if (totalMsEl) {
                totalMsEl.textContent = '.' + String(ms).padStart(3, '0');
            }
        }

        function updateTimelineVisual(progress) {
            progress = Math.max(0, Math.min(1, progress));
            var progressEl = document.getElementById('timelineProgress');
            var cursorEl = document.getElementById('timelineCursor');
            
            if (progressEl) {
                progressEl.style.width = (progress * 100) + '%';
            }
            if (cursorEl) {
                cursorEl.style.left = (progress * 100) + '%';
            }
        }

        function formatTimeWithMs(seconds) {
            if (!seconds || isNaN(seconds)) return '00:00.000';
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            var ms = Math.floor((seconds % 1) * 1000);
            return String(mins).padStart(2, '0') + ':' + 
                   String(secs).padStart(2, '0') + '.' + 
                   String(ms).padStart(3, '0');
        }

        function formatTimeWithMicros(seconds) {
            if (!seconds || isNaN(seconds)) return '00:00.000';
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            var ms = Math.floor((seconds % 1) * 1000);
            return String(mins).padStart(2, '0') + ':' + 
                   String(secs).padStart(2, '0') + '.' + 
                   String(ms).padStart(3, '0');
        }

        // ==================== MUTE & SOLO ====================
        function toggleMute(stemName) {
            var btn = document.querySelector('.mute-btn[data-stem="' + stemName + '"]');
            var ws = wavesurfers[stemName];
            var track = document.getElementById('stem-track-' + stemName);
            var slider = document.querySelector('.volume-slider[data-stem="' + stemName + '"]');
            
            if (!ws || !btn) return;
            
            if (mutedStems.has(stemName)) {
                // Unmute
                mutedStems.delete(stemName);
                btn.classList.remove('active');
                track.classList.remove('muted');
                ws.setVolume(slider.value / 100);
            } else {
                // Mute
                mutedStems.add(stemName);
                btn.classList.add('active');
                track.classList.add('muted');
                ws.setVolume(0);
            }
            
            updateSoloMuteState();
        }

        function toggleSolo(stemName) {
            var btn = document.querySelector('.solo-btn[data-stem="' + stemName + '"]');
            var track = document.getElementById('stem-track-' + stemName);
            
            if (!btn) return;
            
            if (soloStems.has(stemName)) {
                // Unsolo
                soloStems.delete(stemName);
                btn.classList.remove('active');
                track.classList.remove('solo');
            } else {
                // Solo
                soloStems.add(stemName);
                btn.classList.add('active');
                track.classList.add('solo');
            }
            
            updateSoloMuteState();
        }

        function updateSoloMuteState() {
            var hasSolo = soloStems.size > 0;
            
            Object.keys(wavesurfers).forEach(function(stemName) {
                var ws = wavesurfers[stemName];
                var slider = document.querySelector('.volume-slider[data-stem="' + stemName + '"]');
                var track = document.getElementById('stem-track-' + stemName);
                
                if (!ws || !slider) return;
                
                var shouldBeMuted = mutedStems.has(stemName);
                var shouldBeSilent = hasSolo && !soloStems.has(stemName);
                
                if (shouldBeMuted || shouldBeSilent) {
                    ws.setVolume(0);
                    track.style.opacity = '0.5';
                } else {
                    ws.setVolume(slider.value / 100);
                    track.style.opacity = '1';
                }
            });
            
            // Also update Tone.js player volumes if pitch shifting is active
            if (toneInitialized) {
                updateTonePlayerVolumes();
            }
        }

        function togglePlayAll() {
            debugLog('TOGGLE', ' togglePlayAll called', { isPlaying: isPlaying, pausedAt: pausedAt });
            
            if (isPlaying) {
                pauseAllSynced();
            } else {
                // Sync all to current position before playing
                var progress = masterDuration > 0 ? pausedAt / masterDuration : 0;
                debugLog('TOGGLE', 'Syncing to progress: ' + progress.toFixed(3) + ' (' + pausedAt.toFixed(3) + 's)');
                
                Object.keys(wavesurfers).forEach(function(key) {
                    try {
                        wavesurfers[key].seekTo(Math.max(0, Math.min(1, progress)));
                    } catch(e) {}
                });
                
                // Small delay then play all synced
                setTimeout(function() {
                    playAllSynced();
                }, 30);
            }
        }
        
        // Debug helper - show stats in console
        function showDebugStats() {
            console.log('=== DEBUG STATS ===');
            console.log('Play count:', debugStats.playCount);
            console.log('Pause count:', debugStats.pauseCount);
            console.log('Seek count:', debugStats.seekCount);
            console.log('Drift corrections:', debugStats.driftCorrections);
            console.log('Current state:', { isPlaying: isPlaying, masterTime: masterTime, pausedAt: pausedAt });
            console.log('Recent state changes:', debugStats.stateChanges.slice(-5));
            if (debugStats.lastDriftValues.length > 0) {
                var avgDrift = debugStats.lastDriftValues.reduce(function(a, b) { return a + b; }, 0) / debugStats.lastDriftValues.length;
                console.log('Average drift (last ' + debugStats.lastDriftValues.length + ' samples):', avgDrift.toFixed(2) + 'ms');
            }
            console.log('==================');
        }
        
        // Expose debug function globally
        window.showDebugStats = showDebugStats;
        window.debugStats = debugStats;

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '00:00';
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
        }

        // ==================== DOWNLOADS ====================
        function downloadStem(jobId, stemName) {
            var track = null;
            for (var i = 0; i < allTracks.length; i++) {
                if (allTracks[i].job_id === jobId || allTracks[i].id === jobId) {
                    track = allTracks[i];
                    break;
                }
            }
            var displayName = track ? (track.display_name || track.filename.replace(/\.[^/.]+$/, '')) : 'track';
            
            var a = document.createElement('a');
            // Use stem URL from track if available (for library items)
            a.href = (track && track.stems && track.stems[stemName]) || '/download/' + jobId + '/' + stemName;
            a.download = displayName + '_' + stemName + '.mp3';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('Downloading ' + stemName);
        }

        function downloadAllStems(jobId) {
            var track = null;
            for (var i = 0; i < allTracks.length; i++) {
                if (allTracks[i].job_id === jobId || allTracks[i].id === jobId) {
                    track = allTracks[i];
                    break;
                }
            }
            if (!track || !track.stems) return;

            showToast('Downloading all stems...');

            var stemKeys = Object.keys(track.stems);
            var index = 0;

            function downloadNext() {
                if (index < stemKeys.length) {
                    downloadStem(jobId, stemKeys[index]);
                    index++;
                    setTimeout(downloadNext, 600);
                }
            }

            downloadNext();
        }

        // ==================== STATS ====================
        function loadStats() {
            fetch('/jobs')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var jobs = data.jobs || [];

                var completed = jobs.filter(function(j) { return j.status === 'completed'; }).length;
                var processing = jobs.filter(function(j) { return j.status === 'processing'; }).length;
                var failed = jobs.filter(function(j) { return j.status === 'failed'; }).length;
                var totalStems = jobs.reduce(function(acc, j) { return acc + Object.keys(j.stems || {}).length; }, 0);

                document.getElementById('statsContent').innerHTML = 
                    '<div class="stat-card"><div class="stat-value">' + completed + '</div><div class="stat-label">Completed Tracks</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + processing + '</div><div class="stat-label">Processing</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + totalStems + '</div><div class="stat-label">Total Stems</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + failed + '</div><div class="stat-label">Failed</div></div>';
            })
            .catch(function(error) {
                console.error('Failed to load stats:', error);
            });
        }

        // ==================== MIDI CONVERTER ====================
        let midiSelectedFile = null;
        let midiSelectedStem = null;
        
        // Initialize MIDI converter
        function initMidiConverter() {
            const uploadArea = document.getElementById('midiUploadArea');
            const fileInput = document.getElementById('midiFileInput');
            const stemSelect = document.getElementById('midiStemSelect');
            
            // Click to upload
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary)';
                uploadArea.style.background = 'rgba(124, 58, 237, 0.05)';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border)';
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border)';
                uploadArea.style.background = '';
                
                if (e.dataTransfer.files.length > 0) {
                    handleMidiFileSelect(e.dataTransfer.files[0]);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleMidiFileSelect(e.target.files[0]);
                }
            });
            
            // Stem select change
            stemSelect.addEventListener('change', function(e) {
                midiSelectedStem = e.target.value;
                midiSelectedFile = null;
                document.getElementById('midiSelectedFile').style.display = 'none';
                updateMidiConvertButton();
            });
            
            // Populate stems dropdown
            populateMidiStems();
        }
        
        function handleMidiFileSelect(file) {
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/mp4', 'audio/ogg', 'audio/x-m4a'];
            const allowedExts = ['.mp3', '.wav', '.flac', '.m4a', '.ogg'];
            
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExts.includes(ext)) {
                showToast('Invalid file type. Please use MP3, WAV, FLAC, or M4A', 'error');
                return;
            }
            
            midiSelectedFile = file;
            midiSelectedStem = null;
            document.getElementById('midiStemSelect').value = '';
            
            document.getElementById('midiFileName').textContent = file.name;
            document.getElementById('midiFileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
            document.getElementById('midiSelectedFile').style.display = 'block';
            
            updateMidiConvertButton();
        }
        
        function clearMidiFile() {
            midiSelectedFile = null;
            document.getElementById('midiSelectedFile').style.display = 'none';
            document.getElementById('midiFileInput').value = '';
            updateMidiConvertButton();
        }
        
        // MIDI URL handling
        let midiSelectedUrl = null;
        let midiUrlInfo = null;
        let currentMidiSource = 'file';
        
        function switchMidiSource(source) {
            currentMidiSource = source;
            
            // Update tab styles
            document.querySelectorAll('.midi-source-tab').forEach(tab => {
                if (tab.dataset.tab === source) {
                    tab.style.background = 'var(--primary)';
                    tab.style.color = 'white';
                    tab.style.border = 'none';
                    tab.classList.add('active');
                } else {
                    tab.style.background = 'var(--bg-darker)';
                    tab.style.color = 'var(--text-muted)';
                    tab.style.border = '1px solid var(--border)';
                    tab.classList.remove('active');
                }
            });
            
            // Show/hide content
            document.querySelectorAll('.midi-source-content').forEach(content => {
                content.style.display = 'none';
            });
            
            if (source === 'file') {
                document.getElementById('midiSourceFile').style.display = 'block';
            } else if (source === 'url') {
                document.getElementById('midiSourceUrl').style.display = 'block';
            } else if (source === 'stem') {
                document.getElementById('midiSourceStem').style.display = 'block';
            }
            
            updateMidiConvertButton();
        }
        
        async function fetchMidiUrlInfo() {
            const urlInput = document.getElementById('midiUrlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                showToast('Please enter a URL', 'warning');
                return;
            }
            
            const fetchBtn = document.getElementById('midiUrlFetchBtn');
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            fetchBtn.disabled = true;
            
            try {
                const response = await fetch('/validate-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    midiSelectedUrl = url;
                    midiUrlInfo = data;
                    
                    // Show preview
                    document.getElementById('midiUrlTitle').textContent = data.title || 'Unknown Title';
                    document.getElementById('midiUrlDuration').textContent = formatTime(data.duration || 0);
                    document.getElementById('midiUrlUploader').textContent = data.uploader || 'Unknown';
                    
                    // Update platform icon
                    const iconContainer = document.getElementById('midiUrlPlatformIcon');
                    let iconClass = 'fas fa-music';
                    let bgColor = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                    
                    if (data.source === 'youtube') {
                        iconClass = 'fab fa-youtube';
                        bgColor = '#ff0000';
                    } else if (data.source === 'soundcloud') {
                        iconClass = 'fab fa-soundcloud';
                        bgColor = '#ff5500';
                    } else if (data.source === 'vimeo') {
                        iconClass = 'fab fa-vimeo';
                        bgColor = '#1ab7ea';
                    }
                    
                    iconContainer.style.background = bgColor;
                    iconContainer.innerHTML = '<i class="' + iconClass + '" style="font-size: 24px; color: white;"></i>';
                    
                    document.getElementById('midiUrlPreview').style.display = 'block';
                    updateMidiConvertButton();
                    showToast('URL validated successfully!', 'success');
                } else {
                    showToast(data.error || 'Invalid URL', 'error');
                }
            } catch (error) {
                showToast('Failed to validate URL: ' + error.message, 'error');
            }
            
            fetchBtn.innerHTML = '<i class="fas fa-search"></i>';
            fetchBtn.disabled = false;
        }
        
        function clearMidiUrl() {
            midiSelectedUrl = null;
            midiUrlInfo = null;
            document.getElementById('midiUrlInput').value = '';
            document.getElementById('midiUrlPreview').style.display = 'none';
            updateMidiConvertButton();
        }
        
        // Convert stem to MIDI directly from player
        async function convertStemToMidi(stemUrl, stemName) {
            // Show a modal or toast for progress
            showToast('Converting ' + stemName + ' to MIDI...', 'info');
            
            // Find and disable the button
            const btns = document.querySelectorAll('.convert-midi-btn[data-stem="' + stemName + '"]');
            btns.forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            });
            
            try {
                const formData = new FormData();
                formData.append('stem_url', stemUrl);
                
                const response = await fetch('/api/convert-to-midi', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('MIDI created: ' + data.filename + ' (' + data.notes_count + ' notes)', 'success');
                    
                    // Offer to download
                    if (confirm('MIDI conversion complete! Download now?')) {
                        window.location.href = data.download_url;
                    }
                    
                    // Refresh MIDI library if visible
                    if (typeof refreshMidiLibrary === 'function') {
                        refreshMidiLibrary();
                    }
                } else {
                    throw new Error(data.error || 'Conversion failed');
                }
            } catch (error) {
                showToast('MIDI conversion failed: ' + error.message, 'error');
            }
            
            // Re-enable buttons
            btns.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-audio"></i>';
            });
        }
        
        function updateMidiConvertButton() {
            const btn = document.getElementById('convertToMidiBtn');
            if (currentMidiSource === 'file') {
                btn.disabled = !midiSelectedFile;
            } else if (currentMidiSource === 'url') {
                btn.disabled = !midiSelectedUrl;
            } else if (currentMidiSource === 'stem') {
                btn.disabled = !midiSelectedStem;
            }
        }
        
        function populateMidiStems() {
            const select = document.getElementById('midiStemSelect');
            select.innerHTML = '<option value="">Select a stem from your library...</option>';
            
            // Add stems from tracks
            allTracks.forEach(function(track) {
                if (track.stems && track.stems.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = track.name;
                    
                    track.stems.forEach(function(stem) {
                        const option = document.createElement('option');
                        option.value = stem.url;
                        option.textContent = stem.name.charAt(0).toUpperCase() + stem.name.slice(1);
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                }
            });
        }
        
        async function convertToMidi() {
            const btn = document.getElementById('convertToMidiBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Converting...';
            
            document.getElementById('midiEmpty').style.display = 'none';
            document.getElementById('midiResult').style.display = 'none';
            document.getElementById('midiProcessing').style.display = 'block';
            
            // Simulate progress
            let progress = 0;
            const progressBar = document.getElementById('midiProgressBar');
            const progressInterval = setInterval(function() {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 500);
            
            try {
                const formData = new FormData();
                
                if (currentMidiSource === 'file' && midiSelectedFile) {
                    formData.append('audio', midiSelectedFile);
                } else if (currentMidiSource === 'url' && midiSelectedUrl) {
                    formData.append('youtube_url', midiSelectedUrl);
                } else if (currentMidiSource === 'stem' && midiSelectedStem) {
                    formData.append('stem_url', midiSelectedStem);
                } else {
                    throw new Error('No source selected');
                }
                
                const response = await fetch('/api/convert-to-midi', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                if (data.success) {
                    setTimeout(function() {
                        document.getElementById('midiProcessing').style.display = 'none';
                        document.getElementById('midiResult').style.display = 'block';
                        
                        document.getElementById('midiResultName').textContent = data.filename;
                        document.getElementById('midiNotesCount').textContent = data.notes_count || '0';
                        document.getElementById('midiDuration').textContent = formatTime(data.duration || 0);
                        
                        // Set up download button
                        document.getElementById('downloadMidiBtn').onclick = function() {
                            window.location.href = data.download_url;
                        };
                        
                        // Refresh library after conversion
                        refreshMidiLibrary();
                        
                        // Clear inputs after success
                        if (currentMidiSource === 'url') {
                            clearMidiUrl();
                        }
                        
                        showToast('MIDI conversion complete!', 'success');
                    }, 500);
                } else {
                    throw new Error(data.error || 'Conversion failed');
                }
            } catch (error) {
                clearInterval(progressInterval);
                document.getElementById('midiProcessing').style.display = 'none';
                document.getElementById('midiEmpty').style.display = 'block';
                showToast('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Convert to MIDI';
            updateMidiConvertButton();
        }
        
        // Initialize on section switch
        document.addEventListener('DOMContentLoaded', function() {
            // Delay init to ensure allTracks is loaded
            setTimeout(initMidiConverter, 1000);
            // Load MIDI library
            setTimeout(refreshMidiLibrary, 1500);
        });
        
        // ==================== STEMS TAB SWITCHING ====================
        function switchStemsTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.stems-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    tab.style.borderBottomColor = 'var(--primary)';
                    tab.style.color = 'var(--text)';
                } else {
                    tab.classList.remove('active');
                    tab.style.borderBottomColor = 'transparent';
                    tab.style.color = 'var(--text-muted)';
                }
            });
            
            // Show/hide tab content
            document.querySelectorAll('.stems-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById('stems-tab-' + tabName).style.display = 'block';
            
            // Refresh content based on tab
            if (tabName === 'library') {
                loadLibrary();
            } else if (tabName === 'stats') {
                loadStats();
            }
        }
        
        // ==================== MIDI TAB SWITCHING ====================
        function switchMidiTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.midi-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    tab.style.borderBottomColor = 'var(--primary)';
                    tab.style.color = 'var(--text)';
                } else {
                    tab.classList.remove('active');
                    tab.style.borderBottomColor = 'transparent';
                    tab.style.color = 'var(--text-muted)';
                }
            });
            
            // Show/hide tab content
            document.querySelectorAll('.midi-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById('midi-tab-' + tabName).style.display = 'block';
            
            // Refresh library when switching to it
            if (tabName === 'library') {
                refreshMidiLibrary();
            } else if (tabName === 'player') {
                populateMidiPlayerSelect();
            }
        }
        
        // ==================== MIDI LIBRARY ====================
        let midiLibraryFiles = [];
        
        async function refreshMidiLibrary() {
            const loading = document.getElementById('midiLibraryLoading');
            const empty = document.getElementById('midiLibraryEmpty');
            const grid = document.getElementById('midiLibraryGrid');
            
            loading.style.display = 'block';
            empty.style.display = 'none';
            grid.style.display = 'none';
            
            try {
                const response = await fetch('/api/midi-library');
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (data.success && data.files && data.files.length > 0) {
                    midiLibraryFiles = data.files;
                    renderMidiLibrary(data.files);
                    grid.style.display = 'grid';
                } else {
                    empty.style.display = 'block';
                }
            } catch (error) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                console.error('Failed to load MIDI library:', error);
            }
        }
        
        function renderMidiLibrary(files) {
            const grid = document.getElementById('midiLibraryGrid');
            grid.innerHTML = '';
            
            files.forEach(file => {
                const card = document.createElement('div');
                card.className = 'midi-file-card';
                card.style.cssText = 'background: var(--bg-darker); border-radius: 16px; padding: 20px; transition: all 0.3s; border: 1px solid var(--border);';
                
                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-music" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h5 style="margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${file.filename}">${file.filename}</h5>
                            <p style="font-size: 12px; color: var(--text-muted);">${file.date}</p>
                            <div style="display: flex; gap: 15px; margin-top: 8px; font-size: 12px; color: var(--text-dim);">
                                <span><i class="fas fa-music"></i> ${file.notes || 0} notes</span>
                                <span><i class="fas fa-clock"></i> ${formatTime(file.duration || 0)}</span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="playMidiFromLibrary('${file.download_url}', '${file.filename}')" class="btn btn-primary" style="flex: 1; padding: 10px;">
                            <i class="fas fa-play"></i> Play
                        </button>
                        <button onclick="window.location.href='${file.download_url}'" class="btn btn-secondary" style="padding: 10px 15px;">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="deleteMidiFile('${file.filename}')" class="btn btn-secondary" style="padding: 10px 15px; color: var(--error);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function playMidiFromLibrary(url, filename) {
            // Switch to player tab and load the file
            switchMidiTab('player');
            loadMidiForPlayer(url, filename);
        }
        
        async function deleteMidiFile(filename) {
            if (!confirm('Delete this MIDI file?')) return;
            
            try {
                const response = await fetch('/api/midi-library/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('MIDI file deleted', 'success');
                    refreshMidiLibrary();
                } else {
                    showToast('Failed to delete file', 'error');
                }
            } catch (error) {
                showToast('Error deleting file', 'error');
            }
        }
        
        // ==================== MIDI PLAYER WITH TONE.JS ====================
        // Using Tone.js for reliable MIDI playback with synthesizers
        let midiPlaying = false;
        let midiCurrentTime = 0;
        let midiTotalDuration = 0;
        let midiNotes = [];
        let midiPlaybackInterval = null;
        let currentMidiUrl = null;
        let midiVolume = 0.8;
        let midiTempo = 1.0;
        let currentInstrument = 'piano';
        let toneSynth = null;
        let toneLoaded = false;
        let scheduledEvents = [];
        
        // Realistic instrument presets using Tone.js Samplers with real samples
        // Samples from nbrosowsky/tonejs-instruments (GitHub)
        const SAMPLE_BASE_URL = 'https://nbrosowsky.github.io/tonejs-instruments/samples/';
        
        const instrumentPresets = {
            'piano': { 
                name: 'Grand Piano', 
                type: 'sampler',
                samples: {
                    'A0': 'A0.mp3', 'C1': 'C1.mp3', 'D#1': 'Ds1.mp3', 'F#1': 'Fs1.mp3',
                    'A1': 'A1.mp3', 'C2': 'C2.mp3', 'D#2': 'Ds2.mp3', 'F#2': 'Fs2.mp3',
                    'A2': 'A2.mp3', 'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3',
                    'A3': 'A3.mp3', 'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3',
                    'A4': 'A4.mp3', 'C5': 'C5.mp3', 'D#5': 'Ds5.mp3', 'F#5': 'Fs5.mp3',
                    'A5': 'A5.mp3', 'C6': 'C6.mp3', 'D#6': 'Ds6.mp3', 'F#6': 'Fs6.mp3',
                    'A6': 'A6.mp3', 'C7': 'C7.mp3', 'D#7': 'Ds7.mp3', 'F#7': 'Fs7.mp3',
                    'A7': 'A7.mp3', 'C8': 'C8.mp3'
                },
                folder: 'piano/'
            },
            'guitar': { 
                name: 'Acoustic Guitar', 
                type: 'sampler',
                samples: {
                    'E2': 'E2.mp3', 'F#2': 'Fs2.mp3', 'A2': 'A2.mp3', 'C3': 'C3.mp3',
                    'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3', 'A3': 'A3.mp3', 'C4': 'C4.mp3',
                    'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3', 'A4': 'A4.mp3', 'C5': 'C5.mp3',
                    'D#5': 'Ds5.mp3', 'F#5': 'Fs5.mp3', 'A5': 'A5.mp3'
                },
                folder: 'guitar-acoustic/'
            },
            'violin': { 
                name: 'Violin', 
                type: 'sampler',
                samples: {
                    'A3': 'A3.mp3', 'A4': 'A4.mp3', 'A5': 'A5.mp3', 'A6': 'A6.mp3',
                    'C4': 'C4.mp3', 'C5': 'C5.mp3', 'C6': 'C6.mp3', 'C7': 'C7.mp3',
                    'E4': 'E4.mp3', 'E5': 'E5.mp3', 'E6': 'E6.mp3',
                    'G4': 'G4.mp3', 'G5': 'G5.mp3', 'G6': 'G6.mp3'
                },
                folder: 'violin/'
            },
            'cello': { 
                name: 'Cello', 
                type: 'sampler',
                samples: {
                    'C2': 'C2.mp3', 'D#2': 'Ds2.mp3', 'F#2': 'Fs2.mp3', 'A2': 'A2.mp3',
                    'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3', 'A3': 'A3.mp3',
                    'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3', 'A4': 'A4.mp3',
                    'C5': 'C5.mp3', 'D#5': 'Ds5.mp3', 'F#5': 'Fs5.mp3'
                },
                folder: 'cello/'
            },
            'flute': { 
                name: 'Flute', 
                type: 'sampler',
                samples: {
                    'A4': 'A4.mp3', 'C4': 'C4.mp3', 'C5': 'C5.mp3', 'C6': 'C6.mp3',
                    'E4': 'E4.mp3', 'E5': 'E5.mp3', 'A5': 'A5.mp3', 'A6': 'A6.mp3'
                },
                folder: 'flute/'
            },
            'trumpet': { 
                name: 'Trumpet', 
                type: 'sampler',
                samples: {
                    'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3', 'A4': 'A4.mp3',
                    'C5': 'C5.mp3', 'D#5': 'Ds5.mp3', 'F#5': 'Fs5.mp3', 'A5': 'A5.mp3',
                    'C6': 'C6.mp3'
                },
                folder: 'trumpet/'
            },
            'bass': { 
                name: 'Electric Bass', 
                type: 'sampler',
                samples: {
                    'A#1': 'As1.mp3', 'A#2': 'As2.mp3', 'A#3': 'As3.mp3',
                    'C#1': 'Cs1.mp3', 'C#2': 'Cs2.mp3', 'C#3': 'Cs3.mp3',
                    'E1': 'E1.mp3', 'E2': 'E2.mp3', 'E3': 'E3.mp3',
                    'G1': 'G1.mp3', 'G2': 'G2.mp3', 'G3': 'G3.mp3'
                },
                folder: 'bass-electric/'
            },
            'organ': { 
                name: 'Church Organ', 
                type: 'sampler',
                samples: {
                    'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3', 'A3': 'A3.mp3',
                    'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3', 'A4': 'A4.mp3',
                    'C5': 'C5.mp3', 'D#5': 'Ds5.mp3', 'F#5': 'Fs5.mp3', 'A5': 'A5.mp3'
                },
                folder: 'organ/'
            }
        };
        
        let samplerLoaded = false;
        let currentSampler = null;
        
        // Load Tone.js dynamically
        async function loadToneJS() {
            if (window.Tone) {
                toneLoaded = true;
                return;
            }
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js';
                script.onload = () => {
                    console.log('Tone.js loaded');
                    toneLoaded = true;
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Create a sampler with real instrument samples
        async function createSampler(instrumentKey) {
            const preset = instrumentPresets[instrumentKey];
            if (!preset) {
                console.error('Unknown instrument:', instrumentKey);
                return createFallbackSynth();
            }
            
            // Show loading status
            const statusEl = document.getElementById('instrumentLoadingStatus');
            if (statusEl) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading ' + preset.name + ' samples...';
            }
            
            // Dispose old sampler
            if (currentSampler) {
                currentSampler.dispose();
                currentSampler = null;
            }
            if (toneSynth) {
                toneSynth.dispose();
                toneSynth = null;
            }
            
            samplerLoaded = false;
            
            // Build sample URLs
            const sampleUrls = {};
            for (const [note, file] of Object.entries(preset.samples)) {
                sampleUrls[note] = SAMPLE_BASE_URL + preset.folder + file;
            }
            
            return new Promise((resolve, reject) => {
                try {
                    currentSampler = new Tone.Sampler({
                        urls: sampleUrls,
                        release: 1,
                        onload: () => {
                            console.log(preset.name + ' samples loaded');
                            samplerLoaded = true;
                            if (statusEl) statusEl.style.display = 'none';
                            currentSampler.volume.value = Tone.gainToDb(midiVolume);
                            toneSynth = currentSampler; // Use sampler as the synth
                            resolve(currentSampler);
                        },
                        onerror: (err) => {
                            console.error('Failed to load samples:', err);
                            if (statusEl) statusEl.style.display = 'none';
                            // Fallback to synth
                            toneSynth = createFallbackSynth();
                            samplerLoaded = true;
                            resolve(toneSynth);
                        }
                    }).toDestination();
                    
                    // Timeout fallback
                    setTimeout(() => {
                        if (!samplerLoaded) {
                            console.warn('Sample loading timeout, using fallback synth');
                            if (statusEl) statusEl.style.display = 'none';
                            toneSynth = createFallbackSynth();
                            samplerLoaded = true;
                            resolve(toneSynth);
                        }
                    }, 10000);
                    
                } catch (err) {
                    console.error('Sampler creation error:', err);
                    if (statusEl) statusEl.style.display = 'none';
                    toneSynth = createFallbackSynth();
                    samplerLoaded = true;
                    resolve(toneSynth);
                }
            });
        }
        
        // Fallback synth when samples fail to load
        function createFallbackSynth() {
            return new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 0.8 }
            }).toDestination();
        }
        
        // Test sound function
        async function testMidiSound() {
            console.log('Testing MIDI sound...');
            
            try {
                await loadToneJS();
                await Tone.start();
                console.log('Tone.js started, state:', Tone.context.state);
                
                if (!toneSynth || !samplerLoaded) {
                    await createSampler(currentInstrument);
                }
                
                // Play a simple chord
                const now = Tone.now();
                toneSynth.triggerAttackRelease('C4', '8n', now);
                toneSynth.triggerAttackRelease('E4', '8n', now + 0.05);
                toneSynth.triggerAttackRelease('G4', '8n', now + 0.1);
                
                showToast('Test sound played! ', 'success');
            } catch (error) {
                console.error('Test sound error:', error);
                showToast('Audio error: ' + error.message, 'error');
            }
        }
        
        function populateMidiPlayerSelect() {
            const select = document.getElementById('midiPlayerSelect');
            select.innerHTML = '<option value="">Choose a MIDI file from your library...</option>';
            
            midiLibraryFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file.download_url;
                option.textContent = file.filename;
                option.dataset.notes = file.notes || 0;
                option.dataset.duration = file.duration || 0;
                select.appendChild(option);
            });
        }
        
        async function loadMidiForPlayer(url, filename) {
            console.log('loadMidiForPlayer called with:', url, filename);
            
            if (!url) {
                document.getElementById('midiPlayerInterface').style.display = 'none';
                document.getElementById('midiPlayerEmpty').style.display = 'block';
                return;
            }
            
            // Reset state
            midiCurrentTime = 0;
            midiPlaying = false;
            
            currentMidiUrl = url;
            document.getElementById('midiPlayerInterface').style.display = 'block';
            document.getElementById('midiPlayerEmpty').style.display = 'none';
            
            // Update UI
            const name = filename || url.split('/').pop();
            document.getElementById('midiPlayerTitle').textContent = name;
            document.getElementById('midiPlayerInfo').textContent = 'Loading MIDI data...';
            document.getElementById('midiPlayBtn').innerHTML = '<i class="fas fa-play"></i>';
            
            // Update select if called from library
            const select = document.getElementById('midiPlayerSelect');
            if (select) select.value = url;
            
            try {
                // Load Tone.js first
                await loadToneJS();
                
                // Fetch MIDI data from backend
                console.log('Fetching MIDI from:', '/api/midi-parse?url=' + encodeURIComponent(url));
                const response = await fetch('/api/midi-parse?url=' + encodeURIComponent(url));
                const data = await response.json();
                console.log('MIDI parse response:', data);
                
                if (data.success) {
                    midiNotes = data.notes;
                    midiTotalDuration = data.duration;
                    console.log('Loaded', midiNotes.length, 'notes, duration:', midiTotalDuration);
                    
                    // Update info
                    document.getElementById('midiPlayerInfo').textContent = `${data.tracks} track(s)  ${data.notes.length} notes`;
                    document.getElementById('midiPlayerTracks').textContent = data.tracks;
                    document.getElementById('midiPlayerNotes').textContent = data.notes.length;
                    document.getElementById('midiPlayerDuration').textContent = formatTime(data.duration);
                    document.getElementById('midiPlayerTotalTime').textContent = formatTime(data.duration);
                    document.getElementById('midiPlayerCurrentTime').textContent = '0:00';
                    document.getElementById('midiPlayerProgressFill').style.width = '0%';
                    
                    // Create sampler with real instrument samples
                    await createSampler(currentInstrument);
                    
                    showToast('MIDI loaded successfully', 'success');
                } else {
                    throw new Error(data.error || 'Failed to parse MIDI');
                }
            } catch (error) {
                console.error('MIDI load error:', error);
                document.getElementById('midiPlayerInfo').textContent = 'Failed to load MIDI';
                showToast('Error loading MIDI: ' + error.message, 'error');
            }
        }
        
        async function setMidiInstrument(type) {
            currentInstrument = type;
            
            // Update button styles
            document.querySelectorAll('.instrument-btn').forEach(btn => {
                if (btn.dataset.instrument === type) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'var(--bg)';
                    btn.style.color = 'var(--text)';
                    btn.classList.remove('active');
                }
            });
            
            // Update display name
            const preset = instrumentPresets[type];
            if (preset) {
                document.getElementById('midiPlayerInstrument').textContent = preset.name;
                
                // Stop current playback and load new instrument samples
                if (midiPlaying) {
                    pauseMidiPlayer();
                }
                
                if (toneLoaded) {
                    await createSampler(type);
                    showToast(preset.name + ' loaded', 'success');
                }
            }
        }
        
        // Convert MIDI pitch number to note name
        function midiToNoteName(midi) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midi / 12) - 1;
            const note = notes[midi % 12];
            return note + octave;
        }
        
        async function toggleMidiPlayer() {
            console.log('toggleMidiPlayer called, notes:', midiNotes?.length, 'playing:', midiPlaying);
            
            if (!midiNotes || midiNotes.length === 0) {
                showToast('No MIDI loaded', 'error');
                return;
            }
            
            // Start audio context (required for browser autoplay policy)
            await Tone.start();
            console.log('Tone.js state:', Tone.context.state);
            
            if (midiPlaying) {
                pauseMidiPlayer();
            } else {
                playMidiPlayer();
            }
        }
        
        function playMidiPlayer() {
            console.log('playMidiPlayer called');
            console.log('  midiNotes:', midiNotes?.length);
            console.log('  toneSynth:', !!toneSynth);
            console.log('  samplerLoaded:', samplerLoaded);
            console.log('  Tone state:', Tone.context.state);
            
            if (!midiNotes || midiNotes.length === 0) {
                showToast('No MIDI notes loaded', 'warning');
                return;
            }
            
            if (!toneSynth || !samplerLoaded) {
                showToast('Instrument samples still loading...', 'info');
                return;
            }
            
            midiPlaying = true;
            document.getElementById('midiPlayBtn').innerHTML = '<i class="fas fa-pause"></i>';
            document.getElementById('midiPlayerIcon').className = 'fas fa-music fa-beat';
            
            // Clear any previous scheduled events
            Tone.Transport.cancel();
            scheduledEvents = [];
            
            const startOffset = midiCurrentTime;
            console.log('Scheduling', midiNotes.length, 'notes from time', startOffset);
            
            // Schedule all notes
            let notesScheduled = 0;
            midiNotes.forEach(note => {
                const noteTime = (note.start - startOffset) / midiTempo;
                if (noteTime >= 0) {
                    const duration = Math.max(note.duration / midiTempo, 0.05);
                    const noteName = midiToNoteName(note.pitch);
                    const velocity = (note.velocity / 127) * midiVolume;
                    
                    const eventId = Tone.Transport.schedule((time) => {
                        try {
                            toneSynth.triggerAttackRelease(noteName, duration, time, velocity);
                        } catch (e) {
                            // Some synths don't support polyphony well
                        }
                    }, noteTime);
                    
                    scheduledEvents.push(eventId);
                    notesScheduled++;
                }
            });
            
            console.log('Scheduled', notesScheduled, 'notes');
            
            // Start transport
            Tone.Transport.start();
            
            // Update progress
            midiPlaybackInterval = setInterval(() => {
                midiCurrentTime += 0.1 * midiTempo;
                updateMidiProgress();
                
                if (midiCurrentTime >= midiTotalDuration) {
                    stopMidiPlayer();
                }
            }, 100);
        }
        
        function pauseMidiPlayer() {
            midiPlaying = false;
            document.getElementById('midiPlayBtn').innerHTML = '<i class="fas fa-play"></i>';
            document.getElementById('midiPlayerIcon').className = 'fas fa-music';
            
            if (midiPlaybackInterval) {
                clearInterval(midiPlaybackInterval);
            }
            
            // Stop transport
            Tone.Transport.stop();
            Tone.Transport.cancel();
            scheduledEvents = [];
        }
        
        function stopMidiPlayer() {
            pauseMidiPlayer();
            midiCurrentTime = 0;
            updateMidiProgress();
        }
        
        function restartMidiPlayer() {
            stopMidiPlayer();
            playMidiPlayer();
        }
        
        function updateMidiProgress() {
            const progress = (midiCurrentTime / midiTotalDuration) * 100;
            document.getElementById('midiPlayerProgressFill').style.width = Math.min(progress, 100) + '%';
            document.getElementById('midiPlayerCurrentTime').textContent = formatTime(midiCurrentTime);
        }
        
        function seekMidiPlayer(event) {
            const progressBar = document.getElementById('midiPlayerProgress');
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            midiCurrentTime = percent * midiTotalDuration;
            updateMidiProgress();
            
            if (midiPlaying) {
                pauseMidiPlayer();
                playMidiPlayer();
            }
        }
        
        function setMidiVolume(value) {
            midiVolume = value / 100;
            // Update Tone.js synth volume
            if (toneSynth) {
                toneSynth.volume.value = Tone.gainToDb(midiVolume);
            }
        }
        
        function setMidiTempo(value) {
            midiTempo = value / 100;
            document.getElementById('midiTempoValue').textContent = value + '%';
            
            // If playing, restart to apply new tempo
            if (midiPlaying) {
                pauseMidiPlayer();
                playMidiPlayer();
            }
        }

        // ==================== TOAST ====================
        function showToast(message, type) {
            type = type || 'info';
            var toast = document.getElementById('toast');
            var iconClass = type === 'error' ? 'exclamation-circle' : (type === 'success' ? 'check-circle' : 'info-circle');
            
            toast.className = 'toast show ' + type;
            toast.innerHTML = '<i class="fas fa-' + iconClass + '"></i> ' + message;

            setTimeout(function() {
                toast.className = 'toast';
            }, 3000);
        }
        
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('harmonix-theme', newTheme);
            
            // Update toggle icon
            updateThemeIcon(newTheme);
            
            // Notify all iframes about theme change
            syncThemeToIframes(newTheme);
        }
        
        function syncThemeToIframes(theme) {
            // Get all embedded iframes
            const iframes = [
                document.getElementById('accountFrame'),
                document.getElementById('docsFrame'),
                document.getElementById('tutorialsFrame'),
                document.getElementById('tunerFrame'),
                document.getElementById('transposerFrame')
            ];
            
            iframes.forEach(function(iframe) {
                if (iframe && iframe.contentWindow) {
                    try {
                        iframe.contentWindow.postMessage({ type: 'theme-change', theme: theme }, '*');
                    } catch (e) {
                        console.log('Could not sync theme to iframe');
                    }
                }
            });
        }
        
        function updateThemeIcon(theme) {
            const toggleBtn = document.querySelector('.theme-toggle i');
            if (toggleBtn) {
                toggleBtn.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }
        
        // Initialize theme icon on page load
        document.addEventListener('DOMContentLoaded', function() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            updateThemeIcon(currentTheme);
        });
    </script>
    
    <!-- Modular Dashboard JavaScript -->
    <script src="{{ url_for('static', filename='js/dashboard/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/toast.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/navigation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/upload.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/player.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/midi-player.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard/main.js') }}"></script>
</body>
</html>
